%!TEX root = sac15-tr.tex
\begin{figure}
\flyingbox{$d\sim (\Psi;\Theta)$}
\begin{center}
\AXC{} \RightLabel{(D-empty)}
\UIC{$\emptyset \sim (\emptyset;\emptyset)$} 
\DP
\end{center}

\begin{center}

\AXC{
	\stackanchor{
	$d\sim(\Psi;\Theta)$ ~~~~ $s\notin\text{dom}(\Psi)$ ~~~~ $\emptyset\vdash_{\Theta_0\Theta}\tau::\mathtt{Ty}$}{$\emptyset;\emptyset\vdash_{\Theta_0\Theta}^{\Psi}e_{tsm}\rightsquigarrow i_{tsm} \Leftarrow \mathtt{Parser(Exp)}$}
}\RightLabel{(D-syntsm)}
\UIC{$d;\mathbf{syntsm}(s,\tau,e_{tsm})\sim (\Psi,s[\mathbf{syn}(\tau,i_{tsm})];\Theta)$}
\DP
\end{center}

\begin{center}
\AXC{
	$d\sim(\Psi;\Theta)$ ~~~~ $s\notin\text{dom}(\Psi)$ ~~~~ $\emptyset;\emptyset\vdash_{\Theta_0\Theta}^{\Psi}e_{tsm}\rightsquigarrow i_{tsm} \Leftarrow \mathtt{Parser(Exp)}$
}\RightLabel{(D-anatsm)}
\UIC{$d;\mathbf{anatsm}(s,e_{tsm})\sim (\Psi,s[\mathbf{ana}(i_{tsm})];\Theta)$}
\DP
\end{center}

\begin{center}
\AXC{
	\stackanchor
	{$d\sim(\Psi;\Theta)$ ~~~~ $s\notin \text{dom}(\Psi)$}
	{$\emptyset;\emptyset\vdash_{\Theta_0\Theta}e_{tsm}\rightsquigarrow i_{tsm}\Leftarrow \mathtt{Parser}(\mathtt{Type}\times\mathtt{Parser(Exp)})$}
}\RightLabel{(D-tytsm)}
\UIC{$d;\mathbf{tytsm}(s,\kappa,e_{tsm})\sim(\Psi,s[\mathbf{ty}(\kappa,i_{tsm})];\Theta)$}
\DP
\end{center}

%\begin{center}
%\AXC{
%	\stackanchor
%	{$d\sim(\Psi;\Theta)$ ~~~~ $\T\notin\text{dom}(\Theta_0\Theta)$ ~~~~ $\emptyset\vdash_{\Theta_0\Theta}\tau::\kappa\rightarrow\kappa$}
%	{$\emptyset;\emptyset\vdash_{\Theta_0\Theta,\T[\tau(\T)::\kappa,-]}^{\Psi}e_{md}\rightsquigarrow i_{md}\Rightarrow\tau_{md}$}
%}\RightLabel{(D-tydecl)}
%\UIC{$d;\mathbf{typedecl}(\T,\tau,e)\sim (\Psi;\Theta,\T[\tau(\T)::\kappa,i_{md}::\tau_{md}])$}
%\DP
%\end{center}
%
%\begin{center}
%\AXC{
%	\stackanchor{
%		\stackanchor{$d \sim (\Psi;\Theta)$ ~~~~ $\mathtt{T}\notin \text{dom}(\Theta_0\Theta)$ ~~~~ $s[\mathbf{ty}(\kappa,\tau_{md},i_{tsm})]\in\Psi$}
%		{
%			\stackanchor{$\mathsf{parsestream}(body)=i_{ps}$ ~~~~ $i_{tsm}.parse(i_{ps}) \Downarrow OK((i_{type},i_{md}))$}{
%				$i_{type}\uparrow\hat\tau$ ~~~~ $\Delta;\emptyset\vdash_{\Theta\Theta'}\hat\tau\rightsquigarrow\tau::\kappa \rightarrow \kappa$
%			}
%		}
%	}
%	{$\emptyset;\emptyset\vdash_{\Theta_0\Theta,\mathtt{T}[\tau(\mathtt{T}) :: \kappa,-]}^{\Psi}e_{mdx}\rightsquigarrow i_{mdx} \Rightarrow \tau_{md}\rightarrow\tau'_{md}$ ~~~~ $i_{mdx}(i_{md})\Downarrow i'_{md}$}
%}
%\RightLabel{(D-aptsm)}
%\UIC{$d;\mathbf{tyaptsm}(\mathtt{T},s,body,e_{mdx}) \sim (\Psi; \Theta,\mathtt{T}[\tau(\mathtt{T}) :: \kappa,i'_{md}:\tau'_{md}])$}
%\DP
%\end{center}

\begin{center}
\AXC{
	\stackanchor{
	\stackanchor{$d\sim(\Psi;\Theta)$ ~~~~ $\neg\exists~u,v\in\{1,...,n\}.(u\neq v\land\T_u=\T_v)$ ~~~~ $\forall~k.(\T_k\notin\text{dom}(\Theta))$}
	{$\forall~k\in\{1,...,n\}.(\vdash_{\Theta_0\Theta}^{\Psi}\theta_k\leadsto \mathring\theta_k\land \mathsf{name}(\mathring\theta_k)=\T_k \land \emptyset\vdash\mathsf{type}(\mathring\theta_k)::\kappa_1\rightarrow...\rightarrow\kappa_n\rightarrow\kappa_k)$}}
	{$\forall~k.(\vdash_{\Theta_0\Theta,\T_1[\tau_1(\T_1,...,\T_n)::\kappa_1,-],...,\T_n[\tau_n(\T_1,...,\T_n)::\kappa_n,-]}\mathring\theta_k\leadsto \T_k[\tau_k::\kappa_k,i_k])$}
	}\RightLabel{(D-rec)}
\UIC{$d;\mathbf{mrectydecl}(\theta_1,...,\theta_n)\sim(\Psi;\Theta,\T_1[\tau_1::\kappa_1,i_1],...,\T_n[\tau_n::\kappa_n,i_n])$}
\DP
\end{center}

\flyingbox{$\vdash_{\Theta}^{\Psi}\theta\leadsto\mathring\theta$}
\begin{center}
\AXC{
	{$\emptyset\vdash_{\Theta_0\Theta}\tau::\kappa$}
}\RightLabel{(D-tydecl-1)}
\UIC{$\vdash_{\Theta}^{\Psi}\mathbf{typedecl}(\T,\tau,e)\leadsto \T[\tau::\kappa,e]$}
\DP
\end{center}

\begin{center}
\AXC{
		\stackanchor{$s[\mathbf{ty}(\kappa,i_{tsm})]\in\Psi$ ~~~~ $\mathsf{parsestream}(body)=i_{ps}$}
		{
			{$i_{tsm}.parse(i_{ps}) \Downarrow OK((i_{type},i_{syn}))$ ~~~~	$i_{type}\uparrow\hat\tau$ ~~~~ $\Delta;\emptyset\vdash_{\Theta\Theta'}\hat\tau\rightsquigarrow\tau::\kappa$
			}
		}
}\RightLabel{(D-aptsm-1)}
\UIC{$\vdash_{\Theta}^{\Psi}\mathbf{tyaptsm}(\mathtt{T},s,body,e_{synx}) \leadsto \mathtt{T}[\tau::\kappa,e_{synx},i_{syn}]$}
\DP
\end{center}

\flyingbox{$\vdash^{\Psi}_{\Theta}\mathring\theta\leadsto\T[\tau::\kappa,i]$}
\begin{center}
\AXC{
	$\emptyset;\emptyset\vdash_{\Theta}^{\Psi}e_{syn}\rightsquigarrow i_{syn}\Leftarrow\mathtt{Parser(Exp)}$
}\RightLabel{(D-tydecl-2)}
\UIC{$\vdash_{\Theta}^{\Psi}\T[\tau::\kappa,e_{syn}]\leadsto\T[\tau::\kappa,i_{syn}]$}
\DP
\end{center}

\begin{center}
\AXC{
	{$\emptyset;\emptyset\vdash_{\Theta}^{\Psi}e_{synx}\rightsquigarrow i_{syn} \Leftarrow \mathtt{Parser(Exp)}$}
}\RightLabel{(D-aptsm-2)}
\UIC{$\vdash_{\Theta}^{\Psi}\T[\tau::\kappa,e_{synx},i_{syn}] \leadsto\mathtt{T}[\tau::\kappa,i_{synx}]$}
\DP
\end{center}

\begin{center}
\AXC{
	{$\emptyset;\emptyset\vdash_{\Theta}^{\Psi}e_{synx}\rightsquigarrow \circ$}
}\RightLabel{(D-aptsm-2')}
\UIC{$\vdash_{\Theta}^{\Psi}\T[\tau::\kappa,e_{synx},i_{syn}] \leadsto\mathtt{T}[\tau::\kappa,i_{syn}]$}
\DP
\end{center}

\caption{Declaration checking and elaboration of type-level TSMs.}
\label{typechecking-elaboration}
\end{figure}


