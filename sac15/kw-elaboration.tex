%!TEX root = sac15.tex
\begin{figure*}[ht]
\flyingbox{$d\sim (\Psi;\Theta)$}
\vspace{-15px}\begin{center}
\AXC{}\RightLabel{(D-empty)}
\UIC{$\emptyset \sim (\emptyset;\emptyset)$}
\DP
\end{center}

\begin{center}
\AXC{
	%\stackanchor
	$d\sim(\Psi;\Theta)$ ~~~~ $s \notin \text{dom}(\Psi)$ ~~~~ $\emptyset\vdash_{\Theta_0\Theta} \tau::\star$ ~~~~ $\emptyset;\emptyset\vdash_{\Theta_0\Theta}^{\Psi} e_{tsm}\rightsquigarrow i_{tsm}\Leftarrow \mathtt{Parser}(\mathtt{Exp})$
}\RightLabel{(D-syntsm)}
\UIC{$ d;\mathbf{syntsm}(s,\tau,e_{tsm})\sim (\Psi,s[\mathbf{syn}(\tau,i_{tsm})];\Theta)$}
\DP
\end{center}

\begin{center}
%\AXC{$\Theta_0\subset \Theta$ ~~~~ $\myvdash  d'\rightsquigarrow\Theta'$ ~~~~ $k\notin dom(\Theta\Theta')$ ~~~~ $\emptyset\vdash_{\Theta\Theta'} e_{k}\rightsquigarrow i_{k}\Leftarrow \mathbf{named}[ExpKw]$}								\RightLabel{(expkw-wk)}
\AXC{
	{$d\sim(\Psi;\Theta)$ ~~~~ $s \notin \text{dom}(\Psi)$ ~~~~ $\emptyset;\emptyset\vdash_{\Theta_0\Theta}^{\Psi} e_{tsm}\rightsquigarrow i_{tsm}\Leftarrow \mathtt{Parser}(\mathtt{Exp})$}
}\RightLabel{(D-anatsm)}
\UIC{$ d;\mathbf{anatsm}(s, e_{tsm})\sim (\Psi, s[\mathbf{ana}(i_{tsm})];\Theta)$}
\DP
\end{center}

\begin{center}
\AXC{$d\sim(\Psi;\Theta)$ ~~~~ $s \notin \text{dom}(\Psi)$ ~~~~  $\emptyset\vdash_{\Theta_0\Theta}\tau_{md}::
\star$ ~~~~ $\emptyset; \emptyset \vdash_{\Theta_0\Theta}^{\Psi}e_{tsm}\rightsquigarrow i_{tsm}\Leftarrow \mathtt{Parser}(\mathtt{Type} \times \tau_{md})$}
\RightLabel{(D-tytsm)}
\UIC{$d;\mathbf{tytsm}(s,\kappa,\tau_{md}, e_{tsm}) \sim (\Psi,s[\mathbf{ty}(\kappa, \tau_{md}, i_{tsm})]; \Theta)$}
\DP
\end{center}

\begin{center}
\AXC
{
	$d \sim (\Psi;\Theta)$ ~~~~ $\mathtt{T}\notin \text{dom}(\Theta_0\Theta)$ ~~~~ $\emptyset\vdash_{\Theta_0\Theta}\tau::\kappa \rightarrow \kappa$ ~~~~ $\emptyset;\emptyset\vdash_{\Theta_0\Theta,\mathtt{T}[\tau(\mathtt{T}) :: \kappa,-]}^{\Psi}e_{md}\rightsquigarrow i_{md}\Rightarrow\tau_{md}$
}\RightLabel{(D-tydecl)}
\UIC{$d;\mathbf{tydecl}(\mathtt{T},\tau,e) \sim (\Psi; \Theta,\mathtt{T}[\tau(\mathtt{T}) :: \kappa,i_{md}:\tau_{md}])$}
\DP
\end{center}

\begin{center}
\AXC{
	\stackanchor{
		\stackanchor{$d \sim (\Psi;\Theta)$ ~~~~ $\mathtt{T}\notin \text{dom}(\Theta_0\Theta)$ ~~~~ $s[\mathbf{ty}(\kappa,\tau_{md},i_{tsm})]\in\Psi$}
		{$\mathsf{parsestream}(body)=i_{ps}$ ~~~~ $i_{tsm}.parse(i_{ps}) \Downarrow OK((i_{type},i_{md}))$ ~~~~ $i_{type}\uparrow\hat\tau$ ~~~~ $\emptyset;\emptyset\vdash_{\Theta\Theta'}\hat\tau\rightsquigarrow\tau::\kappa \rightarrow \kappa$}
	}
	{$\emptyset;\emptyset\vdash_{\Theta_0\Theta,\mathtt{T}[\tau(\mathtt{T}) :: \kappa,-]}^{\Psi}e_{mdx}\rightsquigarrow i_{mdx} \Rightarrow \tau_{md}\rightarrow\tau'_{md}$ ~~~~ $i_{mdx}(i_{md})\Downarrow i'_{md}$}
}
\RightLabel{(D-aptsm)}
\UIC{$d;\mathbf{tyaptsm}(\mathtt{T},s,body,e_{mdx}) \sim (\Psi; \Theta,\mathtt{T}[\tau(\mathtt{T}) :: \kappa,i'_{md}:\tau'_{md}])$}
\DP
\end{center}
\caption{Declaration checking and elaboration of type-level TSMs.}
\label{typechecking-elaboration}
\end{figure*}


