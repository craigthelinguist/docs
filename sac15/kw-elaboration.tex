\begin{figure*}[ht]
\flyingbox{$\rho \sim \Delta_{\kappa}\sim \Theta\rightsquigarrow i:\tau$}
\vspace{-25px}
\begin{center}
\AXC{$\vdash_{\Theta_{0}}\kappa_{\delta} \sim \Delta_\kappa$ ~~~~ $\vdash_{\Theta_{0}}^{\Delta_\kappa}\theta\sim\Theta$ ~~~~ $\emptyset\vdash_{\Theta_0\Theta}^{\Delta\kappa}e\rightsquigarrow i\Rightarrow \tau$}      \RightLabel{(compile)}
\UIC{$\kappa_{\delta};\theta;e\sim\Delta_{\kappa}\sim\Theta\rightsquigarrow i:\tau$}
\DP
\end{center}

\flyingbox{$\vdash_{\Theta}\kappa_{\delta}\sim\Delta_{\kappa}$}
\vspace{-25px}
\begin{center}
\AXC{}
\UIC{$\vdash_{\Theta} \emptyset\sim\emptyset$}
\AXC{$\Theta_0 \subset\Theta$ ~~~~ $\kappa_{\delta}\sim\Delta_{\kappa}$ ~~~~ $k\notin dom(\Delta_{\kappa})$ ~~~~ $\vdash_{\Theta}e\rightsquigarrow i\Leftarrow TypeKw$ ~~~~ $\vdash_{\Theta}\tau$}
\RightLabel{~~~ (kw-env)}
\UIC{$\vdash_{\Theta} \kappa_\delta;k[e, \tau] \sim \Delta_{\kappa};k[i, \tau]$}
\noLine
\BIC{}
\DP
\end{center}

\flyingbox{${\myvdash}\theta\sim \Theta$}
\vspace{-25px}
\begin{center}
\AXC{$\vdash_{\Theta_{0}}\theta \sim_{names}\Theta_{names} ~~~~~ \vdash_{\Theta_{0}\Theta_{names}}^{\Delta_\kappa}\theta \sim_{defs}\Theta_{defs} ~~~~~ \vdash^{\Delta_\kappa}_{\Theta_{0}\Theta_{defs}}\theta \sim_{exts}\Theta $} \RightLabel{~~~ (rec-decls)}
\UIC{$\vdash_{\Theta_{0}}^{\Delta_\kappa} \theta \sim \Theta$} 
\DP
\end{center}

\flyingbox{$\vdash_{\Theta}\theta\sim_{names} \Theta$}
\vspace{-25px}
\begin{center}
\AXC{} \RightLabel{~~~ (empty-names)}
\UIC{${\vdash_{\Theta}} \emptyset \sim_{names} \emptyset$}
\DP
\end{center}
\begin{center}
\AXC{${\vdash_{\Theta}}\theta' \sim_{names} \Theta' ~~~~~~ T\notin {dom}(\Theta) ~~~~~~ T\notin dom(\Theta')$} \RightLabel{~~~ (type-names)}
\UIC{${\vdash_{\Theta}} \theta';T[\tau,e_m,\kappa] \sim_{names} \Theta',T[?,?,?]$}
\DP
\end{center}
\begin{center}
\AXC{${\vdash_{\Theta}}\theta' \sim_{names} \Theta' ~~~~~~ T\notin {dom}(\Theta) ~~~~~~ T\notin dom(\Theta')$} \RightLabel{~~~ (type-names-2)}
\UIC{${\vdash_{\Theta}} \theta';T[k,body,e_m,\kappa] \sim_{names} \Theta',T[?,?,?]$}
\DP
\end{center}

\flyingbox{${\myvdash}\theta\sim_{defs} \Theta$}
\vspace{-25px}
\begin{center}
\AXC{} \RightLabel{~~~ (empty-defs)}
\UIC{${\myvdash} \emptyset \sim_{defs} \emptyset$}
%%% the next rule
\AXC{${\myvdash}\theta' \sim_{defs} \Theta'$ ~~~~ ${\vdash_{\Theta}}\tau$}\RightLabel{~~~ (type-defs)}
\UIC{${\myvdash}\theta';T[\tau,e_m,\kappa] \sim_{defs} \Theta',T[\tau,?,?]$}
\noLine
\BIC{}
\DP
\end{center}
\begin{center}
\AXC{$\Theta_0\subset\Theta$ ~~~~ $k[i, \tau_m]\in\Delta_\kappa$ ~~~~ $\texttt{parsestream}(body)=i_{ps}$}
\noLine
\UIC{$\mathbf{iap}(\mathbf{iprj}[parse](\mathbf{iprj}[parser](i_{k}));i_{ps})\Downarrow(i_{type},i_{exp})$}
\noLine
\UIC{$i_{type}\uparrow \tau$ ~~~~ $\myvdash \tau$ ~~~~ $i_{exp}\uparrow \hat{e}$ ~~~~ $\emptyset;\emptyset\myvdash \hat{e}\rightsquigarrow i_m\Leftarrow \tau_m$ ~~~~ $\myvdash\Theta'\sim_{defs}\Theta'$}\RightLabel{~~~ (type-defs-2)}
\UIC{${\vdash_{\Theta}} \theta';T[k,body,e_m,\kappa] \sim_{defs} \Theta',T[\tau,i_m:\tau_m,?]$}
\DP
\end{center}

\flyingbox{${\myvdash}\theta\sim_{exts} \Theta$}
\vspace{-25px}
\begin{center}
\AXC{} \RightLabel{~~~ (empty-exts)}
\UIC{${\myvdash} \emptyset \sim_{exts} \emptyset$}
\DP
\end{center}

\begin{center}
\AXC{$\vdash^{\Delta_\kappa}_{\Theta_1,T[\tau,?,?],\Theta_2}\theta'\sim_{exts}\Theta' $ ~~~~~ $\emptyset\vdash^{\Delta_\kappa}_{\Theta_1,T[\tau,?,?],\Theta_2}e_m\rightsquigarrow i_m\Rightarrow \tau_m$ ~~~~~ $\emptyset\vdash^{\Delta_\kappa}_{\Theta_1,T[\tau,?,?],\Theta_2}\kappa \rightsquigarrow \dot\kappa$}                 \RightLabel{~~~ (type-exts)}
\UIC{$\vdash^{\Delta_\kappa}_{\Theta_1,T[\tau,?,?],\Theta_2}\theta';T[\tau,e_m,\kappa] \sim_{exts} \Theta',T[\tau,i_m:\tau_m,\dot\kappa]$}
\DP
\end{center}

\begin{center}
\AXC{$\vdash^{\Delta_\kappa}_{\Theta_{1},T[\tau,i_{m}:\tau_{m},?],\Theta_2}\theta'\sim_{exts}\Theta' $ ~~~~~ $\emptyset\vdash^{\Delta_\kappa}_{\Theta_1,T[\tau,i_{m}:\tau_m,?],\Theta_2}\kappa \rightsquigarrow \dot\kappa$}              
\noLine
\UIC{$\myvdash e_w\Rightarrow i_w:\mathbf{arrow}(\tau_m,\tau'_m)$ ~~~~ $\myvdash \mathbf{iap}(i_w; i_m) \Downarrow i'_m$ ~~~~ $\myvdash i'_m\Leftarrow \dot
\tau'_m$}\RightLabel{~~~ (type-exts-2)}
\UIC{$\vdash_{\Theta_1,T[\tau,i_{m}:\tau_m,?],\Theta_2}\theta';T[k,body,e_w,\kappa] \sim_{exts} \Theta',T[\tau,i'_m:\tau'_m,\dot\kappa]$}
\DP
\end{center}

\flyingbox{$\myvdash \kappa\rightsquigarrow \dot\kappa$}
\vspace{-25px}
\begin{center}
\AXC{$\Theta_0\subset \Theta$ ~~~~ $\myvdash \kappa\rightsquigarrow\dot\kappa$ ~~~~ $k\notin dom(\dot\kappa)$ ~~~~ $\vdash_{\Theta} \tau$ ~~~~ $\myvdash e_{k}\rightsquigarrow i_{k}\Leftarrow ExprKw$}	\RightLabel{(expkw-bk)}
\UIC{$\myvdash\kappa;k[\mathbf{bk}(\tau),e_k]\rightsquigarrow \dot\kappa;k[\mathbf{bk}(\tau),i_k]$}
\DP
\end{center}
\begin{center}
\AXC{$\Theta_0\subset \Theta$ ~~~~ $\myvdash \kappa\rightsquigarrow\dot\kappa$ ~~~~ $k\notin dom(\dot\kappa)$ ~~~~ $\myvdash e_{k}\rightsquigarrow i_{k}\Leftarrow ExprKw$}								\RightLabel{(expkw-wk)}
\UIC{$\myvdash\kappa;k[\mathbf{wk},e_k]\rightsquigarrow \dot\kappa;k[\mathbf{wk},i_k]$}
\DP
\end{center}
\label{typechecking-elaboration}
\caption{Typechecking and elaboration of programs}
\end{figure*}
