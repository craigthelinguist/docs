\documentclass{llncs}

\usepackage{listings}
\usepackage{amssymb}
\usepackage[margin=.9in]{geometry}
\usepackage{amsmath}
%\usepackage{amsthm}
\usepackage{mathpartir}
\usepackage{color,soul}
\usepackage{graphicx}
\usepackage[framemethod=tikz]{mdframed}

%\theoremstyle{definition}
%%\newtheorem{case1}{Case1}
\spnewtheorem{casethm}{Case}[theorem]{\itshape}{\rmfamily}
\spnewtheorem{subcase}{Subcase}{\itshape}{\rmfamily}
\spnewtheorem{subsubcase}{Subsubcase}{\itshape}{\rmfamily}
\numberwithin{subsubcase}{subcase}
\numberwithin{subcase}{casethm}
\numberwithin{casethm}{theorem}
\numberwithin{casethm}{lemma}




\lstdefinestyle{custom_lang}{
  xleftmargin=\parindent,
  showstringspaces=false,
  basicstyle=\ttfamily,
  keywordstyle=\bfseries
}

\lstset{emph={%  
    val, def, type, new, z%
    },emphstyle={\bfseries \tt}%
}

\begin{document}
\hl{*Note highlighted text implies more work is needed.}
\section{Type Safety}

\subsection{Subtype Transitivity and Environment Narrowing}

%---------------------- Narrowing ----------------------%



We define the following \emph{Subtype Transitivity} 
judgement 
\begin{mathpar}
\inferrule
  {}
  {\Gamma \vdash S \; <:^* \; S}
  \quad (\textsc {S\textsuperscript{*}-Refl})
	\and
\inferrule
  {\Gamma \vdash S \; <:^* \; T \\
	\Gamma \vdash T \; <: \; U}
  {\Gamma \vdash S \; <:^* \; U}
  \quad (\textsc {S\textsuperscript{*}-Trans})
\end{mathpar}
\emph{Environment Narrowing} can now be rewritten as 
\begin{mathpar}
\inferrule
  {\Gamma, (x : U); \Sigma \vdash T <: T' \\
  	\Gamma; \Sigma \vdash S <: U}
  {\Gamma, (x : S); \Sigma \vdash T <:^* T'}
\end{mathpar}
We also define 
$\Gamma; \Sigma \vdash \overline{\sigma} <:^* \overline{\sigma}'$
as $\forall \sigma_i' \in \overline{\sigma}', \exists 
\sigma_i \in \overline{\sigma}: 
\Gamma; \Sigma \vdash \sigma_i <:^* \sigma_i'$.

\newpage

\begin{lemma}[Transitive Subtyping] \label{lem:transitivity}
If 	$A; \Sigma; \Gamma \vdash S <: T, T <: U$ where
	$A; \Sigma; \Gamma \vdash T \texttt{wfe}$ then 
	we can construct a chain of record types 
	$\{z \Rightarrow \overline{\sigma}_1\}, ..., \{z \Rightarrow \overline{\sigma}_i\}$
	such that $\forall j, 2 < j \leq i, \; 
	A; \Sigma; \Gamma \vdash \{z \Rightarrow \overline{\sigma}_{j-1}\} <: \{z \Rightarrow \overline{\sigma}_{j}\}$
	and
	$A; \Sigma; \Gamma \vdash S <: \{z \Rightarrow \overline{\sigma}_1\}, ..., \{z \Rightarrow \overline{\sigma}_i\} <:U$.
\end{lemma}
\begin{proof}
By structural induction on $T$.

\begin{casethm}[T = $\{z \Rightarrow \overline{\sigma}\}$]
Trivial.
\end{casethm}

\begin{casethm}[T = $p.L$]
Since $p.L$ is well-formed and expanding, we know that 
$A; \Sigma; \Gamma \vdash p \ni \texttt{type} L : S_1 .. U_1$ 
where $A; \Sigma; \Gamma \vdash S_1 <: U_1$ and $U_1$ is 
well-formed and expanding too while $S_1$ is either $\bot$ 
or is also well-formed and expanding. Now if we look at the 
structure of $S$, it can either be a selection $L$ on a path $p_2$ 
that is path equivalent to $p$, or not. If not, we know that 
$S$ subtypes the lower bound $S_1$.
\begin{subcase}[$S_2 = p_2.L$ and $p_2 \equiv p$] \label{thm:sc:equiv_paths}
By inversion on the derivation of $A; \Sigma; \Gamma \vdash p_2.L <: p.L$ 
we have $A; \Sigma; \Gamma \vdash p_2 \ni \texttt{type} L : S_2 .. U_2$ where 
$A, (p_2 <: p_1); \Sigma; \Gamma \vdash U_2 <: U_1$. 
We can now apply our induction hypothesis on the smaller type $U_1$ 
to get a type sequence 
$\{z \Rightarrow \overline{\sigma}_1\}, ..., \{z \Rightarrow \overline{\sigma}_i\}$ 
such that for each adjacent pair the type on the left subtypes  the type on the 
right, and since $A, (p_2 <: p_1); \Sigma; \Gamma \vdash U_2 <: U_1$ and
$A, \Sigma; \Gamma \vdash U_1 <: U$ it follows that 
$A, (p_2 <: p_1); \Sigma; \Gamma \vdash U_2 <: \{z \Rightarrow \overline{\sigma}_1\}$ and
$A, \Sigma; \Gamma \vdash \{z \Rightarrow \overline{\sigma}_i\} <: U$, giving us
our desired result.
\end{subcase}
\begin{subcase}[$S$ subtypes $S_1$]
We know that either $S_1$ is bottom or is well-formed 
and expanding. If $S_1$ is $\bot$, this must force $S$ 
to be $\bot$ too. In this case our stype sequence has a 
length of 0, and our result follows immediately from 
\textsc{S-Bottom}. If however $S_1$ is well-formed and 
expanding, we can use the same approach as in subcase 
\ref{thm:sc:equiv_paths}, except we also expand the lower 
bound $S_1$ to some sequence 
$\{z \Rightarrow \overline{\sigma}_1\}, ..., \{z \Rightarrow \overline{\sigma}_i\}$. The combination of the two sequences gives us the final sequence using the same reasoning.
\end{subcase}
\end{casethm}

\begin{casethm}[T = $\top$]
If $T$ is $\top$, it must force $U$ to be $\top$ too. In this case the sequence has length 0, and the result is obtained immediately from \textsc{S-Top}.
\end{casethm}

\begin{casethm}[T = $\bot$]
If $T$ is $\bot$, it must force $S$ to be $\bot$ too. In this case the sequence has length 0, and the result is obtained immediately from \textsc{S-Bottom}.
\end{casethm}

\end{proof}
\qed

\newpage



\begin{lemma}[Expression Substitution]\label{lem:subst}
\begin{mathpar}
\inferrule
  {A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash e : T \\
  	x \notin \, \Gamma_1\\
  	A; \Sigma; \Gamma_1 \vdash p : S \\
  	A; \Sigma; \Gamma_1 \vdash S <: U}
  {[p \unlhd U/x]A; \Sigma; , \Gamma_1, [p \unlhd U/x]\Gamma_2 \vdash [p \unlhd U/x]e : [p \unlhd U/x]T}
  \quad (\textsc {$:$ - Substitution})
%  \and
%\inferrule
%  {A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash T <: T' \dashv\Gamma_1, (x : U), \Gamma_2' \\
%  	x \notin \, \Gamma_1\\\\
%  	A; \Sigma; \Gamma_1 \vdash p : S \\
%  	A; \Sigma; \Gamma_1 \vdash S <: U \dashv \Gamma_1}
%  {[p \unlhd U/x]A; \Sigma; , \Gamma_1, [p \unlhd U/x]\Gamma_2 \vdash [p \unlhd U/x]T <: [p \unlhd U/x]T' \dashv \Gamma_1, [p \unlhd U/x]\Gamma_2'}
%  \quad (\textsc {$<:$ - Substitution})
%  \and
%\inferrule
%  {A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash e \ni \sigma \\
%  	x \notin \, \Gamma_1\\
%  	A; \Sigma; \Gamma_1 \vdash p : S \\
%  	A; \Sigma; \Gamma_1 \vdash S <: U \dashv \Gamma_1}
%  {[p \unlhd U/x]A; \Sigma; , \Gamma_1, [p \unlhd U/x]\Gamma_2 \vdash [p \unlhd U/x]e \ni [p \unlhd U/x]\sigma}
%  \quad (\textsc {$\ni$ - Substitution})
%  \and
%\inferrule
%  {A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash T \prec_z \overline{\sigma} \\
%  	x \notin \, \Gamma_1\\
%  	A; \Sigma; \Gamma_1 \vdash p : S \\
%  	A; \Sigma; \Gamma_1 \vdash S <: U \dashv \Gamma_1}
%  {[p \unlhd U/x]A; \Sigma; , \Gamma_1, [p \unlhd U/x]\Gamma_2 \vdash [p \unlhd U/x]T \prec_z [p \unlhd U/x]\overline{\sigma}}
%  \quad (\textsc {$\prec$ - Substitution})
\end{mathpar}
\end{lemma}
\begin{proof}
By structural induction on 
$A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash e : T$.
\begin{casethm}[\textsc{T-Var}]
\begin{mathpar}
\inferrule
  {e = y \\
  	T = \Gamma(y)}
  {}
  \and
\inferrule
  {y \in dom(\Gamma_1, (x : U), \Gamma_2)}
  {	A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash y : \Gamma_1, (x : U), \Gamma_2(y)}
\end{mathpar}
Case analysis on $x = y$.
\begin{subcase}[$x = y$]
\begin{mathpar}
\inferrule
  {[p\unlhd U/x]y = p\unlhd U \\
  	[p\unlhd U/x]U = U}
  {}
\end{mathpar}
The substitutions are given above. 
Since $U$ is typed absent 
$x$, $[p\unlhd U/x]U = U$.
By assumption we have $A; \Sigma; \Gamma_1 \vdash p : S$ 
and $A; \Sigma; \Gamma_1 \vdash S <: U \dashv \Gamma_1$.
\hl{Weakening} gives us 
\begin{mathpar}
\inferrule
  {A; \Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash p : S \\
  	A; \Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash S <: U \dashv \Gamma_1, [p\unlhd U/x]\Gamma_2}
  {}
\end{mathpar}
Thus by \textsc{T-Type}, 
$\varnothing; \Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash p \unlhd U : U$.
\end{subcase}
\begin{subcase}[$x \neq y$]
\begin{mathpar}
\inferrule
  {[p\unlhd U/x]y = y}
  {}
\end{mathpar}
The substitutions are given above.Thus by \textsc{T-Var},
$A; \Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash y : \Gamma_1, [p\unlhd U/x]\Gamma_2(y)$.
\end{subcase}
\end{casethm}

\begin{casethm}[\textsc{T-Loc}]
\begin{mathpar}
\inferrule
  {	l \in dom(\Sigma)}
  {	A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash l : \Sigma(l)}
\end{mathpar}
Trivial.
\end{casethm}

\begin{casethm}[\textsc{T-New}]
\begin{mathpar}
\inferrule
  {A; \Sigma; \Gamma_1, (x : U), \Gamma_2, z : \{z \Rightarrow \overline{\sigma}\} 
  \vdash \overline{d} : \overline{\sigma}}
  {A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash \texttt{new} \; \{z \Rightarrow \overline{d}\} : 
  \{z \Rightarrow \overline{\sigma}\}}
\end{mathpar}
\end{casethm}

\begin{casethm}[\textsc{T-Meth}]
\begin{mathpar}
\inferrule
  {A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash e_0 \ni \texttt{def} \; m:S \rightarrow T \\
  	A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash e_0 : T_0 \\
  	A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash e_1 : S' \\
  	A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash S' <: S \\
  	A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash T <: U}
  {A; 	\Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash e_0.m_U(e_1) : U}
\end{mathpar}
\end{casethm}

\begin{casethm}[\textsc{T-Acc}]
\begin{mathpar}
\inferrule
  {	A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash e : S \\
  	A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash e \ni \texttt{val} \; f:T}
  {	A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash e.f : T}
\end{mathpar}
\end{casethm}

\begin{casethm}[\textsc{T-Type}]
\begin{mathpar}
\inferrule
  {A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash e : S \\
   A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash S <: T}
  {A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash e \unlhd T : T}
\end{mathpar}
\end{casethm}

\begin{casethm}[\textsc{S-Assume}]
\begin{mathpar}
\inferrule
  {(S <: T) \in A}
  {A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash S\; \texttt{<:}\; T}
\end{mathpar}
Trivial.
\end{casethm}

\begin{casethm}[\textsc{S-Rec}]
\begin{mathpar}
\inferrule
	{A; \Sigma; \Gamma_1, (x : U), \Gamma_2, z : \{z \Rightarrow \overline{\sigma}_1\} \vdash \overline{\sigma}_1 <:\; [z \unlhd \{z \Rightarrow \overline{\sigma}_2\} / z]\overline{\sigma}_2}
	{A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash \{z \Rightarrow \overline{\sigma}_1\}\; <:\; \{z \Rightarrow \overline{\sigma}_2\}}
\end{mathpar}
Trivial.
\end{casethm}

\begin{casethm}[\textsc{S-Path}]
\begin{mathpar}
\inferrule
	{p_1 \equiv p_2 \\
	 A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash p_1 \ni \texttt{type} \; L : S_1 .. U_1 \\
	 A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash p_2 \ni \texttt{type} \; L : S_2 .. U_2 \\
	 A, (p_1.L <: p_2.L); \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash S_2 <:\; S_1 \\
	 A, (p_1.L <: p_2.L); \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash U_1\; <:\; U_2}
	{A; \Sigma; \Gamma \vdash p_1.L\; <:\; p_2.L}
\end{mathpar}
Trivial.
\end{casethm}

\begin{casethm}[\textsc{S-Select-Upper}]
\begin{mathpar}
\inferrule
	{A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash p \ni \texttt{type} \; L : S .. U\\
	 A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash S <: U \\
	 A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash U <: T}
	{A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash p.L\; <:\; T}
\end{mathpar}
Trivial.
\end{casethm}

\begin{casethm}[\textsc{S-Select-Lower}]
\begin{mathpar}
\inferrule
	{A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash p \ni \texttt{type} \; L : S .. U \\
	 A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash S <: U \\
	 A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash T <: S}
	{A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash T \; <:\; p.L}
\end{mathpar}
Trivial.
\end{casethm}

\begin{casethm}[\textsc{S-Top}]
\begin{mathpar}
\inferrule
	{}
	{A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash T\; \texttt{<:}\; \top}
\end{mathpar}
Trivial.
\end{casethm}

\begin{casethm}[\textsc{S-Bottom}]
\begin{mathpar}
\inferrule
	{}
	{A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash \bot\; \texttt{<:}\; T}
\end{mathpar}
Trivial.
\end{casethm}

\end{proof}
\qed

\newpage

To avoid confusion with common notation for union types, the propositional ``or'' is given as $\bigvee$, not $\vee$.
\begin{lemma}[Bound Subtyping] \label{lem:bound_subtype}
\begin{mathpar}
\inferrule
	{\varnothing; \Sigma; \Gamma \vdash T <: p.L \\
	 \varnothing; \Sigma; \Gamma \vdash p \ni \texttt{type} \; L : S .. U}
	{\varnothing; \Sigma; \Gamma \vdash T <: S \bigvee \varnothing; \Sigma; \Gamma \vdash T <: U}
\end{mathpar}
\end{lemma}

\begin{proof}
By induction on the derivation of $\varnothing; \Sigma; \Gamma \vdash T <: p.L$.
\subsubsection{$<:$ Preservation}
\begin{casethm}[\textsc{S-Path}]
\begin{mathpar}
\inferrule
	{p_1 \equiv p_2 \\
	 \varnothing; \Sigma; \Gamma \vdash p_1 \ni \texttt{type} \; L : S_1 .. U_1 \\
	 \varnothing; \Sigma; \Gamma \vdash p \ni \texttt{type} \; L : S .. U \\
	 \varnothing, (p_1.L <: p_2.L); \Sigma; \Gamma \vdash S <:\; S_1 \\
	 \varnothing, (p_1.L <: p_2.L); \Sigma; \Gamma \vdash U_1\; <:\; U}
	{\varnothing; \Sigma; \Gamma \vdash p_1.L\; <:\; p.L}
\end{mathpar}
By inversion on the well-formedness of $p_1.L$ we know $\varnothing; \Sigma; \Gamma \vdash S_1\; <:\; U_1$. Since we know that $\varnothing, (p_1.L <: p_2.L); \Sigma; \Gamma \vdash U_1\; <:\; U_2$, it follows that we can derive a proof for $\varnothing; \Sigma; \Gamma \vdash U_1\; <:\; U_2$. Thus, by \textsc{S-Select-Upper} we get $\varnothing; \Sigma; \Gamma \vdash p_1.L\; <:\; U$.
\end{casethm}

\begin{casethm}[\textsc{S-Select-Upper}]
\begin{mathpar}
\inferrule
	{\varnothing; \Sigma; \Gamma \vdash p_1 \ni \texttt{type} \; L_1 : S_1 .. U_1\\
	 \varnothing; \Sigma; \Gamma \vdash S_1 <: U_1 \\
	 \varnothing; \Sigma; \Gamma \vdash U_1 <: p.L}
	{\varnothing; \Sigma; \Gamma \vdash p_1.L_1\; <:\; p.L}
\end{mathpar}
By our induction hypothesis we assume $\varnothing; \Sigma; \Gamma \vdash U_1 <: S \bigvee \varnothing; \Sigma; \Gamma \vdash U_1 <: U$, and either way we can use \textsc{S-Select-Upper} to conclude $\varnothing; \Sigma; \Gamma \vdash p_1.L_1 <: S \bigvee \varnothing; \Sigma; \Gamma \vdash p_1.L_1 <: U$.
\end{casethm}

\begin{casethm}[\textsc{S-Select-Lower}]
\begin{mathpar}
\inferrule
	{\varnothing; \Sigma; \Gamma \vdash p \ni \texttt{type} \; L : S .. U \\
	 \varnothing; \Sigma; \Gamma \vdash S <: U \\
	 \varnothing; \Sigma; \Gamma \vdash T <: S}
	{\varnothing; \Sigma; \Gamma \vdash T \; <:\; p.L}
\end{mathpar}
Trivial.
\end{casethm}

\begin{casethm}[\textsc{S-Bottom}]
\begin{mathpar}
	\and
\inferrule
	{}
	{\varnothing; \Sigma; \Gamma \vdash \bot\; \texttt{<:}\; T}
\end{mathpar}
Trivial.
\end{casethm}
\end{proof}

\newpage

\begin{lemma}[Leadsto Preservation] \label{lem:field_leadsto_preservation}

\begin{mathpar}
\inferrule
	{\varnothing; \Sigma; \varnothing \vdash v : T \\
	 \varnothing; \Sigma; \varnothing \vdash T <: \{z \Rightarrow \overline{\sigma}\} \\
	 \mu : \Sigma \\ 
	 \mu; \Sigma \vdash v \leadsto v' \\
	 \varnothing; \Sigma; \varnothing \vdash v' : T'}
	{\varnothing; \Sigma; \varnothing \vdash T' <: \{z \Rightarrow \overline{\sigma}\}}
	\quad (\textsc {<:-Preservation})
	\and
\inferrule
	{\varnothing; \Sigma; \varnothing \vdash v : T \\
	 \mu : \Sigma \\ 
	 \mu; \Sigma \vdash v \leadsto v'}
	{\varnothing; \Sigma; \varnothing \vdash v' : T'}
	\quad (\textsc {:-Preservation})
\end{mathpar}
\end{lemma}
\begin{proof}
By mutual induction on the derivation of $\mu; \Sigma \vdash v \leadsto v'$.
\subsubsection{$<:$ Preservation}
\begin{casethm}[\textsc{L-Loc}]
\begin{mathpar}
\inferrule
	{v = l \\
	 v' = l}
	{}
	\and
\inferrule
	{}
	{\mu; \Sigma \vdash l \leadsto l}
\end{mathpar}
Trivial.
\end{casethm}

\begin{casethm}[\textsc{L-Type}]
\begin{mathpar}
\inferrule
  {\mu; \Sigma \vdash v_1 \leadsto v_2 \\
  	\forall p \; L, T \neq p.L}
  {\mu; \Sigma \vdash v_1 \unlhd T_1 \leadsto v_2 \unlhd T_1}
\end{mathpar}
Straight forward application of the induction hypothesis and \textsc{T-Type}.

\end{casethm}

\begin{casethm}[\textsc{L-Type-Select-Lower}] \label{lem:leadsto-pres:case:L-Type-Select-Lower}
\begin{mathpar}
\inferrule
  {\varnothing; \Sigma; \varnothing \vdash v_1 : T_1 \\
  	\varnothing; \Sigma; \varnothing \vdash p \ni \texttt{type} \; L : S' .. U' \\
  	\varnothing; \Sigma; \varnothing \not\vdash T_1 <: U' \\
  	\mu; \Sigma \vdash v_1 \unlhd S' \unlhd U' \leadsto v_2}
  {\mu; \Sigma \vdash v_1 \unlhd p.L \leadsto v_2}
\end{mathpar}
By the well-formedness of $v_1 \unlhd p.L$ we know that $\varnothing; \Sigma; \varnothing \vdash T_1 <: p.L$, and using Lemma \ref{lem:bound_subtype} and $\varnothing; \Sigma; \varnothing \not\vdash T_1 <: U'$ we know that $\varnothing; \Sigma; \varnothing \vdash T_1 <: S'$. Since $\varnothing; \Sigma; \varnothing \vdash S' <: U'$ by \textsc{T-Type} we have $\varnothing; \Sigma; \varnothing \vdash v_1 \unlhd S' \unlhd U' : U'$. Because $\varnothing; \Sigma; \varnothing \vdash p.L <: \{z \Rightarrow \overline{\sigma}\}$ we have $\varnothing; \Sigma; \varnothing \vdash U' <: \{z \Rightarrow \overline{\sigma}\}$. $v_1 \unlhd S' \unlhd U'$ is a simpler value than $v_1 \unlhd p.L$ because $S'$ and $U'$ are simpler types than $p.L$. Since our induction is on both the complexity of the types in our value (or rather the size of the type trees used to derive the types) and the size of our value, we can apply our induction hypothesis with a decreasing size of the type derivation (\hl{Julian: What I'm trying to get across is that induction is done on both the size of the type layers (n) and the size of the type derivations involved (m). We can always guarantee a decreasing n or m but never an increasing m. Therefore our induction works.}). Thus by our mutual induction hypothesis we assume $\varnothing; \Sigma; \varnothing \vdash v_2 : T_2$ and thus that $\varnothing; \Sigma; \varnothing \vdash T_2 <: \{z \Rightarrow \overline{\sigma}\}$.
%By inversion on the derivation of $\varnothing; \Sigma; \varnothing \vdash T <: \{z \Rightarrow \overline{\sigma}\}$, where $T = p.L$.
%\begin{subcase}[\textsc{S-Assume}]
%Trivial since the assumption context is empty.
%\end{subcase}
%\begin{subcase}[\textsc{S-Select-Upper}]
%\begin{mathpar}
%\inferrule
%	{\varnothing; \Sigma; \varnothing \vdash p \ni \texttt{type} \; L : S' .. U'\\
%	 \varnothing; \Sigma; \varnothing \vdash S' <: U' \\
%	 \varnothing; \Sigma; \varnothing \vdash U' <: \{z \Rightarrow \overline{\sigma}\}}
%	{\varnothing; \Sigma; \varnothing \vdash p.L\; <:\; \{z \Rightarrow \overline{\sigma}\}}
%\end{mathpar}
%By the well-formedness of $v_1 \unlhd p.L$ we know that $\varnothing; \Sigma; \varnothing \vdash T_1 <: p.L$, and using Lemma \ref{lem:bound_subtype} and $\varnothing; \Sigma; \varnothing \not\vdash T_1 <: U'$ we know that $\varnothing; \Sigma; \varnothing \vdash T_1 <: S'$. Since $\varnothing; \Sigma; \varnothing \vdash S' <: U'$ by \textsc{T-Type} we have $\varnothing; \Sigma; \varnothing \vdash v_1 \unlhd S' \unlhd U'$. Because $\varnothing; \Sigma; \varnothing \vdash p.L <: \{z \Rightarrow \overline{\sigma}\}$ we have $\varnothing; \Sigma; \varnothing \vdash U' <: \{z \Rightarrow \overline{\sigma}\}$. By our mutual induction hypothesis we assume $\varnothing; \Sigma; \varnothing \vdash v_2 : T_2$ and thus that $\varnothing; \Sigma; \varnothing \vdash T_2 <: \{z \Rightarrow \overline{\sigma}\}$.
%\end{subcase}
%\begin{subcase}[\textsc{S-Select-Lower}]
%\end{subcase}
%\begin{subcase}[\textsc{S-Top}]
%\end{subcase}
\end{casethm}

\begin{casethm}[\textsc{L-Type-Select-Upper}]\label{lem:leadsto-pres:case:L-Type-Select-Upper}
\begin{mathpar}
\inferrule
  {\varnothing; \Sigma; \varnothing \vdash v_1 : T \\
  	\varnothing; \Sigma; \varnothing \vdash p \ni \texttt{type} \; L : S' .. U' \\
  	\varnothing; \Sigma; \varnothing \vdash T <: U' \\
  	\mu; \Sigma \vdash v_1 \unlhd U' \leadsto v_2}
  {\mu; \Sigma \vdash v_1 \unlhd p.L \leadsto v_2}
\end{mathpar}
We can use the same strategy as with the previous case, however we need one less step since we omit $S'$ from the new value.
\end{casethm}
\subsubsection{$:$ Preservation}
\begin{casethm}[\textsc{L-Loc}]
\begin{mathpar}
\inferrule
	{v = l \\
	 v' = l}
	{}
	\and
\inferrule
	{}
	{\mu; \Sigma \vdash l \leadsto l}
\end{mathpar}
Trivial.
\end{casethm}

\begin{casethm}[\textsc{L-Type}]
\begin{mathpar}
\inferrule
  {\mu; \Sigma \vdash v_1 \leadsto v_2 \\
  	\forall p \; L, T \neq p.L}
  {\mu; \Sigma \vdash v_1 \unlhd T_1 \leadsto v_2 \unlhd T_1}
\end{mathpar}
By our induction hypothesis we assume $\varnothing; \Sigma; \varnothing \vdash v_2 : T_2$. Now looking at the structure of $T$.
\begin{subcase}[$T_1 = \{z \Rightarrow \overline{\sigma}\}$]
By our induction hypothesis we have $\varnothing; \Sigma; \varnothing \vdash T_2 <: \{z \Rightarrow \overline{\sigma}\}$. By \textsc{T-Type} we then have $\varnothing; \Sigma; \varnothing \vdash v_2 \unlhd \{z \Rightarrow \overline{\sigma}\} : \{z \Rightarrow \overline{\sigma}\}$
\end{subcase}
\begin{subcase}[$T_1 = \top$]
By \textsc{S-Top} we have $\varnothing; \Sigma; \varnothing \vdash T_2 <: \top$. Now by \textsc{T-Type} we get $\varnothing; \Sigma; \varnothing \vdash v_2 \unlhd \top : \top$.
\end{subcase}
\begin{subcase}[$T_1 = \bot$]
If $v_1 \unlhd \bot$ is well-formed, this is clearly not possible since this would push the type of $v_1$ down to $\bot$ which is not possible. Thus we reach a contradiction.
\end{subcase}
\end{casethm}

\begin{casethm}[\textsc{L-Type-Select-Lower}]
\begin{mathpar}
\inferrule
  {\varnothing; \Sigma; \varnothing \vdash v_1 : T_1 \\
  	\varnothing; \Sigma; \varnothing \vdash p \ni \texttt{type} \; L : S' .. U' \\
  	\varnothing; \Sigma; \varnothing \not\vdash T_1 <: U' \\
  	\mu; \Sigma \vdash v_1 \unlhd S' \unlhd U' \leadsto v_2}
  {\mu; \Sigma \vdash v_1 \unlhd p.L \leadsto v_2}
\end{mathpar}
By the same reasoning in Case \ref{lem:leadsto-pres:case:L-Type-Select-Lower} we can say $\varnothing; \Sigma; \varnothing \vdash v_1 \unlhd S' \unlhd U' : U'$. Now by our induction hypothesis we can assume that $\varnothing; \Sigma; \varnothing \vdash v_2 : T_2$.
\end{casethm}

\begin{casethm}[\textsc{L-Type-Select-Upper}]
\begin{mathpar}
\inferrule
  {\varnothing; \Sigma; \varnothing \vdash v_1 : T \\
  	\varnothing; \Sigma; \varnothing \vdash p \ni \texttt{type} \; L : S' .. U' \\
  	\varnothing; \Sigma; \varnothing \vdash T <: U' \\
  	\mu; \Sigma \vdash v_1 \unlhd U' \leadsto v_2}
  {\mu; \Sigma \vdash v_1 \unlhd p.L \leadsto v_2}
\end{mathpar}
By the same reasoning in Case \ref{lem:leadsto-pres:case:L-Type-Select-Upper} we can say $\varnothing; \Sigma; \varnothing \vdash v_1 \unlhd U' : U'$. Now by our induction hypothesis we can assume that $\varnothing; \Sigma; \varnothing \vdash v_2 : T_2$.
\end{casethm}
\end{proof}
\qed

\newpage

\begin{lemma}[Leadsto Expansion Preservation] \label{lem:leadsto_expansion_preservation}

\begin{mathpar}
\inferrule
	{\varnothing; \Sigma; \varnothing \vdash v : T \\
	 \varnothing; \Sigma; \varnothing \vdash T \prec_z \overline{\sigma} \\
	 \mu : \Sigma \\ 
	 \mu; \Sigma \vdash v \leadsto v' \\
	 \varnothing; \Sigma; \varnothing \vdash v' : T'}
	{\varnothing; \Sigma; \varnothing \vdash T' \prec_z \overline{\sigma}}
\end{mathpar}
\end{lemma}
\begin{proof}
By structural induction on the derivation of $\mu; \Sigma \vdash v \leadsto v'$.
\begin{casethm}[\textsc{L-Loc}]
\begin{mathpar}
\inferrule
	{v = l \\
	 v' = l}
	{}
	\and
\inferrule
	{}
	{\mu; \Sigma \vdash l \leadsto l}
\end{mathpar}
Trivial.
\end{casethm}

\begin{casethm}[\textsc{L-Type}]
\begin{mathpar}
\inferrule
  {\mu; \Sigma \vdash v_1 \leadsto v_2 \\
  	\forall p \; L, T \neq p.L}
  {\mu; \Sigma \vdash v_1 \unlhd T_1 \leadsto v_2 \unlhd T_1}
\end{mathpar}
Trivial.
\end{casethm}

\begin{casethm}[\textsc{L-Type-Select-Lower}]\label{lem:leadsto_expansion:case:select_lower}
\begin{mathpar}
\inferrule
  {\varnothing; \Sigma; \varnothing \vdash v_1 : T_1 \\
  	\varnothing; \Sigma; \varnothing \vdash p \ni \texttt{type} \; L : S' .. U' \\
  	\varnothing; \Sigma; \varnothing \not\vdash T_1 <: U' \\
  	\mu; \Sigma \vdash v_1 \unlhd S' \unlhd U' \leadsto v_2}
  {\mu; \Sigma \vdash v_1 \unlhd p.L \leadsto v_2}
\end{mathpar}
By \textsc{T-Type} we have $\varnothing; \Sigma; \varnothing \vdash v_1 \unlhd S' \unlhd U' : U'$. Inversion on the derivation of $\varnothing; \Sigma; \varnothing \vdash p.L \prec_z \overline{\sigma}$ gives us $\varnothing; \Sigma; \varnothing \vdash U' \prec_z \overline{\sigma}$. By Lemma \ref{lem:field_leadsto_preservation} we know $\exists T_2 : \varnothing; \Sigma; \varnothing \vdash v_2 : T_2$. Now by our induction hypothesis we assume $\varnothing; \Sigma; \varnothing \vdash T_2 \prec_z \overline{\sigma}$.
\end{casethm}

\begin{casethm}[\textsc{L-Type-Select-Upper}]
\begin{mathpar}
\inferrule
  {\varnothing; \Sigma; \varnothing \vdash v_1 : T \\
  	\varnothing; \Sigma; \varnothing \vdash p \ni \texttt{type} \; L : S' .. U' \\
  	\varnothing; \Sigma; \varnothing \vdash T <: U' \\
  	\mu; \Sigma \vdash v_1 \unlhd U' \leadsto v_2}
  {\mu; \Sigma \vdash v_1 \unlhd p.L \leadsto v_2}
\end{mathpar}
We use similar reasoning here as we did in Case \ref{lem:leadsto_expansion:case:select_lower}.
\end{casethm}
\end{proof}
\qed

\newpage

\begin{lemma}[Leadsto Field Preservation] \label{lem:field_leadsto_preservation}

\begin{mathpar}
\inferrule
	{\varnothing; \Sigma; \varnothing \vdash v.f : T \\
	 \mu; \Sigma \vdash v \leadsto_{f} v'}
	{\varnothing; \Sigma; \varnothing \vdash v' : T}
\end{mathpar}
\end{lemma}
\begin{proof}
By structural induction on the derivation of $\mu; \Sigma \vdash v \leadsto_{f} v'$.
\begin{casethm}[\textsc{L\textsubscript{$f$}-Loc}]
\begin{mathpar}
\inferrule
	{v = l \\
	 v' = [l/z]v \unlhd T}
	{}
	\and
\inferrule
  {\mu(l) = \{z \Rightarrow ..., \texttt{val} \; f : T_f = v, ...\}}
  {\mu; \Sigma \vdash l \leadsto_{f} [l/z]v \unlhd T_f}
\end{mathpar}
Since $\mu : \Sigma$ we know $\Sigma(l) = \{z \Rightarrow ..., \texttt{val} \; f : T, ...\}$. By inversion on the premise $\varnothing; \Sigma; \varnothing \vdash l.f : T$ we have
\begin{mathpar}
\inferrule
  {	\varnothing; \Sigma; \varnothing \vdash l : \{z \Rightarrow ..., \texttt{val} \; f : T, ...\} \\
  	\varnothing; \Sigma; \varnothing \vdash l \ni \texttt{val} \; f:T}
  {	\varnothing; \Sigma; \varnothing \vdash l.f : T}
\end{mathpar}
Now by inversion on the derivation of $\varnothing; \Sigma; \varnothing \vdash l \ni \texttt{val} \; f:T$ we can get $T = [l/z]T_f$. Since by \textsc{T-Type} $\varnothing; \Sigma; \varnothing \vdash [l/z]v \unlhd T_f : [l/z]T_f$ the case holds.
\end{casethm}

\begin{casethm}[\textsc{L\textsubscript{$f$}-Type}]
\begin{mathpar}
\inferrule
  {\mu; \Sigma \vdash v_1 \leadsto_{f} v_2 \\
  \texttt{val} \; f:T_f \in \overline{\sigma}}
  {\mu; \Sigma \vdash v_1 \unlhd \{z \Rightarrow \overline{\sigma}\} \leadsto_{f} v_2 \unlhd [v_1 \unlhd \{z \Rightarrow \overline{\sigma}\} / z]T_f}
\end{mathpar}
By inversion on the derivation of $\varnothing; \Sigma; \varnothing \vdash v_1.f : T$ we get 
\begin{mathpar}
\inferrule
  {	\varnothing; \Sigma; \varnothing \vdash v_1 : \{z \Rightarrow ..., \texttt{val} \; f : T, ...\} \\
  	\varnothing; \Sigma; \varnothing \vdash v_1 \ni \texttt{val} \; f:T}
  {	\varnothing; \Sigma; \varnothing \vdash v_1.f : T}
\end{mathpar}
As with the previous case we can show that $T = [v_1 \unlhd \{z \Rightarrow \overline{\sigma}\}/z]T_f$ and thus the case holds.
\end{casethm}

\begin{casethm}[\textsc{L\textsubscript{$f$}-Type-Select}]
\begin{mathpar}
\inferrule
  {\mu; \Sigma \vdash v_1 \unlhd p.L \leadsto v_2 \\
   \mu; \Sigma \vdash v_2 \leadsto_{f} v_3}
  {\mu; \Sigma \vdash v_1 \unlhd p.L \leadsto_{f} v_3}
\end{mathpar}
By Lemma \ref{lem:leadsto_expansion_preservation} we know that if $	\varnothing; \Sigma; \varnothing \vdash v_2 : T_2$ then $T_2$ expands to the same declaration types ($\overline{\sigma}$) as $p.L$. Thus 
\hl{If $p_s : S, p_T : T$, $S <: T$, $S \equiv T$ and they both expand to $\overline{\sigma}$ then $\forall \sigma \in \overline{\sigma}$, $[p_T/z]\sigma <: [p_S/z]\sigma$.}
\end{casethm}

\end{proof}
\qed

\newpage

\begin{lemma}[Leadsto Method Preservation] \label{lem:meth_leadsto_preservation}

\begin{mathpar}
\inferrule
	{\varnothing; \Sigma; \varnothing \vdash v_1.m(v_2) : T \\
	 \mu; \Sigma \vdash v_1 \leadsto_{m(v_2)} e}
	{\varnothing; \Sigma; \varnothing \vdash e : T}
\end{mathpar}
\end{lemma}
\begin{proof}
By structural induction on the derivation of $\mu; \Sigma \vdash v_1 \leadsto_{m(v_2)} e$.
\begin{casethm}[\textsc{L\textsubscript{$m$}-Loc}]
\begin{mathpar}
\inferrule
	{v = l \\
	 v' = [v_2 \unlhd S/x, l/z]e \unlhd T}
	{}
	\and
\inferrule
  {\mu(l) = \{z \Rightarrow ..., \texttt{def} \; m (x : S) = e : T, ...\}}
  {\mu; \Sigma \vdash l \leadsto_{m(v_2)} [v_2 \unlhd S/x, l/z]e \unlhd T}
\end{mathpar}
Trivial.
\end{casethm}

\begin{casethm}[\textsc{L\textsubscript{$m$}-Type}]
\begin{mathpar}
\inferrule
  {\mu; \Sigma \vdash v_1 \leadsto_{m(v_2 \unlhd S)} e \\
  \texttt{def} \; m : S \rightarrow T \in \overline{\sigma}}
  {\mu; \Sigma \vdash v_1 \unlhd \{z \Rightarrow \overline{\sigma}\} \leadsto_{m(v_2)} e \unlhd T}
\end{mathpar}
Straight forward application of the induction hypothesis and \textsc{T-Type}.

\end{casethm}

\begin{casethm}[\textsc{L\textsubscript{$m$}-Type-Select}]
\begin{mathpar}
\inferrule
  {\mu; \Sigma \vdash v_1 \unlhd p.L \leadsto v_2 \\
   \mu; \Sigma \vdash v_2 \leadsto_{m(v_2)} v_3}
  {\mu; \Sigma \vdash v_1 \unlhd p.L \leadsto_{m} v_3}
\end{mathpar}
\end{casethm}
\end{proof}
\qed

\newpage

\begin{theorem}[Preservation]
If $\varnothing; \Sigma; \Gamma \vdash e : T$, 
   	$\mu \; | \; e \; \rightarrow \mu' \; | \; e'$ where
	$\Sigma \vdash \mu \; \tt{\bf{wf}}$ then 
 	$\exists \Sigma'$ s.t. 
	$\Sigma'$ extends $\Sigma$, 
	$\Sigma' \vdash \mu' \; \tt{\bf{wf}}$, 
	$\varnothing; \Sigma'; \Gamma \vdash e' : T$.
\end{theorem}
\begin{proof}
By structural induction on 
$\mu \; | \; e \; \rightarrow \mu' \; | \; e'$.
\begin{casethm}[\textsc{R-New}]
\begin{mathpar}
\inferrule
  {l \notin dom(\mu) \\
  	\mu' = \mu, l \mapsto \{\texttt{z} \Rightarrow \overline{d_v}\}}
  {\mu \; | \; \texttt{new} \; \{\texttt{z} \Rightarrow \overline{d_v}\} \; \rightarrow \mu' \; | \; l}
\end{mathpar}
Trivial.
\end{casethm}

\begin{casethm}[\textsc{R-Meth}]
\begin{mathpar}
\inferrule
  {\mu : \Sigma \\
   \mu; \Sigma \vdash v_1 \leadsto_{m} e}
  {\mu \; | \; v_1.m(v_2) \;\rightarrow \mu \; | \; [l/\texttt{z},v_2 \unlhd S/x]e}
\end{mathpar}
Trivial.
\end{casethm}

\begin{casethm}[\textsc{R-Context}]
\begin{mathpar}
\inferrule
  {	\mu \; | \; e \; \rightarrow \; \mu' \; | \; e'}
  {\mu \; | \; E[e] \; \rightarrow \mu' \; | \; E[e']}
\end{mathpar}
\end{casethm}

\end{proof}
\qed

\newpage

\section{Abstract}





\bibliographystyle{plain}
\bibliography{bib}

\end{document}