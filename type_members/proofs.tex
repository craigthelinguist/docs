\documentclass{llncs}

\usepackage{listings}
\usepackage{amssymb}
\usepackage[margin=.9in]{geometry}
\usepackage{amsmath}
%\usepackage{amsthm}
\usepackage{mathpartir}
\usepackage{color,soul}
\usepackage{graphicx}
\usepackage[framemethod=tikz]{mdframed}

%\theoremstyle{definition}
%%\newtheorem{case1}{Case1}
\spnewtheorem{casethm}{Case}[theorem]{\itshape}{\rmfamily}
\spnewtheorem{subcase}{Subcase}{\itshape}{\rmfamily}
\numberwithin{subcase}{casethm}
\numberwithin{casethm}{theorem}
\numberwithin{casethm}{lemma}




\lstdefinestyle{custom_lang}{
  xleftmargin=\parindent,
  showstringspaces=false,
  basicstyle=\ttfamily,
  keywordstyle=\bfseries
}

\lstset{emph={%  
    val, def, type, new, z%
    },emphstyle={\bfseries \tt}%
}

\begin{document}
\hl{*Note highlighted text implies more work is needed.}
\section{Type Safety}

\subsection{Subtype Transitivity and Environment Narrowing}

%---------------------- Narrowing ----------------------%



Before we can prove \emph{Preservation}, we need to 
prove \emph{Subtype Transitivity}. \emph{Transitivity} 
is mutually dependent on \emph{Environment Narrowing}.
\begin{mathpar}
\inferrule
  {\Gamma, (x : U); \Sigma \vdash T <: T' \\
  	\Gamma; \Sigma \vdash S <: U}
  {\Gamma, (x : S); \Sigma \vdash T <: T'}
\end{mathpar}
Instead of proving them at the same time, we weaken the 
\emph{Environment Narrowing} proof by admitting transitivity.
This is the the same tactic taken by Amin et. al. \cite{Amin:2014}.
To do this we define the following \emph{Subtype Transitivity} 
judgement 
\begin{mathpar}
\inferrule
  {}
  {\Gamma \vdash S \; <:^* \; S}
  \quad (\textsc {S\textsuperscript{*}-Refl})
	\and
\inferrule
  {\Gamma \vdash S \; <:^* \; T \\
	\Gamma \vdash T \; <: \; U}
  {\Gamma \vdash S \; <:^* \; U}
  \quad (\textsc {S\textsuperscript{*}-Trans})
\end{mathpar}
\emph{Environment Narrowing} can now be rewritten as 
\begin{mathpar}
\inferrule
  {\Gamma, (x : U); \Sigma \vdash T <: T' \\
  	\Gamma; \Sigma \vdash S <: U}
  {\Gamma, (x : S); \Sigma \vdash T <:^* T'}
\end{mathpar}

We also make a change to the subsumption typing rule 
\textsc{T-Sub} to also admit transitivity. This is done to 
assist in the induction case for type parametrised expressions 
during the \emph{Narrowing} proof. Our new rule, \textsc{T-Sub*} 
replaces the \textsc{T-Sub} rule in the expression typing 
judgement. 
\begin{mathpar}
\inferrule
  {	\Gamma; \Sigma \vdash e : S \\
  	\Gamma; \Sigma \vdash S <:^* T}
  {	\Gamma; \Sigma \vdash e : T}
  \quad (\textsc {T-Sub*})
\end{mathpar}
With these two additions, we are able to prove the relaxed 
\emph{Narrowing} proof in Theorem \ref{thm:narrowing}. We then go 
on to prove \emph{Subtype Transitivity} in Theorem \ref{thm:trans}. 
Once we have \emph{Subtype Transitivity} it follows that 
the $<:^*$ judgement is equivalent to the subtyping judgement, 
and \textsc{T-Sub*} is equivalent to \textsc{T-Sub}.



Induction principles need to be constructed for each of our 
judgements. We can do this by treating judgements as either 
base cases or complex cases derived from simpler judgements. 
As an example, the induction principle for the subtyping 
judgement can be described below.
For any theorem $\mathcal{H}_{<:}$ on the subtyping judgement, if 
the base cases
\begin{mathpar}
\inferrule
  {}
  {\mathcal{H}_{<:}(\textsc{S-Refl}) \\
	\mathcal{H}_{<:}(\textsc{S-Top}) \\
	\mathcal{H}_{<:}(\textsc{S-Bottom})}
\end{mathpar}
hold, and if given $\mathcal{H}_{<:}$ holds for any simpler 
derivation of \textsc{S-Rec}, \textsc{S-Select-Upper} and
\textsc{S-Select-Lower} we can show that 
\begin{mathpar}
\inferrule
  {}
  {\mathcal{H}_{<:}(\textsc{S-Rec}) \\
	\mathcal{H}_{<:}(\textsc{S-Select-Upper}) \\
	\mathcal{H}_{<:}(\textsc{S-Select-Lower})}
\end{mathpar}
hold, then it follows that $\mathcal{H}_{<:}$ holds for all 
derived instances of the subtyping judgement. Similar inductive
schemes can be constructed for the \emph{Expansion}, \emph{Membership}, 
\emph{Typing} and \emph{Reduction} judgements.

For the following lemmas, we define 
$\Gamma; \Sigma \vdash \overline{\sigma} <:^* \overline{\sigma}'$
as $\forall \sigma_i' \in \overline{\sigma}', \exists 
\sigma_i \in \overline{\sigma}: 
\Gamma; \Sigma \vdash \sigma_i <:^* \sigma_i'$.

\newpage

\begin{lemma}\label{lem:subtype:decl} 
If 	$\Gamma; \Sigma \vdash S <: U, S \prec_z \overline{\sigma}, 
	U \prec_z \overline{\sigma}'$ then
	$\Gamma, (z:S); \Sigma \vdash \overline{\sigma} <:^* \overline{\sigma}'$.
\end{lemma}
\begin{proof}
By induction on the derivation of $\Gamma; \Sigma \vdash S <: U$.
\begin{casethm}[\textsc{S-Refl}]
\begin{mathpar}
\inferrule
  {S = T}
  {}
\end{mathpar}
Trivial.
\end{casethm}
\begin{casethm}[\textsc{S-Rec}]
\begin{mathpar}
\inferrule
  {S = \{z \Rightarrow \overline{\sigma}\} \\
  	T = \{z \Rightarrow \overline{\sigma}'\}}
  {}
  \and
\inferrule
  {\forall \sigma_i' \in \overline{\sigma}', \; \exists \; \sigma_i \in \overline{\sigma} \; st \; \Gamma, z : \{z \Rightarrow \overline{\sigma}\}; \Sigma \vdash \sigma_i <:\; \sigma_i'}
  {\Gamma; \Sigma \vdash \{z \Rightarrow \overline{\sigma}\}\; <:\; \{z \Rightarrow \overline{\sigma}'\}}
\end{mathpar}
Follows immediately from our definition.
\end{casethm}
\begin{casethm}[\textsc{S-Select-Upper}]
\begin{mathpar}
\inferrule
  {S = p.L}
  {}
  \and
\inferrule
  {\Gamma; \Sigma \vdash p \ni \texttt{type} \; L : S' .. U'\\
  	\Gamma; \Sigma \vdash S' <: U' \\
  	\Gamma; \Sigma \vdash U' <: T}
  {\Gamma; \Sigma \vdash p.L\; <:\; T}
\end{mathpar}
\end{casethm}
\begin{casethm}[\textsc{S-Select-Lower}]
\begin{mathpar}
\inferrule
  {T = p.L}
  {}
  \and
\inferrule
  {\Gamma; \Sigma \vdash p \ni \texttt{type} \; L : S' .. U' \\
  	\Gamma; \Sigma \vdash S' <: U' \\
  	\Gamma; \Sigma \vdash S <: S'}
  {\Gamma; \Sigma \vdash S \; <:\; p.L}
\end{mathpar}
\end{casethm}
\begin{casethm}[\textsc{S-Top}]
\begin{mathpar}
\inferrule
  {T = \top}
  {}
  \and
\inferrule
  {}
  {\Gamma; \Sigma \vdash T\; \texttt{<:}\; \top}
\end{mathpar}
\end{casethm}
\begin{casethm}[\textsc{S-Bottom}]
\begin{mathpar}
\inferrule
  {S = \bot}
  {}
\end{mathpar}
\end{casethm}
Since there is no expansion to $\bot$, we end up with a contradiction.
\end{proof}
\qed

%\begin{lemma} \label{lem:subst_type}
%\begin{mathpar}
%\inferrule
%  {\Gamma; \Sigma \vdash p : \Gamma(x)}
%  {	\Gamma; \Sigma \vdash [p/x]T <: T}
%\end{mathpar}
%\end{lemma}
%\begin{proof}
%By induction on $T$.
%\begin{casethm}[T-Rec]
%\begin{mathpar}
%\inferrule
%  {T = \{z \Rightarrow \overline{\sigma}\}}
%  {}
%\end{mathpar}
%By our induction hypothesis we assume that 
%$\Gamma$.
%\end{casethm}
%\begin{casethm}[T-Sel]
%\begin{mathpar}
%\inferrule
%  {T = p.L}
%  {}
%\end{mathpar}
%\end{casethm}
%\begin{casethm}[T-Top]
%\begin{mathpar}
%\inferrule
%  {T = \top}
%  {}
%\end{mathpar}
%\end{casethm}
%\begin{casethm}[T-Bottom]
%\begin{mathpar}
%\inferrule
%  {T = \bot}
%  {}
%\end{mathpar}
%\end{casethm}
%\end{proof}
%\qed

\newpage

We restrict expression substition to path substitution as 
the substitution of general expressions can lead to a loss 
of soundness.
\begin{lemma} \label{lem:subst}
\begin{mathpar}
\inferrule
  {\Gamma, (x : U); \Sigma \vdash e : T \\
  	\Gamma; \Sigma \vdash p : S \\
  	\Gamma; \Sigma \vdash S <: U}
  {[p \unlhd U/x]\Gamma; \Sigma \vdash [p \unlhd U/x]e : [p \unlhd U/x]T}
\end{mathpar}
\end{lemma}
\begin{proof}
By induction on the derivation of $\Gamma; \Sigma \vdash e : T$.
\begin{casethm}[T-Var]
\begin{mathpar}
\inferrule
  {e = y}
  {}
  \and
\inferrule
  {y \in dom(\Gamma, (x : U))}
  {	\Gamma, (x : U); \Sigma \vdash y : \Gamma(y)}
\end{mathpar}
A base case for our induction, we approach \textsc{T-Var} by case analysis
on the equality of $x$ and $y$.
\begin{subcase}[$y = x$]
If $y = x$, then $	\Gamma, (x : U); \Sigma \vdash y : U$,
$[p \unlhd U/x]y = p \unlhd U$ and $T = U$. $[p \unlhd U/x]U = U$ 
because the type of a variable in a well-formed environment 
cannot contain the variable itself. Thus by \textsc{T-Type} 
we have $\Gamma; \Sigma \vdash p \unlhd U : U$.
\end{subcase}
\begin{subcase}[$y \neq x$]
If $y \neq x$, then clearly $y \in dom(\Gamma)$ and by 
\textsc{T-Var}, $\Gamma; \Sigma \vdash y : \Gamma(y)$.
\end{subcase}
\end{casethm}

\begin{casethm}[T-Loc]
\begin{mathpar}
\inferrule
  {	l \in dom(\Sigma)}
  {	\Gamma; \Sigma \vdash l : \Sigma(l)}
\end{mathpar}
\textsc{T-Loc} is another but base case, and resolves trivially since 
$[p \unlhd U/x]l = l$ and $[p \unlhd U/x]\Sigma(l) = \Sigma(l)$.
\end{casethm}

\begin{casethm}[T-New]
\begin{mathpar}
\inferrule
  {\Gamma, z : \{z \Rightarrow \overline{\sigma}\}; \Sigma 
  \vdash \overline{d} : \overline{\sigma}}
  {	\Gamma; \Sigma\vdash \texttt{new} \; \{z \Rightarrow \overline{d}\} : 
  \{z \Rightarrow \overline{\sigma}\}}
\end{mathpar}
Our induction hypothesis assumes 
$\Gamma, z : \{z \Rightarrow \overline{\sigma}\}; \Sigma \vdash [p \unlhd U/x]\overline{d} : [p \unlhd U/x]\overline{\sigma}$
holds. Since 
$[p \unlhd U/x]\texttt{new} \; \{z \Rightarrow \overline{d}\} = 
\texttt{new} \; \{z \Rightarrow [p \unlhd U/x]\overline{d}\}$ it follows 
from \textsc{T-New} that 
$\Gamma; \Sigma\vdash [p \unlhd U/x]\texttt{new} \; \{z \Rightarrow \overline{d}\} : 
  [p \unlhd U/x]\{z \Rightarrow \overline{\sigma}\}$.
\end{casethm}

\begin{casethm}[T-Meth]
\begin{mathpar}
\inferrule
  {\Gamma; \Sigma \vdash e_0 \ni \texttt{def} \; m:S \rightarrow T \\
  	\Gamma; \Sigma \vdash e_1 : S \\
  	\Gamma; \Sigma \vdash T <: U}
  {	\Gamma; \Sigma \vdash e_0.m_U(e_1) : U}
\end{mathpar}
We assume by our induction hypothesis that 
\begin{mathpar}
\inferrule
  {\Gamma; \Sigma \vdash [p \unlhd U/x]e_0 \ni [p \unlhd U/x]\texttt{def} \; m:S' \rightarrow T' \\
  	\Gamma; \Sigma \vdash S <: [p \unlhd U/x]S', [p \unlhd U/x]T' <: T \\
  	\Gamma; \Sigma \vdash [p \unlhd U/x]e_1 : [p \unlhd U/x]S'}
  {}
\end{mathpar}
Thus by \emph{Subtype Transitivity} 
we get $\Gamma; \Sigma \vdash T' <: U$, and it follows by \textsc{T-Meth} 
that $	\Gamma; \Sigma \vdash [e'/x](e_0.m_U(e_1)) : U$.

\hl{TODO: include mutual induction scheme}
\end{casethm}

\begin{casethm}[T-Acc]
\begin{mathpar}
\inferrule
  {%	\Gamma; \Sigma \vdash e : S \\
  	\Gamma; \Sigma \vdash e \ni \texttt{val} \; f:T}
  {	\Gamma; \Sigma \vdash e.f : T}
\end{mathpar}
We assume by our mutual induction hypothesis that
\begin{mathpar}
\inferrule
  {\Gamma; \Sigma \vdash [e'/x]e \ni \texttt{val} \; f:T' \\
  	\Gamma; \Sigma \vdash T' <: T}
  {}
\end{mathpar}
Therefore, by \textsc{T-Acc} we have 
$\Gamma; \Sigma \vdash e.f : T'$, and by \textsc{T-Sub} 
we get $\Gamma; \Sigma \vdash e.f : T$.
\end{casethm}

\begin{casethm}[T-Type]
\begin{mathpar}
\inferrule
  {e = e_T \unlhd T}
  {}
  \and
\inferrule
  {	\Gamma; \Sigma \vdash e : T}
  {	\Gamma; \Sigma \vdash e \unlhd T : T}
\end{mathpar}
By our mutual induction hypothesis we assume that
\begin{mathpar}
\inferrule
  {\Gamma; \Sigma \vdash [e'/x]e : T}
  {}
\end{mathpar}
\textsc{T-Type} gives us $\Gamma; \Sigma \vdash [e'/x]e \unlhd T : T$.
\end{casethm}

\begin{casethm}[T-Sub]
\begin{mathpar}
\inferrule
  {	\Gamma; \Sigma \vdash e : S \\
  	\Gamma; \Sigma \vdash S <: T}
  {	\Gamma; \Sigma \vdash e : T}
\end{mathpar}
By our mutual induction hypothesis we assume that
\begin{mathpar}
\inferrule
  {\Gamma; \Sigma \vdash [e'/x]e : S}
  {}
\end{mathpar}
Then, by \textsc{T-Sub} we get $\Gamma; \Sigma \vdash [e'/x]e : T$.
\end{casethm}
\end{proof}
\qed

\newpage

\begin{lemma} \label{lem:subst}
If $\Gamma; \Sigma \vdash p : \Gamma(x)$ then 
$\Gamma; \Sigma \vdash [p/x]T <: T$.
\end{lemma}
\begin{proof}
\end{proof}
\qed

\newpage

There are four judgments mutually defined in our type system. 
Subtyping, Membership, Expansion and Expression Typing are all 
interdependent. Subtyping is dependent on Membership, which is 
dependent on both Expansion and Typing. Expansion is dependent on 
Membership and Typing is dependent on Subtyping. This means that 
when performing induction on the derivation of one, we need to be 
able extend the induction hypothesis to the others. Therefore, when 
proving environmental narrowing, we need to prove the following 
theorems mutually.
\begin{lemma}[Environment Narrowing*]\label{thm:narrowing}
\begin{mathpar}
\inferrule
  {\Gamma, (x : U); \Sigma \vdash T <: T' \\
  	\Gamma; \Sigma \vdash S <: U}
  {\Gamma, (x : S); \Sigma \vdash T <:^* T'}
  \quad (\textsc {<:-Narrowing*})
	\and
\inferrule
  {\Gamma, (x : U); \Sigma \vdash T <:^* T' \\
  	\Gamma; \Sigma \vdash S <: U}
  {\Gamma, (x : S); \Sigma \vdash T <:^* T'}
  \quad (\textsc {<:\textsuperscript{*}-Narrowing*})
	\and
\inferrule
  {\Gamma, (x : U); \Sigma \vdash T \prec \overline{\sigma} \\
  	\Gamma; \Sigma \vdash S <: U}
  {\exists \overline{\sigma}':
  	\Gamma, (x : S); \Sigma \vdash T \prec \overline{\sigma}' \\
  	\Gamma, (x : S); \Sigma \vdash \overline{\sigma}' <:^* \overline{\sigma}}
  \quad (\textsc {$\prec$-Narrowing*})
	\and
\inferrule
  {\Gamma, (x : U); \Sigma \vdash p \ni \sigma \\
  	\Gamma; \Sigma \vdash S <: U}
  {\exists \sigma':
  	\Gamma, (x : S); \Sigma \vdash p \ni \sigma' \\
  	\Gamma, (x : S); \Sigma \vdash \sigma' <:^* \sigma}
  \quad (\textsc {$\ni$-Narrowing*})
	\and
\inferrule
  {\Gamma, (x : U); \Sigma \vdash p : T \\
  	\Gamma; \Sigma \vdash S <: U}
  {\exists T':
  	\Gamma, (x : S); \Sigma \vdash p : T' \\
  	\Gamma, (x : S); \Sigma \vdash T' <:^* T}
  \quad (\textsc {:-Narrowing*})
\end{mathpar}
\end{lemma}
\begin{proof}
We proceed by mutual structural induction on the of each of the judgements:
\begin{mathpar}
\inferrule
  {\Gamma, (x : U); \Sigma \vdash T <: T' \\
  	\Gamma, (x : U); \Sigma \vdash T \prec \overline{\sigma} \\
  	\Gamma, (x : U); \Sigma \vdash p \ni \sigma \\
  	\Gamma, (x : U); \Sigma \vdash p : T}
  {}
\end{mathpar}
That is, if for each judgment the base cases (those cases that 
do not require the derivation of simpler judgments) are satisfied, 
and assuming the result for all simpler sub-derivations the we can 
show it holds for more complex cases, we can conclude it holds in 
general. While not explicitly stated above, we also include the 
relevant declaration forms of the above judgments.

\subsubsection*{\textsc {$<:$-Narrowing*}:}

\begin{casethm}[\textsc{S-Refl}]
\begin{mathpar}
\inferrule
  {}
  {T' = T \\
  	\Gamma, (x : U); \Sigma \vdash T\; \texttt{<:}\; T}
\end{mathpar}
In the reflexive base case \textsc{S-Refl}, $T' = T$. 
It follows trivially from \textsc{S-Refl} that 
$\Gamma, (x : S); \Sigma \vdash T\; \texttt{<:}\; T$.
\end{casethm}
\begin{casethm}[\textsc{S-Rec}]
\begin{mathpar}
\inferrule
  {}
  {T = \{z \Rightarrow \overline{\sigma}\} \\
  	T' = \{z \Rightarrow \overline{\sigma}'\}}
  	\and
\inferrule
  {\forall \sigma_i' \in \overline{\sigma}', \; \exists \; \sigma_i \in \overline{\sigma} \; st \; \Gamma, z : \{z \Rightarrow \overline{\sigma}\}, (x : U); \Sigma \vdash \sigma_i <:\; \sigma_i'}
  {\Gamma, (x : U); \Sigma \vdash \{z \Rightarrow \overline{\sigma}\}\; <:\; \{z \Rightarrow \overline{\sigma}'\}}
\end{mathpar}
From our induction hypothesis we need to show that if our result holds for each 
smaller subtype derivation, it holds for the larger derivation. Thus, if it
holds for each individual 
declaration type, it holds for the larger record type. 
That is, for each $\sigma'_i$ and $\sigma_i$ such 
that 
$\Gamma, z : \{z \Rightarrow \overline{\sigma}\}, (x : U); \Sigma 
\vdash \sigma_i <:\; \sigma_i'$,
the induction hypothesis for subtyping gives us 
$\Gamma, z : \{z \Rightarrow \overline{\sigma}\}, (x : S); \Sigma 
\vdash \sigma_i <:^*\; \sigma_i'$. From here is is simple to construct 
a chain of record types such that 
$\Gamma, (x : S); \Sigma \vdash \{z \Rightarrow \overline{\sigma}\} <:^*\; 
\{z \Rightarrow \overline{\sigma}'\}$.
\end{casethm}
\begin{casethm}[\textsc{S-Select-upper}]
\begin{mathpar}
\inferrule
  {}
  {T = p.L}
  	\and
\inferrule
  {\Gamma, (x : U); \Sigma \vdash p \ni \texttt{type} \; L : S' .. U'\\
%  	\Gamma, (x : U); \Sigma \vdash S' <: U' \\
  	\Gamma, (x : U); \Sigma \vdash U' <: T'}
  {\Gamma, (x : U); \Sigma \vdash x.L\; <:\; T'}
\end{mathpar}
Firstly, we need to use our mutually defined induction hypothesis for 
\textsc {$\ni$-Narrowing*} to derive 
$\exists \sigma':
\Gamma, (x : S); \Sigma \vdash p \ni \sigma'$ and
$\Gamma, (x : S); \Sigma \vdash \sigma' <:^* L : S' .. U'$.
i.e. $\exists S'' \, U'' : \Gamma, (x : S); \Sigma \vdash p \ni L : S'' .. U'', \;
U'' <:^* U'$
Now using the induction hypothesis for subtyping the Narrowing result holds for 
sub-derivations of the subtype relation. In this case the sub-derivation is 
$\Gamma, (x : U); \Sigma \vdash U' <: T'$, and it follows that 
$\Gamma, (x : S); \Sigma \vdash U' <:^* T'$ holds. 
We can now combine the two subtype chains to show that 
$\Gamma, (x : S); \Sigma \vdash U'' <:^* U', \; U' <:^* T' \Rightarrow  U'' <:^* T'$. 
It then follows that there exists some type $T''$ such that 
$\Gamma, (x : S); \Sigma \vdash p.L <: T'', \; T'' <:^* T'$ 
which gives us $\Gamma, (x : S); \Sigma \vdash p.L <:^* T'$.

\hl{ToDo: Show that $\Gamma \vdash S <: T, T <:^* U \Rightarrow S <:^* U$}
\end{casethm}
\begin{casethm}[\textsc{S-Select-Lower}]
\begin{mathpar}
\inferrule
  {}
  {T' = p.L}
  	\and
\inferrule
  {\Gamma, (x : U); \Sigma \vdash p \ni \texttt{type} \; L : S' .. U' \\
%  	\Gamma, (x : U); \Sigma \vdash S' <: U' \\
  	\Gamma, (x : U); \Sigma \vdash T <: S'}
  {\Gamma, (x : U); \Sigma \vdash T\; <:\; p.L}
\end{mathpar}
As in the previous case, we can use the \textsc {$\ni$-Narrowing*}
induction hypothesis to show that 
$\exists S'' \, U'' : \Gamma, (x : S); \Sigma \vdash p \ni L : S'' .. U'', \;
S' <:^* S''$.
We can also apply the \textsc {<:-Narrowing*} induction hypothesis 
to show that $\Gamma, (x : S); \Sigma \vdash T <:^* S'$, 
and subsequently that 
$\Gamma, (x : S); \Sigma \vdash T <:^* S''$. It  should then be easy 
to construct a subtyping chain such that 
$\Gamma, (x : S); \Sigma \vdash T <:^* p.L$.

\end{casethm}
\begin{casethm}[\textsc{S-Top}]
\begin{mathpar}
  {}
  {T' = \top \\ 
  	\Gamma, (x : U); \Sigma \vdash T\; \texttt{<:}\; \top}
\end{mathpar}
The base case dealing with subtyping of the top type is trivial 
since by \textsc{S-Top} 
$\Gamma, (x : S); \Sigma \vdash T\; \texttt{<:}\; \top$.
\end{casethm}
\begin{casethm}[\textsc{S-Bottom}]
\begin{mathpar}
\inferrule
  {}
  {T = \bot \\
  	\Gamma, (x : U); \Sigma \vdash \bot\; \texttt{<:}\; T'}
\end{mathpar}
The base case \textsc{S-Bottom} resolves trivially since 
by \textsc{S-Bottom} $\Gamma, (x : S); \Sigma \vdash \bot\; \texttt{<:}\; T'$
\end{casethm}
\begin{casethm}[\textsc{S-Decl-Val}]
\begin{mathpar}
\inferrule
  {}
  {\sigma = \texttt{val} \; f:T \\
  	\sigma' = \texttt{val} \; f:T}
  	\and
\inferrule
  {}
  {\Gamma, (x : U); \Sigma \vdash \texttt{val} \; f:T <: \texttt{val} \; f:T}
\end{mathpar}
The base case for declaration subtyping is resolves trivially by 
\textsc{S-Decl-Val}: 
$\Gamma, (x : S); \Sigma \vdash \texttt{val} \; f:T <: \texttt{val} \; f:T$
\end{casethm}
\begin{casethm}[\textsc{S-Decl-Def}]
\begin{mathpar}
\inferrule
  {}
  {\sigma = \texttt{def} \; m:S' \rightarrow T \\
  	\sigma' = \texttt{def} \; m:S'' \rightarrow T'}
  	\and
\inferrule
  {\Gamma, (x : U); \Sigma \vdash T <: T' \\
  	\Gamma, (x : U); \Sigma \vdash S'' <: S'}
  {\Gamma, (x : U); \Sigma \vdash \texttt{def} \; m:S' \rightarrow T <: \texttt{def} \; m:S'' \rightarrow T'}
\end{mathpar}
Using the \textsc {<:-Narrowing*} induction hypothesis 
for argument and return type subtyping we 
get $\Gamma, (x : S); \Sigma \vdash T <:^* T'$ and
$\Gamma, (x : S); \Sigma \vdash S'' <:^* S'$. We can then 
create a chain of declaration subtype judgments to show that 
$\Gamma, (x : S); \Sigma \vdash \texttt{def} \; m:S' \rightarrow T <:^* \texttt{def} \; m:S'' \rightarrow T'$.
\end{casethm}

\begin{casethm}[\textsc{S-Decl-Type}]
\begin{mathpar}
\inferrule
  {}
  {\sigma = \texttt{type} \; L : S' .. U' \\
  	\sigma' = \texttt{type} \; L : S'' .. U''}
  	\and
\inferrule
  {\Gamma, (x : U); \Sigma \vdash S'' <: S' \\
  	\Gamma, (x : U); \Sigma \vdash U' <: U''}
  {\Gamma, (x : U); \Sigma \vdash \texttt{type} \; L : S' .. U' \; <:\; \texttt{type} \; L : S'' .. U''}
\end{mathpar}
Similar to the \textsc{S-Decl-Def} case, by the induction hypothesis, 
if $\Gamma, (x : S); \Sigma \vdash S'' <:^* S'$ and
$\Gamma, (x : S); \Sigma \vdash U' <:^* U''$ hold, it can be shown that 
$\Gamma, (x : S); \Sigma \vdash \texttt{type} \; L : S' .. U' \; <:^* \; \texttt{type} \; L : S'' .. U''$ holds too.

\end{casethm}

\subsubsection*{\textsc {$\prec$-Narrowing*}:}

\begin{casethm}[\textsc{E-Rec}]
\begin{mathpar}
\inferrule
  {}
  {T = \{z \Rightarrow \overline{\sigma}\}}
  	\and
\inferrule
  {}
  {\Gamma, (x : U); \Sigma \vdash 
  		\{z \Rightarrow \overline{\sigma}\} \prec_z \overline{\sigma}}
\end{mathpar}
The base case for expansion follows immediately from \textsc{E-Rec}:
$\Gamma, (x : S); \Sigma \vdash \{z \Rightarrow \overline{\sigma}\} \prec_z \overline{\sigma}$.
\end{casethm}
\begin{casethm}[\textsc{E-Select}]
\begin{mathpar}
\inferrule
  {}
  {T = p.L}
  	\and
\inferrule
  {\Gamma, (x : U); \Sigma \vdash p \ni \texttt{type} \; L : S'..U' \\
  	\Gamma, (x : U); \Sigma \vdash U' \prec_z \overline{\sigma}}
  {\Gamma, (x : U); \Sigma \vdash p.L \prec_z \overline{\sigma}}
\end{mathpar}
By our mutual induction hypothesis we assume that
\begin{mathpar}
\inferrule
  {\Gamma, (x : S); \Sigma \vdash p \ni \texttt{type} \; L : S''..U'', \;
  	\texttt{type} \; L : S''..U'' <:^* \texttt{type} \; L : S'..U', \;
  	U' \prec_z \overline{\sigma}', \;
  	\overline{\sigma}' <:^* \overline{\sigma}}
  {}
\end{mathpar}
holds. By \textsc{S-Decl-Type}, we can infer that 
$\Gamma, (x : S); \Sigma \vdash U'' <:^* U'$. Using 
Lemma \ref{lem:subtype:decl} (\hl{TODO}), we can show that 
$\exists \overline{\sigma}'': \Gamma, (x : S); \Sigma \vdash U'' \prec 
\overline{\sigma}'', \; \overline{\sigma}'' <:^* \overline{\sigma}'$.
Thus, we can show that 
$\Gamma, (x : S); \Sigma \vdash \overline{\sigma}'' <:^* \overline{\sigma}$ 
which completes the case.

\hl{ToDo: U = $\bot$?}
\end{casethm}
\begin{casethm}[\textsc{E-Top}]
\begin{mathpar}
\inferrule
  {}
  {T = \top}
  	\and
\inferrule
  {}
  {\Gamma, (x : U); \Sigma \vdash \top \prec_z \varnothing}
\end{mathpar}
The \textsc{E-Top} base case resolves trivially. By 
\textsc{E-Top}, $\Gamma, (x : S); \Sigma \vdash \top \prec_z \varnothing$.
\end{casethm}

\subsubsection*{\textsc {$\ni$-Narrowing*}:}

\begin{casethm}[\textsc{M-Path}]
\begin{mathpar}
\inferrule
  {}
  {e = p \\
  	\sigma = [p/z]\sigma_i}
  	\and
\inferrule
  {\Gamma, (x : U); \Sigma \vdash p : T \\
  	\Gamma, (x : U); \Sigma \vdash T \prec_z \overline{\sigma}\\
  	\sigma_i \in \overline{\sigma}}
  {\Gamma, (x : U); \Sigma \vdash p \ni [p/z]\sigma_i}
\end{mathpar}
From the mutually defined induction hypothesis, we assume 
\begin{mathpar}
\inferrule
  {\Gamma, (x : S); \Sigma \vdash p : T', \; T' <:^* T \\
  	\Gamma, (x : S); \Sigma \vdash T \prec_z \overline{\sigma}', \;
  	\overline{\sigma}' <:^* \overline{\sigma}}
  {}
\end{mathpar}
By Lemma \ref{lem:subtype:decl} (\hl{TODO}), $\Gamma, (x : S); \Sigma \vdash T' \prec \overline{\sigma}''$ 
and $\Gamma, (x : S); \Sigma \vdash \overline{\sigma}'' <:^* \overline{\sigma}'$. 
We can now show that $\exists \sigma_i'' \in \overline{\sigma}'':
\Gamma, (x : S); \Sigma \vdash \sigma_i'' <:^* \sigma_i$, and thus that 
$\Gamma, (x : S); \Sigma \vdash [p/z]\sigma_i'' <:^* [p/z]\sigma_i$.

\hl{ToDo: Show T' expanding \\ Substitution preserves subtype?}
\end{casethm}
\begin{casethm}[\textsc{M-Exp}]
\begin{mathpar}
\inferrule
  {\Gamma, (x : U); \Sigma \vdash p : T \\
  	\Gamma, (x : U); \Sigma \vdash T \prec_z \overline{\sigma}\\
  	\sigma \in \overline{\sigma} \\
  	z \notin \sigma}
  {\Gamma, (x : U); \Sigma \vdash p \ni \sigma}
\end{mathpar}
We explicitly restrict the statement of the theorem to only include 
membership of paths, as a result, this cases resolves as in \textsc{M-Path}.
\end{casethm}

\subsubsection*{\textsc {:-Narrowing*}:}
We restrict Narrowing on expression typing to paths. This is done since for 
a generic expression narrowing does not hold. For this reason the below cases only deal 
with path expressions.
\begin{casethm}[\textsc{T-Var}]
\begin{mathpar}
\inferrule
  {}
  {p = y \\
  	T = \Gamma, (x : U)(y)}
  	\and
\inferrule
  {y \in dom(\Gamma, (x : U))}
  {	\Gamma, (y : U); \Sigma \vdash y : \Gamma(y)}
\end{mathpar}
\begin{itemize}
\item[]  \textit{Subcase 1} ($y = x$):
If $y = x$, then the result is immediate since by \textsc{T-Var} 
$\Gamma,(x:S); \Sigma \vdash x : S$, and by assumption 
$\Gamma; \Sigma \vdash S <: U$.
\item[]  \textit{Subcase 2} ($y \neq x$):
If $y \neq x$, then the type of $y$ remains the same and the result 
is achieved by reflexive.
\end{itemize}
\end{casethm}
\begin{casethm}[\textsc{T-Loc}]
\begin{mathpar}
\inferrule
  {}
  {p = l}
  	\and
\inferrule
  {	l \in dom(\Sigma)}
  {	\Gamma, (x : U); \Sigma \vdash l : \Sigma(l)}
\end{mathpar}
$\Gamma, (x : S); \Sigma \vdash l : \Sigma(l)$ follows immediately from \textsc{T-Loc}.
\end{casethm}
\begin{casethm}[\textsc{T-Acc}]
\begin{mathpar}
\inferrule
  {\Gamma, (x : U); \Sigma \vdash p : S \\
  	\Gamma, (x : U); \Sigma \vdash p \ni \texttt{val} \; f:T}
  {	\Gamma, (x : U); \Sigma \vdash p.f : T}
\end{mathpar}
By our mutual induction hypothesis we assume narrowing holds for the 
smaller premises.
\begin{mathpar}
\inferrule
  {\Gamma, (x : S); \Sigma \vdash p : S' \\
  	\Gamma, (x : S); \Sigma \vdash S' <:^* S}
  {}
  	\and
\inferrule
  {\Gamma, (x : S); \Sigma \vdash p \ni \texttt{val} \; f:T' \\
  	\Gamma, (x : S); \Sigma \vdash T' <:^* T}
  {}
\end{mathpar}
By \textsc{T-Acc}, we get
\begin{mathpar}
\inferrule
  {\Gamma, (x : S); \Sigma \vdash p.f : T'}
  {}
\end{mathpar}
completing the case.
\end{casethm}
\begin{casethm}[\textsc{T-Type}]
\begin{mathpar}
\inferrule
  {\Gamma, (x : U); \Sigma \vdash p : T}
  {	\Gamma, (x : U); \Sigma \vdash p \unlhd T : T}
\end{mathpar}
By the mutual induction hypothesis we assume narrowing holds 
for the simpler expression typing premise.
\begin{mathpar}
\inferrule
  {\Gamma, (x : S); \Sigma \vdash p : T' \\
  	\Gamma, (x : S); \Sigma \vdash T' <:^* T}
  {}
\end{mathpar}
By \textsc{T-Sub*}, we get $\Gamma, (x : S); \Sigma \vdash p : T$, 
and subsequently by \textsc{T-Type} we get $\Gamma, (x : S); \Sigma \vdash p \unlhd T : T$.
\end{casethm}

\begin{casethm}[\textsc{T-Sub*}]
\begin{mathpar}
\inferrule
  {	\Gamma, (x : U); \Sigma \vdash e : T' \\
  	\Gamma, (x : U); \Sigma \vdash T' <:^* T}
  {	\Gamma, (x : U); \Sigma \vdash e : T}
\end{mathpar}
From our mutual induction hypothesis, we assume 
$\Gamma, (x : S); \Sigma \vdash e : T'', T'' <:^* T'$ and 
$\Gamma, (x : S); \Sigma \vdash T' <:^* T$. This gives us 
$\Gamma, (x : S); \Sigma \vdash T'' <:^* T$ and by \textsc{T-Sub} we
get the desired result.
\end{casethm}

\subsubsection*{\textsc {$<:^*$-Narrowing*}:}
\begin{casethm}[\textsc {S\textsuperscript{*}-Refl}]
\begin{mathpar}
\inferrule
  {}
  {\Gamma, (x : U); \Sigma \vdash S \; <:^* \; S}
\end{mathpar}
The base case for transitive subtyping is simple by \textsc{S\textsuperscript{*}-Refl}.
\end{casethm}
\begin{casethm}[\textsc {S\textsuperscript{*}-Trans}]
\begin{mathpar}
\inferrule
  {\Gamma, (x : U); \Sigma \vdash T \; <:^* \; T' \\
	\Gamma, (x : U); \Sigma \vdash T' \; <: \; T''}
  {\Gamma, (x : U); \Sigma \vdash T \; <:^* \; T''}
\end{mathpar}
From our mutual induction hypothesis we get 
\begin{mathpar}
\inferrule
  {\Gamma, (x : S); \Sigma \vdash S \; <:^* \; T \\
	\Gamma, (x : S); \Sigma \vdash T \; <:^* \; U}
  {}
\end{mathpar}
This immediately gives us the desired result 
$\Gamma, (x : S); \Sigma \vdash T \; <:^* \; T''$.
\end{casethm}
\end{proof}
\qed

%First we define the following \emph{Subtype Transitivity} judgement 
%\begin{mathpar}
%\inferrule
%  {}
%  {\Gamma \vdash S \; <:^* \; S}
%  \quad (\textsc {S\textsuperscript{*}-Refl})
%	\and
%\inferrule
%  {\Gamma \vdash S \; <:^* \; T \\
%	\Gamma \vdash T \; <: \; U}
%  {\Gamma \vdash S \; <:^* \; U}
%  \quad (\textsc {S\textsuperscript{*}-Trans})
%\end{mathpar}
%This is used to admit transitivity when proving a relaxed version of
%Environment Narrowing below, making Narrowing independent of 
%Subtype Transitivity.
%
%
%Induction principles need to be constructed for each of our 
%judgements. We can do this by treating judgements as either 
%base cases or complex cases derived from simpler judgements. 
%As an example, the induction principle for the subtyping 
%judgement can be described below.
%For any theorem $\mathcal{H}_{<:}$ on the subtyping judgement, if 
%the base cases
%\begin{mathpar}
%\inferrule
%  {}
%  {\mathcal{H}_{<:}(\textsc{S-Refl}) \\
%	\mathcal{H}_{<:}(\textsc{S-Top}) \\
%	\mathcal{H}_{<:}(\textsc{S-Bottom})}
%\end{mathpar}
%hold, and if given $\mathcal{H}_{<:}$ holds for any simpler 
%derivation of \textsc{S-Rec}, \textsc{S-Select-Upper} and
%\textsc{S-Select-Lower} we can show that 
%\begin{mathpar}
%\inferrule
%  {}
%  {\mathcal{H}_{<:}(\textsc{S-Rec}) \\
%	\mathcal{H}_{<:}(\textsc{S-Select-Upper}) \\
%	\mathcal{H}_{<:}(\textsc{S-Select-Lower})}
%\end{mathpar}
%hold, then it follows that $\mathcal{H}_{<:}$ holds for all 
%derived instances of the subtyping judgement. Similar inductive
%schemes can be constructed for the \emph{Expansion}, \emph{Membership}, 
%\emph{Typing} and \emph{Reduction} judgements.
%
%\begin{lemma}\label{lem:subtype:decl} 
%If 	$\Gamma; \Sigma \vdash S <: U, S \prec \overline{\sigma}, 
%	U \prec \overline{\sigma}'$ then
%	$\Gamma; \Sigma \vdash \overline{\sigma} <:^* \overline{\sigma}'$.
%\end{lemma}
%\begin{proof}
%\hl{ToDo}
%\end{proof}
%\qed
%
%There are four judgments mutually defined in our type system. 
%Subtyping, Membership, Expansion and Expression Typing are all 
%interdependent. Subtyping is dependent on Membership, which is 
%dependent on both Expansion and Typing. Expansion is dependent on 
%Membership and Typing is dependent on Subtyping. This means that 
%when performing induction on the derivation of one, we need to be 
%able extend the induction hypothesis to the others. Therefore, when 
%proving environmental narrowing, we need to prove the following 
%theorems mutually.
%\begin{theorem}[Environment Narrowing*] \label{thm:narrow}
%\begin{mathpar}
%\inferrule
%  {\Gamma, (x : U); \Sigma \vdash T <: T' \\
%  	\Gamma; \Sigma \vdash S <: U}
%  {\Gamma, (x : S); \Sigma \vdash T <:^* T'}
%  \quad (\textsc {<:-Narrowing*})
%	\and
%\inferrule
%  {\Gamma, (x : U); \Sigma \vdash T \prec \overline{\sigma} \\
%  	\Gamma; \Sigma \vdash S <: U}
%  {\exists \overline{\sigma}':
%  	\Gamma, (x : S); \Sigma \vdash T \prec \overline{\sigma}' \\
%  	\Gamma, (x : S); \Sigma \vdash \overline{\sigma}' <:^* \overline{\sigma}}
%  \quad (\textsc {$\prec$-Narrowing*})
%	\and
%\inferrule
%  {\Gamma, (x : U); \Sigma \vdash p \ni \sigma \\
%  	\Gamma; \Sigma \vdash S <: U}
%  {\exists \sigma':
%  	\Gamma, (x : S); \Sigma \vdash p \ni \sigma' \\
%  	\Gamma, (x : S); \Sigma \vdash \sigma' <:^* \sigma}
%  \quad (\textsc {$\ni$-Narrowing*})
%	\and
%\inferrule
%  {\Gamma, (x : U); \Sigma \vdash p : T \\
%  	\Gamma; \Sigma \vdash S <: U}
%  {\exists T':
%  	\Gamma, (x : S); \Sigma \vdash p : T' \\
%  	\Gamma, (x : S); \Sigma \vdash T' <:^* T}
%  \quad (\textsc {:-Narrowing*})
%\end{mathpar}
%\end{theorem}
%\begin{proof}
%We proceed by mutual structural induction on the of each of the judgements:
%\begin{mathpar}
%\inferrule
%  {\Gamma, (x : U); \Sigma \vdash T <: T' \\
%  	\Gamma, (x : U); \Sigma \vdash T \prec \overline{\sigma} \\
%  	\Gamma, (x : U); \Sigma \vdash p \ni \sigma \\
%  	\Gamma, (x : U); \Sigma \vdash p : T}
%  {}
%\end{mathpar}
%That is, if for each judgment the base cases (those cases that 
%do not require the derivation of simpler judgments) are satisfied, 
%and assuming the result for all simpler sub-derivations the we can 
%show it holds for more complex cases, we can conclude it holds in 
%general. While not explicitly stated above, we also include the 
%relevant declaration forms of the above judgments.
%
%\subsubsection*{\textsc {$<:$-Narrowing*}:}
%
%\begin{casethm}[\textsc{S-Refl}]
%\begin{mathpar}
%\inferrule
%  {}
%  {T' = T \\
%  	\Gamma, (x : U); \Sigma \vdash T\; \texttt{<:}\; T}
%\end{mathpar}
%In the reflexive base case \textsc{S-Refl}, $T' = T$. 
%It follows trivially from \textsc{S-Refl} that 
%$\Gamma, (x : S); \Sigma \vdash T\; \texttt{<:}\; T$.
%\end{casethm}
%\begin{casethm}[\textsc{S-Rec}]
%\begin{mathpar}
%\inferrule
%  {}
%  {T = \{z \Rightarrow \overline{\sigma}\} \\
%  	T' = \{z \Rightarrow \overline{\sigma}'\}}
%  	\and
%\inferrule
%  {\forall \sigma_i' \in \overline{\sigma}', \; \exists \; \sigma_i \in \overline{\sigma} \; st \; \Gamma, z : \{z \Rightarrow \overline{\sigma}\}, (x : U); \Sigma \vdash \sigma_i <:\; \sigma_i'}
%  {\Gamma, (x : U); \Sigma \vdash \{z \Rightarrow \overline{\sigma}\}\; <:\; \{z \Rightarrow \overline{\sigma}'\}}
%\end{mathpar}
%From our induction hypothesis we need to show that if our result holds for each 
%smaller subtype derivation, it holds for the larger derivation. Thus, if it
%holds for each individual 
%declaration type, it holds for the larger record type. 
%That is, for each $\sigma'_i$ and $\sigma_i$ such 
%that 
%$\Gamma, z : \{z \Rightarrow \overline{\sigma}\}, (x : U); \Sigma 
%\vdash \sigma_i <:\; \sigma_i'$,
%the induction hypothesis for subtyping gives us 
%$\Gamma, z : \{z \Rightarrow \overline{\sigma}\}, (x : S); \Sigma 
%\vdash \sigma_i <:^*\; \sigma_i'$. From here is is simple to construct 
%a chain of record types such that 
%$\Gamma, (x : S); \Sigma \vdash \{z \Rightarrow \overline{\sigma}\} <:^*\; 
%\{z \Rightarrow \overline{\sigma}'\}$.
%\end{casethm}
%\begin{casethm}[\textsc{S-Select-upper}]
%\begin{mathpar}
%\inferrule
%  {}
%  {T = p.L}
%  	\and
%\inferrule
%  {\Gamma, (x : U); \Sigma \vdash p \ni \texttt{type} \; L : S' .. U'\\
%  	\Gamma, (x : U); \Sigma \vdash S' <: U' \\
%  	\Gamma, (x : U); \Sigma \vdash U' <: T'}
%  {\Gamma, (x : U); \Sigma \vdash x.L\; <:\; T'}
%\end{mathpar}
%Firstly, we need to use our mutually defined induction hypothesis for 
%\textsc {$\ni$-Narrowing*} to derive 
%$\exists \sigma':
%\Gamma, (x : S); \Sigma \vdash p \ni \sigma'$ and
%$\Gamma, (x : S); \Sigma \vdash \sigma' <:^* L : S' .. U'$.
%i.e. $\exists S'' \, U'' : \Gamma, (x : S); \Sigma \vdash p \ni L : S'' .. U'', \;
%U'' <:^* U'$
%Now using the induction hypothesis for subtyping the Narrowing result holds for 
%sub-derivations of the subtype relation. In this case the sub-derivation is 
%$\Gamma, (x : U); \Sigma \vdash U' <: T'$, and it follows that 
%$\Gamma, (x : S); \Sigma \vdash U' <:^* T'$ holds. 
%We can now combine the two subtype chains to show that 
%$\Gamma, (x : S); \Sigma \vdash U'' <:^* U', \; U' <:^* T' \Rightarrow  U'' <:^* T'$. 
%It then follows that there exists some type $T''$ such that 
%$\Gamma, (x : S); \Sigma \vdash p.L <: T'', \; T'' <:^* T'$ 
%which gives us $\Gamma, (x : S); \Sigma \vdash p.L <:^* T'$.
%
%\hl{ToDo: Show that $\Gamma \vdash S <: T, T <:^* U \Rightarrow S <:^* U$}
%\end{casethm}
%\begin{casethm}[\textsc{S-Select-Lower}]
%\begin{mathpar}
%\inferrule
%  {}
%  {T' = p.L}
%  	\and
%\inferrule
%  {\Gamma, (x : U); \Sigma \vdash p \ni \texttt{type} \; L : S' .. U' \\
%  	\Gamma, (x : U); \Sigma \vdash S' <: U' \\
%  	\Gamma, (x : U); \Sigma \vdash T <: S'}
%  {\Gamma, (x : U); \Sigma \vdash T\; <:\; p.L}
%\end{mathpar}
%As in the previous case, we can use the \textsc {$\ni$-Narrowing*}
%induction hypothesis to show that 
%$\exists S'' \, U'' : \Gamma, (x : S); \Sigma \vdash p \ni L : S'' .. U'', \;
%S' <:^* S''$.
%We can also apply the \textsc {<:-Narrowing*} induction hypothesis 
%to show that $\Gamma, (x : S); \Sigma \vdash T <:^* S'$, 
%and subsequently that 
%$\Gamma, (x : S); \Sigma \vdash T <:^* S''$. It  should then be easy 
%to construct a subtyping chain such that 
%$\Gamma, (x : S); \Sigma \vdash T <:^* p.L$.
%
%\end{casethm}
%\begin{casethm}[\textsc{S-Top}]
%\begin{mathpar}
%  {}
%  {T' = \top \\ 
%  	\Gamma, (x : U); \Sigma \vdash T\; \texttt{<:}\; \top}
%\end{mathpar}
%The base case dealing with subtyping of the top type is trivial 
%since by \textsc{S-Top} 
%$\Gamma, (x : S); \Sigma \vdash T\; \texttt{<:}\; \top$.
%\end{casethm}
%\begin{casethm}[\textsc{S-Bottom}]
%\begin{mathpar}
%\inferrule
%  {}
%  {T = \bot \\
%  	\Gamma, (x : U); \Sigma \vdash \bot\; \texttt{<:}\; T'}
%\end{mathpar}
%The base case \textsc{S-Bottom} resolves trivially since 
%by \textsc{S-Bottom} $\Gamma, (x : S); \Sigma \vdash \bot\; \texttt{<:}\; T'$
%\end{casethm}
%\begin{casethm}[\textsc{S-Decl-Val}]
%\begin{mathpar}
%\inferrule
%  {}
%  {\sigma = \texttt{val} \; f:T \\
%  	\sigma' = \texttt{val} \; f:T}
%  	\and
%\inferrule
%  {}
%  {\Gamma, (x : U); \Sigma \vdash \texttt{val} \; f:T <: \texttt{val} \; f:T}
%\end{mathpar}
%The base case for declaration subtyping is resolves trivially by 
%\textsc{S-Decl-Val}: 
%$\Gamma, (x : S); \Sigma \vdash \texttt{val} \; f:T <: \texttt{val} \; f:T$
%\end{casethm}
%\begin{casethm}[\textsc{S-Decl-Def}]
%\begin{mathpar}
%\inferrule
%  {}
%  {\sigma = \texttt{def} \; m:S' \rightarrow T \\
%  	\sigma' = \texttt{def} \; m:S'' \rightarrow T'}
%  	\and
%\inferrule
%  {\Gamma, (x : U); \Sigma \vdash T <: T' \\
%  	\Gamma, (x : U); \Sigma \vdash S'' <: S'}
%  {\Gamma, (x : U); \Sigma \vdash \texttt{def} \; m:S' \rightarrow T <: \texttt{def} \; m:S'' \rightarrow T'}
%\end{mathpar}
%Using the \textsc {<:-Narrowing*} induction hypothesis 
%for argument and return type subtyping we 
%get $\Gamma, (x : S); \Sigma \vdash T <:^* T'$ and
%$\Gamma, (x : S); \Sigma \vdash S'' <:^* S'$. We can then 
%create a chain of declaration subtype judgments to show that 
%$\Gamma, (x : S); \Sigma \vdash \texttt{def} \; m:S' \rightarrow T <:^* \texttt{def} \; m:S'' \rightarrow T'$.
%\end{casethm}
%
%\begin{casethm}[\textsc{S-Decl-Type}]
%\begin{mathpar}
%\inferrule
%  {}
%  {\sigma = \texttt{type} \; L : S' .. U' \\
%  	\sigma' = \texttt{type} \; L : S'' .. U''}
%  	\and
%\inferrule
%  {\Gamma, (x : U); \Sigma \vdash S'' <: S' \\
%  	\Gamma, (x : U); \Sigma \vdash U' <: U''}
%  {\Gamma, (x : U); \Sigma \vdash \texttt{type} \; L : S' .. U' \; <:\; \texttt{type} \; L : S'' .. U''}
%\end{mathpar}
%Similar to the \textsc{S-Decl-Def} case, by the induction hypothesis, 
%if $\Gamma, (x : S); \Sigma \vdash S'' <:^* S'$ and
%$\Gamma, (x : S); \Sigma \vdash U' <:^* U''$ hold, it can be shown that 
%$\Gamma, (x : S); \Sigma \vdash \texttt{type} \; L : S' .. U' \; <:^* \; \texttt{type} \; L : S'' .. U''$ holds too.
%
%\end{casethm}
%
%\subsubsection*{\textsc {$\prec$-Narrowing*}:}
%
%\begin{casethm}[\textsc{E-Rec}]
%\begin{mathpar}
%\inferrule
%  {}
%  {T = \{z \Rightarrow \overline{\sigma}\}}
%  	\and
%\inferrule
%  {}
%  {\Gamma, (x : U); \Sigma \vdash 
%  		\{z \Rightarrow \overline{\sigma}\} \prec_z \overline{\sigma}}
%\end{mathpar}
%The base case for expansion follows immediately from \textsc{E-Rec}:
%$\Gamma, (x : S); \Sigma \vdash \{z \Rightarrow \overline{\sigma}\} \prec_z \overline{\sigma}$.
%\end{casethm}
%\begin{casethm}[\textsc{E-Select}]
%\begin{mathpar}
%\inferrule
%  {}
%  {T = p.L}
%  	\and
%\inferrule
%  {\Gamma, (x : U); \Sigma \vdash p \ni \texttt{type} \; L : S'..U' \\
%  	\Gamma, (x : U); \Sigma \vdash U' \prec_z \overline{\sigma}}
%  {\Gamma, (x : U); \Sigma \vdash p.L \prec_z \overline{\sigma}}
%\end{mathpar}
%By our mutual induction hypothesis we assume that
%\begin{mathpar}
%\inferrule
%  {\Gamma, (x : S); \Sigma \vdash p \ni \texttt{type} \; L : S''..U'', \;
%  	\texttt{type} \; L : S''..U'' <:^* \texttt{type} \; L : S'..U', \;
%  	U' \prec_z \overline{\sigma}', \;
%  	\overline{\sigma}' <:^* \overline{\sigma}}
%  {}
%\end{mathpar}
%holds. By \textsc{S-Decl-Type}, we can infer that 
%$\Gamma, (x : S); \Sigma \vdash U'' <:^* U'$. Using 
%Lemma \ref{lem:subtype:decl}, we can show that 
%$\exists \overline{\sigma}'': \Gamma, (x : S); \Sigma \vdash U'' \prec 
%\overline{\sigma}'', \; \overline{\sigma}'' <:^* \overline{\sigma}'$.
%Thus, we can show that 
%$\Gamma, (x : S); \Sigma \vdash \overline{\sigma}'' <:^* \overline{\sigma}$ 
%which completes the case.
%
%\hl{ToDo: U = $\bot$?}
%\end{casethm}
%\begin{casethm}[\textsc{E-Top}]
%\begin{mathpar}
%\inferrule
%  {}
%  {T = \top}
%  	\and
%\inferrule
%  {}
%  {\Gamma, (x : U); \Sigma \vdash \top \prec_z \varnothing}
%\end{mathpar}
%The \textsc{E-Top} base case resolves trivially. By 
%\textsc{E-Top}, $\Gamma, (x : S); \Sigma \vdash \top \prec_z \varnothing$.
%\end{casethm}
%
%\subsubsection*{\textsc {$\ni$-Narrowing*}:}
%
%\begin{casethm}[\textsc{M-Path}]
%\begin{mathpar}
%\inferrule
%  {}
%  {e = p \\
%  	\sigma = [p/z]\sigma_i}
%  	\and
%\inferrule
%  {\Gamma, (x : U); \Sigma \vdash p : T \\
%  	\Gamma, (x : U); \Sigma \vdash T \prec_z \overline{\sigma}\\
%  	\sigma_i \in \overline{\sigma}}
%  {\Gamma, (x : U); \Sigma \vdash p \ni [p/z]\sigma_i}
%\end{mathpar}
%From the mutually defined induction hypothesis, we assume 
%\begin{mathpar}
%\inferrule
%  {\Gamma, (x : S); \Sigma \vdash p : T', \; T' <:^* T \\
%  	\Gamma, (x : S); \Sigma \vdash T \prec_z \overline{\sigma}', \;
%  	\overline{\sigma}' <:^* \overline{\sigma}}
%  {}
%\end{mathpar}
%By Lemma \ref{lem:subtype:decl}, $\Gamma, (x : S); \Sigma \vdash T' \prec \overline{\sigma}''$ 
%and $\Gamma, (x : S); \Sigma \vdash \overline{\sigma}'' <:^* \overline{\sigma}'$. 
%We can now show that $\exists \sigma_i'' \in \overline{\sigma}'':
%\Gamma, (x : S); \Sigma \vdash \sigma_i'' <:^* \sigma_i$, and thus that 
%$\Gamma, (x : S); \Sigma \vdash [p/z]\sigma_i'' <:^* [p/z]\sigma_i$.
%
%\hl{ToDo: Show T' expanding \\ Substitution preserves subtype?}
%\end{casethm}
%\begin{casethm}[\textsc{M-Exp}]
%\begin{mathpar}
%\inferrule
%  {\Gamma, (x : U); \Sigma \vdash p : T \\
%  	\Gamma, (x : U); \Sigma \vdash T \prec_z \overline{\sigma}\\
%  	\sigma \in \overline{\sigma} \\
%  	z \notin \sigma}
%  {\Gamma, (x : U); \Sigma \vdash p \ni \sigma}
%\end{mathpar}
%We explicitly restrict the statement of the theorem to only include 
%membership of paths, as a result, this cases resolves as in \textsc{M-Path}.
%\end{casethm}
%
%\subsubsection*{\textsc {:-Narrowing*}:}
%
%\begin{casethm}[\textsc{T-Var}]
%\begin{mathpar}
%\inferrule
%  {}
%  {p = y \\
%  	T = \Gamma, (x : U)(y)}
%  	\and
%\inferrule
%  {y \in dom(\Gamma, (x : U))}
%  {	\Gamma, (y : U); \Sigma \vdash y : \Gamma(y)}
%\end{mathpar}
%\begin{itemize}
%\item[]  \textit{Subcase 1} ($y = x$):
%If $y = x$, then the result is immediate since by \textsc{T-Var} 
%$\Gamma,(x:S); \Sigma \vdash x : S$, and by assumption 
%$\Gamma; \Sigma \vdash S <: U$.
%\item[]  \textit{Subcase 2} ($y \neq x$):
%If $y \neq x$, then the type of $y$ remains the same and the result 
%is achieved by reflexivity.
%\end{itemize}
%\end{casethm}
%\begin{casethm}[\textsc{T-Loc}]
%\begin{mathpar}
%\inferrule
%  {}
%  {\Gamma; \Sigma \vdash T\; \texttt{<:}\; T}
%\end{mathpar}
%\hl{ToDo}
%\end{casethm}
%\begin{casethm}[\textsc{T-New}]
%\begin{mathpar}
%\inferrule
%  {}
%  {\Gamma; \Sigma \vdash T\; \texttt{<:}\; T}
%\end{mathpar}
%\hl{ToDo}
%\end{casethm}
%\begin{casethm}[\textsc{T-Meth}]
%\begin{mathpar}
%\inferrule
%  {}
%  {\Gamma; \Sigma \vdash T\; \texttt{<:}\; T}
%\end{mathpar}
%\hl{ToDo}
%\end{casethm}
%\begin{casethm}[\textsc{T-Acc}]
%\begin{mathpar}
%\inferrule
%  {}
%  {\Gamma; \Sigma \vdash T\; \texttt{<:}\; T}
%\end{mathpar}
%\hl{ToDo}
%\end{casethm}
%\begin{casethm}[\textsc{T-Type}]
%\begin{mathpar}
%\inferrule
%  {}
%  {\Gamma; \Sigma \vdash T\; \texttt{<:}\; T}
%\end{mathpar}
%\hl{ToDo}
%\end{casethm}
%\begin{casethm}[\textsc{T-Sub}]
%\begin{mathpar}
%\inferrule
%  {}
%  {\Gamma; \Sigma \vdash T\; \texttt{<:}\; T}
%\end{mathpar}
%\hl{ToDo}
%\end{casethm}
%\begin{casethm}[\textsc{T-Decl-Var}]
%\begin{mathpar}
%\inferrule
%  {}
%  {\Gamma; \Sigma \vdash T\; \texttt{<:}\; T}
%\end{mathpar}
%\hl{ToDo}
%\end{casethm}
%\begin{casethm}[\textsc{T-Decl-Def}]
%\begin{mathpar}
%\inferrule
%  {}
%  {\Gamma; \Sigma \vdash T\; \texttt{<:}\; T}
%\end{mathpar}
%\hl{ToDo}
%\end{casethm}
%\begin{casethm}[\textsc{T-Decl-Def}]
%\begin{mathpar}
%\inferrule
%  {}
%  {\Gamma; \Sigma \vdash T\; \texttt{<:}\; T}
%\end{mathpar}
%\hl{ToDo}
%\end{casethm}
%\end{proof}
%\qed
%
%\begin{theorem}[Environment Narrowing*]
%If $\Gamma_a, (x : U), \Gamma_b \vdash T <: T'$ and 
%   	$\Gamma_a \vdash S <: U$ then
%	$\Gamma_a, (x : S), \Gamma_b \vdash T <:^* T'$
%\end{theorem}
%\begin{proof}
%By induction on the derivation of $\Gamma_a, (z : U), \Gamma_b \vdash T <: T'$.
%\begin{casethm}[\textsc{S-Refl}]
%\begin{mathpar}
%\inferrule
%  {T = T'}
%  {}
%\end{mathpar}
%Trivial.
%\end{casethm}
%\begin{casethm}[\textsc{S-Rec}]
%\begin{mathpar}
%\inferrule
%  {T = \{z \Rightarrow \overline{\sigma}\} \\
%  	T' = \{z \Rightarrow \overline{\sigma}'\} \\
%  	\forall \sigma_i' \in \overline{\sigma}', \; \exists \; \sigma_i \in \overline{\sigma} \; st \; \Gamma_a, (x : U), \Gamma_b,(z : \{z \Rightarrow \overline{\sigma}\}) \vdash \sigma_i <:\; \sigma_i'}
%  {}
%\end{mathpar}
%Applying our induction hypotheses to the smaller derivation of 
%$\Gamma_a, (x : U), \Gamma_b,(z : \{z \Rightarrow \overline{\sigma}\}) 
%\vdash \sigma_i <:\; \sigma_i'$ for each $\sigma_i$ and $\sigma_i'$, 
%we can show that 
%$\Gamma_a, (x : S), \Gamma_b,(z : \{z \Rightarrow \overline{\sigma}\}) 
%\vdash \sigma_i <:^*\; \sigma_i'$.
%We can use this and \textsc{S-Rec} to construct a series of record types 
%such that $\Gamma_a, (x : S), \Gamma_b \vdash 
%\{z \Rightarrow \overline{\sigma}\} <: 
%\{z \Rightarrow \overline{\sigma}_0\} <: ...
%<: \{z \Rightarrow \overline{\sigma}_n\} <:
%\{z \Rightarrow \overline{\sigma}'\}$.
%i.e that 
%$\Gamma_a, (x : S), \Gamma_b \vdash 
%\{z \Rightarrow \overline{\sigma}\}\; <:^*\; 
%\{z \Rightarrow \overline{\sigma}'\}$.
%\end{casethm}
%\begin{casethm}[\textsc{S-Select-Upper}]
%\begin{mathpar}
%\inferrule
%  {T = p.L \\
%  	\Gamma_a, (x : U), \Gamma_b \vdash p \ni \texttt{type} \; L : S' .. U' \\
%  	\Gamma_a, (x : U), \Gamma_b \vdash S' <: U' \\
%  	\Gamma_a, (x : U), \Gamma_b \vdash U' <: T'}
%  {}
%\end{mathpar}
%\hl{It can be shown that 
%$\Gamma_a, (x : S), \Gamma_b \vdash p \ni \texttt{type} \; L : S'' .. U''$
%where 
%$\Gamma_a, (x : S), \Gamma_b \vdash S' <: S'' <: U'' <: U'$}.
%Further, by applying our induction hypothesis to the smaller 
%derivation of $\Gamma_a, (x : U), \Gamma_b \vdash U' <: T'$ 
%to get $\Gamma_a, (x : S), \Gamma_b \vdash U' <: T'$ we 
%we can construct the chain 
%$\Gamma_a, (x : S), \Gamma_b \vdash U'' <: U' <: T'$ 
%and thus by \textsc{S-Select-Upper} and 
%\textsc {S\textsuperscript{*}-Trans} that 
%$\Gamma_a, (x : S), \Gamma_b \vdash p.L <:^* T'$ completing the case.
%\end{casethm}
%\begin{casethm}[\textsc{S-Select-Lower}]
%\begin{mathpar}
%\inferrule
%  {T' = p.L \\
%  	\Gamma_a, (x : U), \Gamma_b \vdash p \ni \texttt{type} \; L : S' .. U' \\
%  	\Gamma_a, (x : U), \Gamma_b \vdash S' <: U' \\
%  	\Gamma_a, (x : U), \Gamma_b \vdash T <: S'}
%  {}
%\end{mathpar}
%\hl{TODO: Complete reasoning in similar manner as \textsc{S-Select-Upper}}
%\end{casethm}
%\begin{casethm}[\textsc{S-Top}]
%\begin{mathpar}
%\inferrule
%  {T' = \top}
%  {}
%\end{mathpar}
%Trivial.
%\end{casethm}
%\begin{casethm}[\textsc{S-Bottom}]
%\begin{mathpar}
%\inferrule
%  {T = \bot}
%  {}
%\end{mathpar}
%Trivial.
%\end{casethm}
%\begin{casethm}[\textsc{S-Decl-Var}]
%\begin{mathpar}
%\inferrule
%  {\sigma = \texttt{val} \; f:T \\
%  	\sigma' = \texttt{val} \; f:T}
%  {}
%\end{mathpar}
%Trivial.
%\end{casethm}
%\begin{casethm}[\textsc{S-Decl-Meth}]
%\begin{mathpar}
%\inferrule
%  {\sigma = \texttt{def} \; m:S \rightarrow T \\
%  	\sigma' = \texttt{def} \; m:S' \rightarrow T' \\
%  	\Gamma, (x : U), \Gamma_b \vdash T <: T' \\
%  	\Gamma, (x : U), \Gamma_b \vdash S' <: S}
%  {}
%\end{mathpar}
%Applying the induction hypothesis to the smaller derivations of 
%$\Gamma, (x : U), \Gamma_b \vdash T <: T'$ and
%$\Gamma, (x : U), \Gamma_b \vdash S' <: S$ we get 
%\begin{mathpar}
%\inferrule
%  {\Gamma, (x : S), \Gamma_b \vdash T <:^* T' \\
%  	\Gamma, (x : S), \Gamma_b \vdash S' <:^* S}
%  {}
%\end{mathpar}
%This means we can construct two subtype chains: 
%\begin{mathpar}
%\inferrule
%  {\Gamma, (x : S), \Gamma_b \vdash T <: T_0 <: ... <: T_m <: T' \\
%  	\Gamma, (x : S), \Gamma_b \vdash S' <: S_0 <: ... <: S_n <: S}
%  {}
%\end{mathpar}
%Using these we can construct a similar subtype chain 
%\begin{mathpar}
%\inferrule
%  {\Gamma, (x : S), \Gamma_b \vdash 
%\texttt{def} \; m:S \rightarrow T <: \texttt{def} \; m:S_n \rightarrow T_0 
%<: ... <: \texttt{def} \; m:S_0 \rightarrow T_m <: 
%\texttt{def} \; m:S' \rightarrow T'}
%  {}
%\end{mathpar}
%i.e. $\Gamma, (x : S), \Gamma_b \vdash 
%\texttt{def} \; m:S \rightarrow T <:^* 
%\texttt{def} \; m:S' \rightarrow T'$
%\end{casethm}
%\begin{casethm}[\textsc{S-Decl-Type}]
%\begin{mathpar}
%\inferrule
%  {\sigma = \texttt{type} \; L : S .. U \\
%  	\sigma' = \texttt{type} \; L : S' .. U' \\
%  	\Gamma, (x : U), \Gamma_b \vdash S' <: S \\
%  	\Gamma, (x : U), \Gamma_b \vdash U <: U'}
%  {}
%\end{mathpar}
%In a similar manner to the \emph{casethm} for \textsc{S-Decl-Meth}, we can use 
%the induction hypothesis to derive the following.
%\begin{mathpar}
%\inferrule
%  {\Gamma, (x : S), \Gamma_b \vdash S' <:^* S \\
%  	\Gamma, (x : S), \Gamma_b \vdash U <:^* U'}
%  {}
%\end{mathpar}
%Similarly we can derive the following subtype chains,
%\begin{mathpar}
%\inferrule
%  {\Gamma, (x : S), \Gamma_b \vdash S' <: S_0 <: ... <: S_m <: S \\
%  	\Gamma, (x : S), \Gamma_b \vdash U <: U_0 <: ... <: U_n <: U'}
%  {}
%\end{mathpar}
%and subsequently the following chain of declaration subtypes.
%\begin{mathpar}
%\inferrule
%  {\Gamma, (x : S), \Gamma_b \vdash 
%\texttt{type} \; L : S .. U <: \texttt{type} \; L : S_m .. U_0 
%<: ... <: \texttt{type} \; L : S_0 .. U_n <: 
%\texttt{type} \; L : S' .. U'}
%  {}
%\end{mathpar}
%This gives us the desired result: 
%$\Gamma, (x : S), \Gamma_b \vdash 
%\texttt{type} \; L : S .. U <:^* \texttt{type} \; L : S' .. U'$.
%\end{casethm}
%\end{proof}
%\qed

%---------------- Subtype Chain Construction ----------------%
\begin{lemma} \label{lem:subtype_chain}
If $\Gamma; \Sigma \vdash T \; \textbf{\tt{wf}}$ and 
	$\Gamma; \Sigma \vdash S <: T <: U$
	then we can construct a subtype sequence
   $\Gamma; \Sigma \vdash S <: T'_0 <: ... <: T'_m <: U$ such that
	$\forall i \in [0,m], T'_i \neq p.L$.
\end{lemma}
\begin{proof}
Proceed by case analysis on $T$.
\begin{casethm}[$T = \{z \Rightarrow \overline{\sigma}\}$]
%\begin{mathpar}
%\inferrule
%  {T = \{z \Rightarrow \overline{\sigma}\}}
%  {}
%  \and
%\inferrule
%  {\forall \sigma_i \in \overline{\sigma}, \; \Gamma,z:\{z \Rightarrow \overline{\sigma}\}; \Sigma \vdash \sigma_i \; \textbf{wf} \\
%  	\forall j \neq i, \; dom(\sigma_j) \neq dom(\sigma_i)}
%  {\Gamma; \Sigma \vdash \{z \Rightarrow \overline{\sigma}\} \; \textbf{wf}}
%\end{mathpar}
Records present a base case, and the result is immediate since 
by assumption we have 
$\Gamma; \Sigma \vdash S <: \{z \Rightarrow \overline{\sigma}\} <: U$ and 
$\{z \Rightarrow \overline{\sigma}\} \neq p.L$.
\end{casethm}
\begin{casethm}[$T = p.L$]
Since $p.L$ is \textbf{\texttt{wf}}, we have
\begin{mathpar}
%\inferrule
%  {T = p.L}
%  {}
%  \and
\inferrule
  {\Gamma; \Sigma \vdash p \ni \texttt{type} \; L : S' .. U' \\
  	\Gamma; \Sigma \vdash S' <: U'\\
  	\Gamma; \Sigma \vdash S', U' \; \textbf{wfe}}
  {\Gamma; \Sigma \vdash p.L \; \textbf{wf}}
\end{mathpar}
We begin by replacing $T$ with $S' <: U'$ to get the subtype sequence 
\begin{mathpar}
%\inferrule
%  {T = p.L}
%  {}
%  \and
\inferrule
  {\Gamma; \Sigma \vdash S <: S' <: U' <: U}
  {}
\end{mathpar}
Next we look at $S'$ and $U'$. If they are not selection types, we 
are done, otherwise we similarly replace them in the sequence with 
their bounds. We now need to show that the bounds themselves are 
terminating. Since we restrict $T$ to be both well-formed and 
expanding, we know that the bounds are by definition also well-formed 
and expanding. An expanding type implies a finite expansion, and thus 
each bound produces a finite sequence.

\hl{TODO: Explicit proof of finite expansion?}

\end{casethm}
\begin{casethm}[$T = \top$]
%\begin{mathpar}
%\inferrule
%  {T = \top}
%  {}
%  \and
%\inferrule
%  {\Gamma; \Sigma \vdash \top \;  \textbf{wf}}
%  {}
%\end{mathpar}
The top type represents a base case that follows immediately by assumption.
\end{casethm}
\begin{casethm}[$T = \bot$]
%\begin{mathpar}
%\inferrule
%  {T = \bot}
%  {}
%  \and
%\inferrule
%  {\Gamma; \Sigma \vdash \bot \;  \textbf{wf}}
%  {}
%\end{mathpar}
The bottom type represents a base case that follows immediately by assumption.
\end{casethm}
%\begin{casethm}[\textsc {WF-Val}]
%\begin{mathpar}
%\inferrule
%  {\Gamma; \Sigma \vdash T : \textbf{wf}}
%  {\Gamma; \Sigma \vdash \texttt{val} \; f:T \;  \textbf{wf}}
%\end{mathpar}
%\end{casethm}
%\begin{casethm}[\textsc {WF-Def}]
%\begin{mathpar}
%\inferrule
%  {\Gamma; \Sigma \vdash T : \textbf{wf} \\
%  	\Gamma; \Sigma \vdash S : \textbf{wf}}
%  {\Gamma; \Sigma \vdash \texttt{def} \; m:S \rightarrow T \;  \textbf{wf}}
%\end{mathpar}
%\end{casethm}
%\begin{casethm}[\textsc {WF-Type}]
%\begin{mathpar}
%\inferrule
%  {\Gamma; \Sigma \vdash S : \textbf{wfe} \; \vee \; S = \bot\\
%  	\Gamma; \Sigma \vdash U : \textbf{wfe} \\
%  	\Gamma; \Sigma \vdash S <: U}
%  {\Gamma; \Sigma \vdash \texttt{type} \; L : S .. U \; \textbf{wf}}
%\end{mathpar}
%\end{casethm}
\end{proof}
\qed

%We now show that for any chain of \texttt{wfe} types, $S <:^* U$,
%it's possible to construct a chain that contains no selection types.
%\begin{lemma} \label{lem:subtype_chain}
%If $\Gamma \vdash S, U \; \textbf{\tt{wfe}}$ where
%	$\Gamma \vdash S <:^* U$ then we can construct a subtype sequence
%	$\Gamma \vdash S <: T'_0 <: ... <: T'_m <: U$ such that 
%	$\forall i \in [0,m], T'_i \neq p.L$.
%\end{lemma}
%\begin{proof}
%By induction on the derivation of $\Gamma \vdash S <:^* U$.
%\begin{casethm}[\textsc {S\textsuperscript{*}-Refl}]
%\begin{mathpar}
%\inferrule
%  {U = S}
%  {}
%\end{mathpar}
%Trivial.
%\end{casethm}
%\begin{casethm}[\textsc {S\textsuperscript{*}-Trans}]
%\begin{mathpar}
%\inferrule
%  {\Gamma \vdash S \; <:^* \; T \\
%	\Gamma \vdash T \; <: \; U}
%  {}
%\end{mathpar}
%Applying the induction hypothesis to the smaller 
%derivation of $\Gamma \vdash S \; <:^* \; T$ we 
%can show that there exists a subtype sequence 
%$\Gamma \vdash S <: T_0 <: ... <: T_n <: T$ where 
%for all $i \in [0,n]$, $T_i \neq p.L$ for any $p$ and $L$.
%
%Now we need to show that we can derive a similar 
%sequence $\Gamma \vdash T_n <: T_{n+1} <: ... <: T_m <: U$ 
%to complete the sequence and replace $T$. To do this we 
%do a case analysis on the structure of $T$.
%\begin{itemize}
%\item[]  \textit{Subcase 1} ($\{z \Rightarrow \overline{\sigma}\}$):
%\begin{mathpar}
%\inferrule
%  {T = \{z \Rightarrow \overline{\sigma}\}}
%  {}
%\end{mathpar}
%Trivial.
%\item[]  \textit{Subcase 2} ($p.L$):
%\begin{mathpar}
%\inferrule
%  {T = p.L}
%  {}
%\end{mathpar}
%\hl{TODO}
%\item[]  \textit{Subcase 3} ($\top$):
%\begin{mathpar}
%\inferrule
%  {T = \top}
%  {}
%\end{mathpar}
%Trivial.
%\item[]  \textit{Subcase 4} ($\bot$):
%\begin{mathpar}
%\inferrule
%  {T = \bot}
%  {}
%\end{mathpar}
%\hl{TODO: Solve issue with expanding types and $\bot$}
%\end{itemize} 
%\end{casethm}
%\end{proof}
%\qed

%---------------------- Transitivity ----------------------%
Subtype Transitivity 

\begin{lemma}[Subtype Transitivity]\label{thm:trans}
If $\Gamma \vdash S <:^* U$ then
	$\Gamma \vdash S <: U$
\end{lemma}
\begin{proof}
Expand $\Gamma \vdash S <:^* U$ to the following chain:
\begin{mathpar}
\inferrule
  {\Gamma \vdash S <: T_0 <: ... <: T_n <: U}
  {}
\end{mathpar}
Now proceed by breaking the proof into two parts. First the case where 
$\forall i \in [0,n], T_i \neq p.L$. Secondly we show that if the chain 
does contain a selection type, we can construct another chain that contains 
no such selection type.
\begin{casethm}
Begin by induction on the derivation of $\Gamma \vdash S <:^* U$.
\begin{itemize}
\item[]  \textit{Subcase 1} (\textsc {S\textsuperscript{*}-Refl}):
Trivial.
\item[]  \textit{Subcase 2} (\textsc {S\textsuperscript{*}-Trans}):
\begin{mathpar}
\inferrule
  {\Gamma \vdash S <:^* T_n \\
  	\Gamma \vdash T_n <: U}
  {}
\end{mathpar}
Applying the induction hypothesis to the smaller derivation 
of $\Gamma \vdash S <:^* T$ we get $\Gamma \vdash S <: T$. 
This gives us the more traditional form of \emph{Subtype Transitivity}.
\begin{mathpar}
\inferrule
  {\Gamma \vdash S <: T \\
   	\Gamma \vdash T <: U}
  {\Gamma \vdash S <: U}
\end{mathpar}
We can now proceed by induction on the derivation of 
$\Gamma \vdash S <: T$ keeping in mind that we have restricted 
$T$ to only non-selection types (meaning \textsc{S-Select-Lower} 
is not considered).
\begin{itemize}
\item[]  \textit{Subsubcase 1} (\textsc {S-Refl}):
\begin{mathpar}
\inferrule
  {S = T}
  {}
\end{mathpar}
Trivial.
\item[]  \textit{Subsubcase 2} (\textsc {S-Rec}):
\begin{mathpar}
\inferrule
  {S =  \{z \Rightarrow \overline{\sigma}\} \\
  	T =  \{z \Rightarrow \overline{\sigma}'\}}
  {}
	\and
\inferrule
  {\forall \sigma_i' \in \overline{\sigma}', \; \exists \; \sigma_i \in \overline{\sigma} \; st \; \Gamma, z : \{z \Rightarrow \overline{\sigma}\}; \Sigma \vdash \sigma_i <:\; \sigma_i'}
  {\Gamma; \Sigma \vdash \{z \Rightarrow \overline{\sigma}\}\; <:\; \{z \Rightarrow \overline{\sigma}'\}}
\end{mathpar}
\hl{TODO: complete}
\item[]  \textit{Subsubcase 3} (\textsc {S-Select-Upper}):
\begin{mathpar}
\inferrule
  {S =  p.L \\
  	\Gamma \vdash p \ni \texttt{type} \; L : S' .. U'\\
  	\Gamma \vdash S' <: U' \\
  	\Gamma \vdash U' <: T}
  {}
\end{mathpar}
Applying the induction hypothesis to the smaller derivations 
$\Gamma \vdash U' <: T$ and $\Gamma \vdash T <: U$ we get $\Gamma \vdash U' <: U$. 
By \textsc{S-Select-Upper} is follows that $\Gamma \vdash S <: U$.
\item[]  \textit{Subsubcase 4} (\textsc {S-Top}):
\begin{mathpar}
\inferrule
  {T = \top}
  {}
\end{mathpar}
\hl{TODO: Show that if $\Gamma \vdash S <: T, S \prec \overline{\sigma}, 
T \prec \overline{\sigma}'$ then 
$\Gamma \vdash \overline{\sigma} <: \overline{\sigma}'$}\\
$\Gamma \vdash U \; \texttt{wfe} \Rightarrow
\exists \overline{\sigma}: \; \Gamma \vdash U \prec \overline{\sigma}$. 
Since $\Gamma \vdash \top \prec \varnothing$, it follows that 
for every declaration $\sigma \in \overline{\sigma}$, 
$\exists \sigma' \in \varnothing$. This implies that 
$\overline{\sigma} = \varnothing$, and subsequently that 
$U = \top$. The desired result follows immediately from \textsc{S-Top}.
\item[]  \textit{Subsubcase 5} (\textsc {S-Bottom}):
\begin{mathpar}
\inferrule
  {S = \bot}
  {}
\end{mathpar}
Trivial.
\end{itemize}
\end{itemize}
\end{casethm}
\begin{casethm}
In the case where our subtype chain $\Gamma \vdash S <:^* U$ 
contains a selection type, we can use Lemma \ref{lem:subtype_chain}
to construct one that does not. We can now apply our reasoning from the 
previous case to the new subtype chain to show that $\Gamma \vdash S <: U$.
\end{casethm}
\end{proof}
\qed

\newpage

\subsection{Subject Reduction}

\begin{lemma} \label{lem:path_type_preservation}
If $\Gamma; \Sigma \vdash v : T$, 
$\Sigma \vdash  \mu$ and $\mu \vdash v \leadsto l$ then 
$\Gamma; \Sigma \vdash l : T$.
\end{lemma}
\begin{proof}
By induction on the derivation of $\mu \vdash v \leadsto l$.
\begin{casethm}[\textsc{L-Loc}]
\begin{mathpar}
\inferrule
  {v = l}
  {}
  \and
\inferrule
  {}
  {\mu \vdash l \leadsto l}
\end{mathpar}
Trivial.
\end{casethm}
\begin{casethm}[\textsc{L-Type}]
\begin{mathpar}
  {v = v' \unlhd T}
  {}
  \and
\inferrule
  {\mu \vdash v' \leadsto l}
  {\mu \vdash v' \unlhd T \leadsto l}
\end{mathpar}
Since we know that $\Gamma; \Sigma \vdash v' \unlhd T: T$, 
by \textsc{T-Type} we can infer $\Gamma; \Sigma \vdash v' : T$.
By our induction hypothesis, we assume that if 
$\Gamma; \Sigma \vdash v' : T$ then 
$\Gamma; \Sigma \vdash l : T$. This completes the case.
\end{casethm}
\begin{casethm}[\textsc{L-Path}]
\begin{mathpar}
\inferrule
  {\mu \vdash v' \leadsto l' \\
	\mu(l') = \{z \Rightarrow ..., \texttt{val} f : T = l, ...\}}
  {\mu \vdash v'.f \leadsto l}
\end{mathpar}
By inversion on the derivation of $\Gamma; \Sigma \vdash v'.f : T$ we 
have 
\begin{mathpar}
\inferrule
  {	\Gamma; \Sigma \vdash v' : S \\
  	\Gamma; \Sigma \vdash v' \ni \texttt{val} \; f:T}
  {	\Gamma; \Sigma \vdash v'.f : T}
\end{mathpar}
By assumption $\Sigma \vdash \mu$, which implies $\varnothing; \Sigma 
\vdash l : T$. Environment weakening gives us 
$\Gamma; \Sigma \vdash l : T$
%And by our induction hypothesis we assume $\Gamma; \Sigma \vdash l' : S$.
\end{casethm}
\qed
\end{proof}

\newpage

%---------------------- Preservation ----------------------%
\begin{theorem}[Preservation]
If $\Gamma; \Sigma \vdash e : T$, 
   	$\mu \; | \; e \; \rightarrow \mu' \; | \; e'$ where
	$\Sigma \vdash \mu \; \tt{\bf{wf}}$ then 
 	$\exists \Sigma'$ s.t. 
	$\Sigma'$ extends $\Sigma$, 
	$\Sigma' \vdash \mu' \; \tt{\bf{wf}}$, 
	$\Gamma; \Sigma' \vdash e' : T$.
\end{theorem}
\begin{proof}
By induction on the derivation of $\mu \; | \; e \; \rightarrow \mu' \; | \; e'$.
\begin{casethm}[\textsc{R-New}]
 \begin{mathpar}
\inferrule
  {\mu \vdash \overline{d_v} \leadsto \overline{d} \\
  	l \notin dom(\mu) \\
  	\mu' = \mu, l \mapsto \{\texttt{z} \Rightarrow \overline{d}\}}
  {\mu \; | \; \texttt{new} \; \{\texttt{z} \Rightarrow \overline{d_v}\} \; \rightarrow \mu' \; | \; l}
	\and
\inferrule
	{\Gamma, z : \{z \Rightarrow \overline{\sigma}\}; \Sigma 
	\vdash \overline{d_v} : \overline{\sigma} \\
	y \notin dom(\Gamma)}
	{\Gamma; \Sigma\vdash \texttt{new} \; \{z \Rightarrow \overline{d_v}\} : 
	\{z \Rightarrow \overline{\sigma}\}}
\end{mathpar}
Let $\Sigma' = \Sigma, (l:\{z \Rightarrow \overline{\sigma}\})$.
By Lemma \ref{lem:path_type_preservation}, we can show that 
$\Gamma; \Sigma' \vdash \{\texttt{z} \Rightarrow \overline{d}\} :
\{z \Rightarrow \overline{\sigma}\}$. Thus by \textsc{T-Loc} we get the result 
$\Gamma; \Sigma' \vdash l : \{z \Rightarrow \overline{\sigma}\}$.
\end{casethm}

\begin{casethm}[\textsc{R-Meth}]
\begin{mathpar}
\inferrule
  {\mu \vdash v_1 \leadsto l \\
  	\mu(l) = \{\texttt{z} \Rightarrow ...,m:T(x:S)=e,...\}}
  {\mu \; | \; v_1.m_U(v_2) \;\rightarrow \mu \; | \; [v_1/z,v_2 \unlhd S/x]e \unlhd U}
	\and
\inferrule
  {\Gamma; \Sigma \vdash v_1 \ni \texttt{def} \; m:S' \rightarrow T' \\
  	\Gamma; \Sigma \vdash v_1 : T_1 \\
  	\Gamma; \Sigma \vdash v_2 : S' \\
  	\Gamma; \Sigma \vdash T' <: U}
  {	\Gamma; \Sigma \vdash v_1.m_U(v_2) : U}
\end{mathpar}
By Lemma \ref{lem:path_type_preservation} we know that 
$\Gamma; \Sigma \vdash l : T_1$. From Lemma \ref{lem:subtype:decl} 
we can show that $\Gamma; \Sigma \vdash [v_1/z](\texttt{def} \; m:S \rightarrow T) <:
\texttt{def} \; m:S' \rightarrow T'$ which implies 
$\Gamma; \Sigma \vdash [v_1/z] T <: T'$. Since 
$\Gamma; \Sigma \vdash e : T$, by Lemma \ref{lem:subst} 
we get $\Gamma; \Sigma \vdash [v_1/z,v_2 \unlhd S/x]e : [v_1/z,v_2 \unlhd S/x]T$.
Since $T$ is well-formed in the absence of $x$, 
$[v_1/z,v_2 \unlhd S/x]T = [v_1/z]T$. Thus we get 
$\Gamma; \Sigma \vdash [v_1/z,v_2 \unlhd S/x]e : [v_1/z]T$, and by 
\textsc{T-Sub} we have 
$\Gamma; \Sigma \vdash [v_1/z,v_2 \unlhd S/x]e : T'$ and subsequently 
$\Gamma; \Sigma \vdash [v_1/z,v_2 \unlhd S/x]e : U$. 
Now, let $\Sigma' = \Sigma$, and by \textsc{T-Type} 
we have $\Gamma; \Sigma' \vdash [v_1/z,v_2 \unlhd S/x]e \unlhd U : U$

\end{casethm}
\begin{casethm}[\textsc{R-Context}]
\begin{mathpar}
\inferrule
  {	\mu \; | \; e \; \rightarrow \; \mu' \; | \; e'}
  {\mu \; | \; E[e] \; \rightarrow \mu' \; | \; E[e']}
\end{mathpar}
By case analysis on $E[e]$.
\begin{subcase}[$\mu \; | \; e.m_U(e_S) \; \rightarrow \mu' \; | \; e'.m_U(e_S)$]
\begin{mathpar}
\inferrule
  {\Gamma; \Sigma \vdash e \ni \texttt{def} \; m:S' \rightarrow T' \\
  	\Gamma; \Sigma \vdash e : T \\
  	\Gamma; \Sigma \vdash e_S : S' \\
  	\Gamma; \Sigma \vdash T' <: U}
  {	\Gamma; \Sigma \vdash e.m_U(e_S) : U}
\end{mathpar}
By our induction hypothesis we assume 
$\Gamma; \Sigma' \vdash e' : T$. We now need to investigate 
method membership for $e'$. Since $e$ reduces to $e'$, we can be
sure that $e$ is not a path. By inversion on 
$\Gamma; \Sigma \vdash e \ni \texttt{def} \; m:S' \rightarrow T'$ it
follows that since $e$ is not a path, $z \notin \texttt{def} \; m:S' \rightarrow T'$. 
Thus $\Gamma; \Sigma' \vdash e' \ni \texttt{def} \; m:S' \rightarrow T'$, since 
no substitution is required. By simple weakening of the store type (\hl{TODO?})
the following hold.
\begin{mathpar}
\inferrule
  {\Gamma; \Sigma' \vdash e_S : S' \\
  	\Gamma; \Sigma' \vdash T' <: U}
  {}
\end{mathpar}
By \textsc{T-Meth} we have $\Gamma; \Sigma' \vdash e.m_U(e_S) : U$
\end{subcase}

\begin{subcase}[$\mu \; | \; p.m_U(e) \; \rightarrow \mu' \; | \; p.m_U(e')$]
\begin{mathpar}
\inferrule
  {\Gamma; \Sigma \vdash p \ni \texttt{def} \; m:S \rightarrow T \\
  	\Gamma; \Sigma \vdash p : T_p \\
  	\Gamma; \Sigma \vdash e : S \\
  	\Gamma; \Sigma \vdash T <: U}
  {	\Gamma; \Sigma \vdash p.m_U(e) : U}
\end{mathpar}
By our induction hypothesis we assume 
$\exists \Sigma' : \Gamma; \Sigma \vdash e : S$, where 
$\Sigma'$ extends $\Sigma$. By simple weakening of the store type (\hl{TODO?})
we get
\begin{mathpar}
\inferrule
  {\Gamma; \Sigma' \vdash p \ni \texttt{def} \; m:S \rightarrow T \\
  	\Gamma; \Sigma' \vdash p : T_p \\
  	\Gamma; \Sigma' \vdash T <: U}
  {}
\end{mathpar}
Thus by 
\textsc{T-Meth}, $\Gamma; \Sigma' \vdash p.m_U(e') : U$
\end{subcase}

\begin{subcase}[$\mu \; | \; e.f \; \rightarrow \mu' \; | \; e'.f$]
\begin{mathpar}
\inferrule
  {	\Gamma; \Sigma \vdash e : S \\
  	\Gamma; \Sigma \vdash e \ni \texttt{val} \; f:T}
  {	\Gamma; \Sigma \vdash e.f : T}
\end{mathpar}
By our induction hypothesis we assume $\Gamma; \Sigma \vdash e' : S$. 
Since $e$ reduces to $e'$ it follows that $e$ is not a path. By inversion 
on the derivation of $\Gamma; \Sigma \vdash e \ni \texttt{val} \; f:T$, 
$z \notin \texttt{val} \; f:T$, and it follows that 
$\Gamma; \Sigma' \vdash e' \ni \texttt{val} \; f:T$. Now, by \textsc{T-Field} 
we have $\Gamma; \Sigma' \vdash e'.f : S$
\end{subcase}

\begin{subcase}[$\mu \; | \; e \unlhd T \; \rightarrow \mu' \; | \; e' \unlhd T$]
\begin{mathpar}
\inferrule
  {	\Gamma; \Sigma \vdash e : T}
  {	\Gamma; \Sigma \vdash e \unlhd T : T}
\end{mathpar}
By our induction hypothesis we assume $\Gamma; \Sigma' \vdash e' : T$. 
Now by the simple application of \textsc{T-Type} we have 
$\Gamma; \Sigma' \vdash e' \unlhd : T$
\end{subcase}

\end{casethm}
\end{proof}
\qed

\newpage

%---------------------- Progress ----------------------%
\subsection{Progress}
\begin{theorem}[Progress]
If $\Gamma \vdash e : T$, then either
\begin{enumerate}
\item e is a value, or
\item $\forall \mu$ s.t.
		   $\Gamma \vdash \mu$,
         $\exists e'$ and $\mu'$ s.t. 
         $\mu \; | \; e \; \rightarrow \mu' \; | \; e'$
\end{enumerate}
\end{theorem}
\qed 

\newpage

%---------------------- Preservation ----------------------%
\begin{theorem}[Preservation]
If $\Gamma; \Sigma \vdash e : T$, 
   	$\mu \; | \; e \; \rightarrow \mu' \; | \; e'$ where
	$\Sigma \vdash \mu \; \tt{\bf{wf}}$ then 
 	$\exists \Sigma'$ s.t. 
	$\Sigma'$ extends $\Sigma$, 
	$\Sigma' \vdash \mu' \; \tt{\bf{wf}}$, 
	$\Gamma; \Sigma' \vdash e' : T$.
\end{theorem}
\begin{proof}
By induction on the derivation of $\mu \; | \; e \; \rightarrow \mu' \; | \; e'$.
\begin{casethm}[\textsc{R-New}]
 \begin{mathpar}
\inferrule
  {\mu \vdash \overline{d_v} \leadsto \overline{d} \\
  	l \notin dom(\mu) \\
  	\mu' = \mu, l \mapsto \{\texttt{z} \Rightarrow \overline{d}\}}
  {\mu \; | \; \texttt{new} \; \{\texttt{z} \Rightarrow \overline{d_v}\} \; \rightarrow \mu' \; | \; l}
	\and
\inferrule
	{\Gamma, z : \{z \Rightarrow \overline{\sigma}\}; \Sigma 
	\vdash \overline{d_v} : \overline{\sigma} \\
	y \notin dom(\Gamma)}
	{\Gamma; \Sigma\vdash \texttt{new} \; \{z \Rightarrow \overline{d_v}\} : 
	\{z \Rightarrow \overline{\sigma}\}}
\end{mathpar}
Let $\Sigma' = \Sigma, (l:\{z \Rightarrow \overline{\sigma}\})$.
By Lemma \ref{lem:path_type_preservation}, we can show that 
$\Gamma; \Sigma' \vdash \{\texttt{z} \Rightarrow \overline{d}\} :
\{z \Rightarrow \overline{\sigma}\}$. Thus by \textsc{T-Loc} we get the result 
$\Gamma; \Sigma' \vdash l : \{z \Rightarrow \overline{\sigma}\}$.
\end{casethm}

\begin{casethm}[\textsc{R-Meth}]
\begin{mathpar}
\inferrule
  {\mu \vdash v_1 \leadsto l \\
  	\mu(l) = \{\texttt{z} \Rightarrow ...,m:T(x:S)=e,...\}}
  {\mu \; | \; v_1.m_U(v_2) \;\rightarrow \mu \; | \; [v_1/z,v_2 \unlhd S/x]e \unlhd U}
	\and
\inferrule
  {\Gamma; \Sigma \vdash v_1 \ni \texttt{def} \; m:S' \rightarrow T' \\
  	\Gamma; \Sigma \vdash v_1 : T_1 \\
  	\Gamma; \Sigma \vdash v_2 : S' \\
  	\Gamma; \Sigma \vdash T' <: U}
  {	\Gamma; \Sigma \vdash v_1.m_U(v_2) : U}
\end{mathpar}
By Lemma \ref{lem:path_type_preservation} we know that 
$\Gamma; \Sigma \vdash l : T_1$. From Lemma \ref{lem:subtype:decl} 
we can show that $\Gamma; \Sigma \vdash [v_1/z](\texttt{def} \; m:S \rightarrow T) <:
\texttt{def} \; m:S' \rightarrow T'$ which implies 
$\Gamma; \Sigma \vdash [v_1/z] T <: T'$. Since 
$\Gamma; \Sigma \vdash e : T$, by Lemma \ref{lem:subst} 
we get $\Gamma; \Sigma \vdash [v_1/z,v_2 \unlhd S/x]e : [v_1/z,v_2 \unlhd S/x]T$.
Since $T$ is well-formed in the absence of $x$, 
$[v_1/z,v_2 \unlhd S/x]T = [v_1/z]T$. Thus we get 
$\Gamma; \Sigma \vdash [v_1/z,v_2 \unlhd S/x]e : [v_1/z]T$, and by 
\textsc{T-Sub} we have 
$\Gamma; \Sigma \vdash [v_1/z,v_2 \unlhd S/x]e : T'$ and subsequently 
$\Gamma; \Sigma \vdash [v_1/z,v_2 \unlhd S/x]e : U$. 
Now, let $\Sigma' = \Sigma$, and by \textsc{T-Type} 
we have $\Gamma; \Sigma' \vdash [v_1/z,v_2 \unlhd S/x]e \unlhd U : U$

\end{casethm}
\begin{casethm}[\textsc{R-Context}]
\begin{mathpar}
\inferrule
  {	\mu \; | \; e \; \rightarrow \; \mu' \; | \; e'}
  {\mu \; | \; E[e] \; \rightarrow \mu' \; | \; E[e']}
\end{mathpar}
By case analysis on $E[e]$.
\begin{subcase}[$\mu \; | \; e.m_U(e_S) \; \rightarrow \mu' \; | \; e'.m_U(e_S)$]
\begin{mathpar}
\inferrule
  {\Gamma; \Sigma \vdash e \ni \texttt{def} \; m:S' \rightarrow T' \\
  	\Gamma; \Sigma \vdash e : T \\
  	\Gamma; \Sigma \vdash e_S : S' \\
  	\Gamma; \Sigma \vdash T' <: U}
  {	\Gamma; \Sigma \vdash e.m_U(e_S) : U}
\end{mathpar}
By our induction hypothesis we assume 
$\Gamma; \Sigma' \vdash e' : T$. We now need to investigate 
method membership for $e'$. Since $e$ reduces to $e'$, we can be
sure that $e$ is not a path. By inversion on 
$\Gamma; \Sigma \vdash e \ni \texttt{def} \; m:S' \rightarrow T'$ it
follows that since $e$ is not a path, $z \notin \texttt{def} \; m:S' \rightarrow T'$. 
Thus $\Gamma; \Sigma' \vdash e' \ni \texttt{def} \; m:S' \rightarrow T'$, since 
no substitution is required. By simple weakening of the store type (\hl{TODO?})
the following hold.
\begin{mathpar}
\inferrule
  {\Gamma; \Sigma' \vdash e_S : S' \\
  	\Gamma; \Sigma' \vdash T' <: U}
  {}
\end{mathpar}
By \textsc{T-Meth} we have $\Gamma; \Sigma' \vdash e.m_U(e_S) : U$
\end{subcase}

\begin{subcase}[$\mu \; | \; p.m_U(e) \; \rightarrow \mu' \; | \; p.m_U(e')$]
\begin{mathpar}
\inferrule
  {\Gamma; \Sigma \vdash p \ni \texttt{def} \; m:S \rightarrow T \\
  	\Gamma; \Sigma \vdash p : T_p \\
  	\Gamma; \Sigma \vdash e : S \\
  	\Gamma; \Sigma \vdash T <: U}
  {	\Gamma; \Sigma \vdash p.m_U(e) : U}
\end{mathpar}
By our induction hypothesis we assume 
$\exists \Sigma' : \Gamma; \Sigma \vdash e : S$, where 
$\Sigma'$ extends $\Sigma$. By simple weakening of the store type (\hl{TODO?})
we get
\begin{mathpar}
\inferrule
  {\Gamma; \Sigma' \vdash p \ni \texttt{def} \; m:S \rightarrow T \\
  	\Gamma; \Sigma' \vdash p : T_p \\
  	\Gamma; \Sigma' \vdash T <: U}
  {}
\end{mathpar}
Thus by 
\textsc{T-Meth}, $\Gamma; \Sigma' \vdash p.m_U(e') : U$
\end{subcase}

\begin{subcase}[$\mu \; | \; e.f \; \rightarrow \mu' \; | \; e'.f$]
\begin{mathpar}
\inferrule
  {	\Gamma; \Sigma \vdash e : S \\
  	\Gamma; \Sigma \vdash e \ni \texttt{val} \; f:T}
  {	\Gamma; \Sigma \vdash e.f : T}
\end{mathpar}
By our induction hypothesis we assume $\Gamma; \Sigma \vdash e' : S$. 
Since $e$ reduces to $e'$ it follows that $e$ is not a path. By inversion 
on the derivation of $\Gamma; \Sigma \vdash e \ni \texttt{val} \; f:T$, 
$z \notin \texttt{val} \; f:T$, and it follows that 
$\Gamma; \Sigma' \vdash e' \ni \texttt{val} \; f:T$. Now, by \textsc{T-Field} 
we have $\Gamma; \Sigma' \vdash e'.f : S$
\end{subcase}

\begin{subcase}[$\mu \; | \; e \unlhd T \; \rightarrow \mu' \; | \; e' \unlhd T$]
\begin{mathpar}
\inferrule
  {	\Gamma; \Sigma \vdash e : T}
  {	\Gamma; \Sigma \vdash e \unlhd T : T}
\end{mathpar}
By our induction hypothesis we assume $\Gamma; \Sigma' \vdash e' : T$. 
Now by the simple application of \textsc{T-Type} we have 
$\Gamma; \Sigma' \vdash e' \unlhd : T$
\end{subcase}

\end{casethm}
\end{proof}
\qed

\newpage

\begin{lemma}[Subtype Transitivity]\label{thm:trans}
If $\varnothing; \Sigma; \Gamma_1 \vdash S <: T \dashv \Gamma_2$ and
   $\varnothing; \Sigma; \Gamma_2 \vdash T <: U \dashv \Gamma_3$ then
	$\varnothing; \Sigma; \Gamma_1 \vdash S <: U \dashv \Gamma_3$.
\end{lemma}
\begin{proof}
By structural induction on 
$\varnothing; \Sigma; \Gamma_1 \vdash S <: T \dashv \Gamma_2$.
\begin{casethm}[\textsc{S-Refl}]
\begin{mathpar}
\inferrule
  {}
  {\varnothing; \Sigma; \Gamma \vdash T\; \texttt{<:}\; T \dashv \Gamma}
\end{mathpar}
Trivial.
\end{casethm}

\begin{casethm}[\textsc{S-Assume}]
\begin{mathpar}
\inferrule
  {(S <: T) \in \varnothing}
  {\varnothing; \Sigma; \Gamma_1 \vdash S\; \texttt{<:}\; T \dashv \Gamma_2}
\end{mathpar}
Trivial.
\end{casethm}

\begin{casethm}[\textsc{S-Rec}]
\begin{mathpar}
\inferrule
  {A' = \varnothing,(\{z \Rightarrow \overline{\sigma}\} <: \{z \Rightarrow \overline{\sigma}'\})\\
  	A'; \Sigma; \Gamma_1, z : \{z \Rightarrow \overline{\sigma}\} \vdash \overline{\sigma} <:\; \overline{\sigma}'  \dashv \Gamma_2, z : \{z \Rightarrow \overline{\sigma}'\}}
  {\varnothing; \Sigma; \Gamma_1 \vdash \{z \Rightarrow \overline{\sigma}\}\; <:\; \{z \Rightarrow \overline{\sigma}'\}\dashv \Gamma_2}
\end{mathpar}
\end{casethm}

\begin{casethm}[\textsc{S-Select-Refl}]
\begin{mathpar}
\inferrule
  {\varnothing; \Sigma; \Gamma_1 \vdash p \ni \texttt{type} \; L : S_1 .. U_1\\
  	\varnothing; \Sigma; \Gamma_2 \vdash p \ni \texttt{type} \; L : S_2 .. U_2\\
  	\varnothing; \Sigma; \Gamma_2 \vdash S_2 \; \texttt{<:}\; S_1 \dashv \Gamma_1 \\
  	\varnothing; \Sigma; \Gamma_1 \vdash U_1 \; \texttt{<:}\; U_2 \dashv \Gamma_2}
  {\varnothing; \Sigma; \Gamma_1 \vdash p.L \; \texttt{<:}\; p.L \dashv \Gamma_2}
\end{mathpar}
\end{casethm}

\begin{casethm}[\textsc{S-Select-Upper}]
\begin{mathpar}
\inferrule
  {\varnothing; \Sigma; \Gamma_1 \vdash p \ni \texttt{type} \; L : S .. U\\
  	\varnothing; \Sigma; \Gamma_1 \vdash S <: U \dashv \Gamma_1 \\
  	\varnothing; \Sigma; \Gamma_1 \vdash U <: U' \dashv \Gamma_2}
  {\varnothing; \Sigma; \Gamma_1 \vdash p.L\; <:\; U' \dashv \Gamma_2}
\end{mathpar}
\end{casethm}

\begin{casethm}[\textsc{S-Select-Lower}]
\begin{mathpar}
\inferrule
  {\varnothing; \Sigma; \Gamma_2 \vdash p \ni \texttt{type} \; L : S .. U \\
  	\varnothing; \Sigma; \Gamma_2 \vdash S <: U \dashv \Gamma_2 \\
  	\varnothing; \Sigma; \Gamma_1 \vdash S' <: S \dashv \Gamma_2}
  {\varnothing; \Sigma; \Gamma_1 \vdash S'\; <:\; p.L \dashv \Gamma_2}
\end{mathpar}
\end{casethm}

\begin{casethm}[\textsc{S-Top}]
\begin{mathpar}
\inferrule
  {}
  {\varnothing; \Sigma; \Gamma_1 \vdash T\; \texttt{<:}\; \top \dashv \Gamma_2}
\end{mathpar}
Trivial?
\end{casethm}

\begin{casethm}[\textsc{S-Bottom}]
\begin{mathpar}
\inferrule
  {}
  {\varnothing; \Sigma; \Gamma_1 \vdash \bot\; \texttt{<:}\; T \dashv \Gamma_2}
\end{mathpar}
Trivial.
\end{casethm}

\end{proof}
\qed

\newpage

\begin{lemma} \label{lem:path_type_preservation}
If $\varnothing; \Sigma; \Gamma \vdash v : T$, 
$\Sigma \vdash  \mu$ and $\mu \vdash v \leadsto l$ then 
$\varnothing; \Sigma; \Gamma \vdash l : S$ where
$\varnothing; \Sigma; \Gamma \vdash S <: T \dashv \Gamma$.
\end{lemma}
\begin{proof}
By induction on the derivation of $\mu \vdash v \leadsto l$.
\begin{casethm}[\textsc{L-Loc}]
\begin{mathpar}
\inferrule
  {v = l}
  {}
  \and
\inferrule
  {}
  {\mu \vdash l \leadsto l}
\end{mathpar}
Trivial.
\end{casethm}
\begin{casethm}[\textsc{L-Type}]
\begin{mathpar}
  {v = v' \unlhd T}
  {}
  \and
\inferrule
  {\mu \vdash v' \leadsto l}
  {\mu \vdash v' \unlhd T \leadsto l}
\end{mathpar}
Since we know that $\varnothing; \Sigma; \Gamma \vdash v' \unlhd T: T$, 
by \textsc{T-Type} we can infer $\varnothing; \Sigma; \Gamma \vdash v' : S'$ 
and $\varnothing; \Sigma; \Gamma \vdash S' <: T \dashv \Gamma$.
By our induction hypothesis, we assume that if 
$\varnothing; \Sigma; \Gamma \vdash v' : S'$ then 
$\varnothing; \Sigma; \Gamma \vdash l : S$, where 
$\varnothing; \Sigma; \Gamma \vdash S <: S' \dashv \Gamma$.
By \hl{Subtype Transitivity} we have 
$\varnothing; \Sigma; \Gamma \vdash S <: T \dashv \Gamma$.
\end{casethm}
\begin{casethm}[\textsc{L-Path}]
\begin{mathpar}
\inferrule
  {\mu \vdash v' \leadsto l' \\
	\mu(l') = \{z \Rightarrow ..., \texttt{val} f : T = l, ...\}}
  {\mu \vdash v'.f \leadsto l}
\end{mathpar}
By inversion on the derivation of $\Gamma; \Sigma \vdash v'.f : T$ we 
have 
\begin{mathpar}
\inferrule
  {	\varnothing; \Sigma; \Gamma \vdash v' : S \\
  	\varnothing; \Sigma; \Gamma \vdash v' \ni \texttt{val} \; f:T}
  {	\varnothing; \Sigma; \Gamma \vdash v'.f : T}
\end{mathpar}
By assumption $\Sigma \vdash \mu$, which implies $\varnothing; \Sigma; \varnothing 
\vdash l : S$, where 
$\varnothing; \Sigma; \varnothing \vdash S <: S' \dashv \varnothing$. 
Environment weakening gives us 
$\varnothing; \Sigma; \Gamma \vdash l : T$
and $\varnothing; \Sigma; \Gamma \vdash S <: S' \dashv \Gamma$
\end{casethm}
\qed
\end{proof}

\newpage

Now we present the proof for expression substitution. 
During method call reduction we need to substitute 
method parameters with arguments into the method body.
We want the
substitution of paths to maintain the expression 
typing relation. That is, if $e$ has type $T$, then 
$[p\unlhd U/x]e$ has type $[p\unlhd U/x]T$, where $U$ is 
the type of $x$ in the current environment.
Since types may contain 
variables as part of a selection type we must also 
perform a substitution on the environment and the assumption context. 
The full lemma is stated below.
\begin{mathpar}
\inferrule
  {A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash e : T \\
  	x \notin \, \Gamma_1\\
  	A; \Sigma; \Gamma_1 \vdash p : S \\
  	A; \Sigma; \Gamma_1 \vdash S <: U \dashv \Gamma_1}
  {[p \unlhd U/x]A; \Sigma; , \Gamma_1, [p \unlhd U/x]\Gamma_2 \vdash [p \unlhd U/x]e : [p \unlhd U/x]T}
  \quad (\textsc {$:$ - Substitution})
\end{mathpar}
If we have an expression $e$ that has type $T$ in an environment
containing a variable $x$ of type $U$, then the substitution 
of a path $p$ of the appropriate type maintains the 
typing relation assuming the correct substitutions 
are made in the environment and assumption context.
We make the restriction that $p$ be well-typed in the 
absence of $x$. Since the typing relation is defined in a mutually 
dependent manner with the subtyping, membership and 
expansion relations, we must perform a mutual induction
on these relations. We now need to construct a similar 
lemma for each of these relations.
\begin{mathpar}
\inferrule
  {A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash T <: T' \dashv\Gamma_1, (x : U), \Gamma_2' \\
  	x \notin \, \Gamma_1\\\\
  	A; \Sigma; \Gamma_1 \vdash p : S \\
  	A; \Sigma; \Gamma_1 \vdash S <: U \dashv \Gamma_1}
  {[p \unlhd U/x]A; \Sigma; , \Gamma_1, [p \unlhd U/x]\Gamma_2 \vdash [p \unlhd U/x]T <: [p \unlhd U/x]T' \dashv \Gamma_1, [p \unlhd U/x]\Gamma_2'}
  \quad (\textsc {$<:$ - Substitution})
  \and
\inferrule
  {A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash e \ni \sigma \\
  	x \notin \, \Gamma_1\\
  	A; \Sigma; \Gamma_1 \vdash p : S \\
  	A; \Sigma; \Gamma_1 \vdash S <: U \dashv \Gamma_1}
  {[p \unlhd U/x]A; \Sigma; , \Gamma_1, [p \unlhd U/x]\Gamma_2 \vdash [p \unlhd U/x]e \ni [p \unlhd U/x]\sigma}
  \quad (\textsc {$\ni$ - Substitution})
  \and
\inferrule
  {A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash T \prec_z \overline{\sigma} \\
  	x \notin \, \Gamma_1\\
  	A; \Sigma; \Gamma_1 \vdash p : S \\
  	A; \Sigma; \Gamma_1 \vdash S <: U \dashv \Gamma_1}
  {[p \unlhd U/x]A; \Sigma; , \Gamma_1, [p \unlhd U/x]\Gamma_2 \vdash [p \unlhd U/x]T \prec_z [p \unlhd U/x]\overline{\sigma}}
  \quad (\textsc {$\prec$ - Substitution})
\end{mathpar}
Each of these lemmas is just a similar statement of expression 
substitution for each relation. The only major difference is 
for \textsc{$<:$ - Substitution}. Since we work with a double 
headed subtyping relation that maintains two environments, 
we have two different environments in the statement of this
lemma. While we don't use different environments in any other 
parts of the type system, this is done for the purposes of 
induction that can be seen in case \ref{case:subst:s-rec} below.

\begin{lemma}[Expression Substitution]\label{lem:subst}
\begin{mathpar}
\inferrule
  {A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash e : T \\
  	x \notin \, \Gamma_1\\
  	A; \Sigma; \Gamma_1 \vdash p : S \\
  	A; \Sigma; \Gamma_1 \vdash S <: U \dashv \Gamma_1}
  {[p \unlhd U/x]A; \Sigma; , \Gamma_1, [p \unlhd U/x]\Gamma_2 \vdash [p \unlhd U/x]e : [p \unlhd U/x]T}
  \quad (\textsc {$:$ - Substitution})
  \and
\inferrule
  {A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash T <: T' \dashv\Gamma_1, (x : U), \Gamma_2' \\
  	x \notin \, \Gamma_1\\\\
  	A; \Sigma; \Gamma_1 \vdash p : S \\
  	A; \Sigma; \Gamma_1 \vdash S <: U \dashv \Gamma_1}
  {[p \unlhd U/x]A; \Sigma; , \Gamma_1, [p \unlhd U/x]\Gamma_2 \vdash [p \unlhd U/x]T <: [p \unlhd U/x]T' \dashv \Gamma_1, [p \unlhd U/x]\Gamma_2'}
  \quad (\textsc {$<:$ - Substitution})
  \and
\inferrule
  {A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash e \ni \sigma \\
  	x \notin \, \Gamma_1\\
  	A; \Sigma; \Gamma_1 \vdash p : S \\
  	A; \Sigma; \Gamma_1 \vdash S <: U \dashv \Gamma_1}
  {[p \unlhd U/x]A; \Sigma; , \Gamma_1, [p \unlhd U/x]\Gamma_2 \vdash [p \unlhd U/x]e \ni [p \unlhd U/x]\sigma}
  \quad (\textsc {$\ni$ - Substitution})
  \and
\inferrule
  {A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash T \prec_z \overline{\sigma} \\
  	x \notin \, \Gamma_1\\
  	A; \Sigma; \Gamma_1 \vdash p : S \\
  	A; \Sigma; \Gamma_1 \vdash S <: U \dashv \Gamma_1}
  {[p \unlhd U/x]A; \Sigma; , \Gamma_1, [p \unlhd U/x]\Gamma_2 \vdash [p \unlhd U/x]T \prec_z [p \unlhd U/x]\overline{\sigma}}
  \quad (\textsc {$\prec$ - Substitution})
\end{mathpar}
\end{lemma}
\begin{proof}
By structural induction on 
$\varnothing; \Sigma; \Gamma, (x : U) \vdash e : T$.
\begin{casethm}[\textsc{T-Var}]
\begin{mathpar}
\inferrule
  {e = y \\
  	T = \Gamma(y)}
  {}
  \and
\inferrule
  {y \in dom(\Gamma_1, (x : U), \Gamma_2)}
  {	A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash y : \Gamma_1, (x : U), \Gamma_2(y)}
\end{mathpar}
Case analysis on $x = y$.
\begin{subcase}[$x = y$]
\begin{mathpar}
\inferrule
  {[p\unlhd U/x]y = p\unlhd U \\
  	[p\unlhd U/x]U = U}
  {}
\end{mathpar}
The substitutions are given above. 
Since $U$ is typed absent 
$x$, $[p\unlhd U/x]U = U$.
By assumption we have $A; \Sigma; \Gamma_1 \vdash p : S$ 
and $A; \Sigma; \Gamma_1 \vdash S <: U \dashv \Gamma_1$.
\hl{Weakening} gives us 
\begin{mathpar}
\inferrule
  {A; \Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash p : S \\
  	A; \Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash S <: U \dashv \Gamma_1, [p\unlhd U/x]\Gamma_2}
  {}
\end{mathpar}
Thus by \textsc{T-Type}, 
$\varnothing; \Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash p \unlhd U : U$.
\end{subcase}
\begin{subcase}[$x \neq y$]
\begin{mathpar}
\inferrule
  {[p\unlhd U/x]y = y}
  {}
\end{mathpar}
The substitutions are given above.Thus by \textsc{T-Var},
$A; \Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash y : \Gamma_1, [p\unlhd U/x]\Gamma_2(y)$.
\end{subcase}
\end{casethm}

\begin{casethm}[\textsc{T-Loc}]
\begin{mathpar}
\inferrule
  {	l \in dom(\Sigma)}
  {	A; \Sigma; \Gamma, (x : U) \vdash l : \Sigma(l)}
\end{mathpar}
Trivial.
\end{casethm}

\begin{casethm}[\textsc{T-New}]
\begin{mathpar}
\inferrule
  {A; \Sigma; \Gamma_1, (x : U), \Gamma_2, z : \{z \Rightarrow \overline{\sigma}\} 
  \vdash \overline{d} : \overline{\sigma}}
  {A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash \texttt{new} \; \{z \Rightarrow \overline{d}\} : 
  \{z \Rightarrow \overline{\sigma}\}}
\end{mathpar}
By our induction hypothesis we assume 
\begin{mathpar}
\inferrule
  {A; \Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2, z : \{z \Rightarrow [p\unlhd U/x] \overline{\sigma}\} 
  \vdash [p\unlhd U/x]\overline{d} : [p\unlhd U/x]\overline{\sigma}}
  {}
\end{mathpar}
Thus by \textsc{T-New} we have 
\begin{mathpar}
\inferrule
  {A; \Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash \texttt{new} \; \{z \Rightarrow [p\unlhd U/x]\overline{d}\} : 
  \{z \Rightarrow [p\unlhd U/x]\overline{\sigma}\}}
  {}
\end{mathpar}
\end{casethm}

\begin{casethm}[\textsc{T-Meth}]
\begin{mathpar}
\inferrule
  {A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash e_0 \ni \texttt{def} \; m:S \rightarrow T \\
  	A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash e_0 : T_0 \\
  	A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash e_1 : S' \\
  	A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash S' <: S \dashv \Gamma_1, (x : U), \Gamma_2 \\
  	A; \Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash T <: T' \dashv \Gamma_1, (x : U), \Gamma_2}
  {A; 	\Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash e_0.m_T'(e_1) : T'}
\end{mathpar}
By our mutual induction hypothesis we assume 
\begin{mathpar}
\inferrule
  {[p\unlhd U/x]A; \Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash [p\unlhd U/x]e_0 \ni [p\unlhd U/x](\texttt{def} \; m:S \rightarrow T) \\
  	[p\unlhd U/x]A; \Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash [p\unlhd U/x]e_0 : [p\unlhd U/x]T_0 \\
  	[p\unlhd U/x]A; \Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash [p\unlhd U/x]e_1 : [p\unlhd U/x]S' \\
  	[p\unlhd U/x]A; \Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash [p\unlhd U/x]S' <: [p\unlhd U/x]S \dashv \Gamma_1, [p\unlhd U/x]\Gamma_2 \\
  	A; \Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash [p\unlhd U/x]T <: [p\unlhd U/x]T' \dashv \Gamma_1, [p\unlhd U/x]\Gamma_2}
  {}
\end{mathpar}
It follows then by \textsc{T-Meth} that 
$[p\unlhd U/x]A; \Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash [p\unlhd U/x]e_0.m_{[p\unlhd U/x]T'}([p\unlhd U/x]e_1) : [p\unlhd U/x]T'$.
\end{casethm}

\begin{casethm}[\textsc{T-Acc}]
\begin{mathpar}
\inferrule
  {A; 	\Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash e : S \\
  	A; 	\Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash e \ni \texttt{val} \; f:T}
  {A; 	\Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash e.f : T}
\end{mathpar}
By our induction hypothesis, we assume
\begin{mathpar}
\inferrule
  {[p\unlhd U/x]A; \Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash [p\unlhd U/x]e : [p\unlhd U/x]S \\
  	[p\unlhd U/x]A; \Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash [p\unlhd U/x]e \ni [p\unlhd U/x](\texttt{val} \; f:T)}
  {}
\end{mathpar}
It then follows by \textsc{T-Acc} that
$[p\unlhd U/x]A; \Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash [p\unlhd U/x]e.f : [p\unlhd U/x]T$.
\end{casethm}

\begin{casethm}[\textsc{T-Type}]
\begin{mathpar}
\inferrule
  {A;\Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash e : S \\
   A;\Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash S <: T \dashv \Gamma_1, (x : U), \Gamma_2}
  {A;\Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash e \unlhd T : T}
\end{mathpar}
By our induction hypothesis we assume
\begin{mathpar}
\inferrule
  {[p\unlhd U/x]A;\Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash [p\unlhd U/x]e : [p\unlhd U/x]S \\
   [p\unlhd U/x]A;\Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash [p\unlhd U/x]S <: [p\unlhd U/x]T \dashv \Gamma_1, [p\unlhd U/x]\Gamma_2}
  {}
\end{mathpar}
It then follows by \textsc{T-Type} that
$[p\unlhd U/x]A;\Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash [p\unlhd U/x]e \unlhd T : [p\unlhd U/x]T$.
\end{casethm}

\begin{casethm}[\textsc{S-Assume}]
\begin{mathpar}
\inferrule
  {(S <: T) \in A}
  {A; 	\Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash S\; \texttt{<:}\; T \dashv \Gamma_1, (x : U), \Gamma_2'}
\end{mathpar}
Trivial.
\end{casethm}

\begin{casethm}[\textsc{S-Rec}]\label{case:subst:s-rec}
\begin{mathpar}
\inferrule
  {A; 	\Sigma; \Gamma_1, (x : U), \Gamma_2, z : \{z \Rightarrow \overline{\sigma}\} \vdash \overline{\sigma} <:\; \overline{\sigma}'  \dashv \Gamma_1, (x : U), \Gamma_2', z : \{z \Rightarrow \overline{\sigma}'\}}
  {A; 	\Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash \{z \Rightarrow \overline{\sigma}\}\; <:\; \{z \Rightarrow \overline{\sigma}'\}\dashv \Gamma_1, (x : U), \Gamma_2'}
\end{mathpar}
By our induction hypothesis we assume
\begin{mathpar}
\inferrule
  {[p\unlhd U/x]A; \Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2, z : [p\unlhd U/x]\{z \Rightarrow \overline{\sigma}\} \vdash [p\unlhd U/x]\overline{\sigma} <:\; [p\unlhd U/x]\overline{\sigma}'  \dashv \Gamma_1, [p\unlhd U/x]\Gamma_2', z : [p\unlhd U/x]\{z \Rightarrow \overline{\sigma}'\}}
  {}
\end{mathpar}
It then follows by \textsc{S-Rec}
\begin{mathpar}
\inferrule
  {}
  {[p\unlhd U/x]A; 	\Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash [p\unlhd U/x]\{z \Rightarrow \overline{\sigma}\}\; <:\; [p\unlhd U/x]\{z \Rightarrow \overline{\sigma}'\}\dashv \Gamma_1, [p\unlhd U/x]\Gamma_2'}
\end{mathpar}
\end{casethm}

\begin{casethm}[\textsc{S-Select-Refl}]
\begin{mdframed}[hidealllines=true,backgroundcolor=yellow]
Julian: This is the part I am most unsure of. The issue is the size of the 
sub-derivation. The premises for \textsc{S-Select-Refl} require the 
sub-derivation of a subtype relation with an expanded assumption context.
Now, my argument for this would be that neither of the base cases, 
\textsc{S-Top} and \textsc{S-Bottom} depend on the assumption context. 
The \textsc{S-Assume} base case does however, and this is where my 
brain fails me. Can we extend the induction hypothesis to premises not 
dealing with $A$, but rather the larger $A,(p'.L <: p'.L)$?

Since our induction is on the size of the judgement derivation, and not 
the size of the assumption context, I feel that this is alright.
I'm not sure if this logic holds up, or even if it does what the best way 
to express it is. This case is done assuming my logic holds.
\end{mdframed}
\begin{mathpar}
\inferrule
  {A; 	\Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash p' \ni \texttt{type} \; L : S_1 .. U_1\\
  	A; 	\Sigma; \Gamma_1, (x : U), \Gamma_2' \vdash p' \ni \texttt{type} \; L : S_2 .. U_2\\
  	A,(p'.L <: p'.L); 	\Sigma; \Gamma_1, (x : U), \Gamma_2' \vdash S_2 \; \texttt{<:}\; S_1 \dashv \Gamma_1, (x : U), \Gamma_2 \\
  	A,(p'.L <: p'.L); 	\Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash U_1 \; \texttt{<:}\; U_2 \dashv \Gamma_1, (x : U), \Gamma_2'}
  {A; 	\Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash p'.L \; \texttt{<:}\; p'.L \dashv \Gamma_1, (x : U), \Gamma_2'}
\end{mathpar}
By our induction hypothesis we assume
\begin{mathpar}
\inferrule
  {[p\unlhd U/x]A; 	\Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash p' \ni [p\unlhd U/x](\texttt{type} \; L : S_1 .. U_1)\\
  	[p\unlhd U/x]A; 	\Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2' \vdash p' \ni [p\unlhd U/x](\texttt{type} \; L : S_2 .. U_2)\\
  	[p\unlhd U/x](A,(p'.L <: p'.L)); 	\Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2' \vdash [p\unlhd U/x]S_2 \; \texttt{<:}\; [p\unlhd U/x]S_1 \dashv \Gamma_1, [p\unlhd U/x]\Gamma_2 \\
  	[p\unlhd U/x](A,(p'.L <: p'.L)); 	\Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash [p\unlhd U/x]U_1 \; \texttt{<:}\; [p\unlhd U/x]U_2 \dashv \Gamma_1, [p\unlhd U/x]\Gamma_2'}
  {}
\end{mathpar}
Since 
\begin{mathpar}
\inferrule
  {[p\unlhd U/x](A,(p'.L <: p'.L)) = [p\unlhd U/x]A,([p\unlhd U/x]p'.L <: [p\unlhd U/x]p'.L)}
  {}
\end{mathpar}
it then follows by \textsc{S-Select-Refl},
\begin{mathpar}
\inferrule
  {}
  {[p\unlhd U/x]A; 	\Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash [p\unlhd U/x]p'.L \; \texttt{<:}\; [p\unlhd U/x]p'.L \dashv \Gamma_1, [p\unlhd U/x]\Gamma_2'}
\end{mathpar}
\end{casethm}

\begin{casethm}[\textsc{S-Select-Upper}] 
\begin{mathpar}
\inferrule
  {A; 	\Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash p' \ni \texttt{type} \; L : S' .. U'\\
  	A; 	\Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash S' <: U' \dashv \Gamma_1, (x : U), \Gamma_2 \\
  	A; 	\Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash U' <: T \dashv \Gamma_1, (x : U), \Gamma_2'}
  {A; 	\Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash p'.L\; <:\; T \dashv \Gamma_1, (x : U), \Gamma_2'}
\end{mathpar}
By our induction hypothesis we assume
\begin{mathpar}
\inferrule
  {[p\unlhd U/x]A; 	\Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash [p\unlhd U/x]p' \ni [p\unlhd U/x](\texttt{type} \; L : S' .. U')\\
  	[p\unlhd U/x]A; 	\Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash [p\unlhd U/x]S' <: [p\unlhd U/x]U' \dashv \Gamma_1, [p\unlhd U/x]\Gamma_2 \\
  	[p\unlhd U/x]A; 	\Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash [p\unlhd U/x]U' <: [p\unlhd U/x]T \dashv \Gamma_1, [p\unlhd U/x]\Gamma_2'}
  {}
\end{mathpar}
It then follows by \textsc{S-Select-Upper},
\begin{mathpar}
\inferrule
  {}
  {[p\unlhd U/x]A; 	\Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash [p\unlhd U/x]p'.L\; <:\; [p\unlhd U/x]T \dashv \Gamma_1, [p\unlhd U/x]\Gamma_2'}
\end{mathpar}
\end{casethm}

\begin{casethm}[\textsc{S-Select-Lower}]
\begin{mathpar}
\inferrule
  {A; 	\Sigma; \Gamma_1, (x : U), \Gamma_2' \vdash p' \ni \texttt{type} \; L : S' .. U' \\
  	A; 	\Sigma; \Gamma_1, (x : U), \Gamma_2' \vdash S' <: U' \dashv \Gamma_1, (x : U), \Gamma_2' \\
  	A; 	\Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash S <: S' \dashv \Gamma_1, (x : U), \Gamma_2'}
  {A; 	\Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash S\; <:\; p'.L \dashv \Gamma_1, (x : U), \Gamma_2'}
\end{mathpar}
By our induction hypothesis we assume
\begin{mathpar}
\inferrule
  {[p\unlhd U/x]A; 	\Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2' \vdash [p\unlhd U/x]p' \ni [p\unlhd U/x](\texttt{type} \; L : S' .. U') \\
  	[p\unlhd U/x]A; 	\Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2' \vdash [p\unlhd U/x]S' <: [p\unlhd U/x]U' \dashv \Gamma_1, [p\unlhd U/x]\Gamma_2' \\
  	[p\unlhd U/x]A; 	\Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash [p\unlhd U/x]S <: [p\unlhd U/x]S' \dashv \Gamma_1, [p\unlhd U/x]\Gamma_2'}
  {}
\end{mathpar}
It then follows by \textsc{S-Select-Lower},
\begin{mathpar}
\inferrule
  {}
  {[p\unlhd U/x]A; 	\Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash [p\unlhd U/x]S'\; <:\; [p\unlhd U/x]p.L \dashv \Gamma_1, [p\unlhd U/x]\Gamma_2'}
\end{mathpar}
\end{casethm}

\begin{casethm}[\textsc{S-Top}]
\begin{mathpar}
\inferrule
  {}
  {A; 	\Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash T\; \texttt{<:}\; \top \dashv \Gamma_1, (x : U), \Gamma_2'}
\end{mathpar}
Trivial.
\end{casethm}

\begin{casethm}[\textsc{S-Bottom}]
\begin{mathpar}
\inferrule
  {}
  {A; 	\Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash \bot\; \texttt{<:}\; T \dashv \Gamma_1, (x : U), \Gamma_2'}
\end{mathpar}
Trivial.
\end{casethm}

\begin{casethm}[\textsc{M-Path}]
\begin{mathpar}
\inferrule
  {A; 	\Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash p' : T \\
  	A; 	\Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash T \prec_z \overline{\sigma}\\
  	\sigma_i \in \overline{\sigma}}
  {A; 	\Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash p' \ni [p'/z]\sigma_i}
\end{mathpar}
By our induction hypothesis we assume
\begin{mathpar}
\inferrule
  {[p\unlhd U/x]A; 	\Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash [p\unlhd U/x]p' : [p\unlhd U/x]T \\
  	[p\unlhd U/x]A; 	\Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash [p\unlhd U/x]T \prec_z [p\unlhd U/x]\overline{\sigma}\\
  	[p\unlhd U/x]\sigma_i \in [p\unlhd U/x]\overline{\sigma}}
  {}
\end{mathpar}
It then follows by \textsc{M-Path} that
\begin{mathpar}
\inferrule
  {}
  {[p\unlhd U/x]A; 	\Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash [p\unlhd U/x]p' \ni [[p\unlhd U/x]p'/z]([p\unlhd U/x]\sigma_i)}
\end{mathpar}
Since $[[p\unlhd U/x]p'/z]([p\unlhd U/x]\sigma_i) = [p\unlhd U/x]([p'/z]\sigma_i)$
we have the desired result. \hl{Do we? ... Substitution?}
\end{casethm}

\begin{casethm}[\textsc{M-Exp}]
\begin{mathpar}
\inferrule
  {A; 	\Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash e : T \\
  	A; 	\Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash T \prec_z \overline{\sigma}\\
  	\sigma_i \in \overline{\sigma} \\
  	z \notin \sigma_i}
  {A; 	\Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash e \ni \sigma_i}
\end{mathpar}
By our induction hypothesis we assume
\begin{mathpar}
\inferrule
  {[p\unlhd U/x]A; 	\Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash [p\unlhd U/x]e : [p\unlhd U/x]T \\
  	[p\unlhd U/x]A; 	\Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash [p\unlhd U/x]T \prec_z [p\unlhd U/x]\overline{\sigma}\\
  	[p\unlhd U/x]\sigma_i \in [p\unlhd U/x]\overline{\sigma} \\
  	z \notin [p\unlhd U/x]\sigma_i}
  {}
\end{mathpar}
It then follows by \textsc{M-Exp} that
\begin{mathpar}
\inferrule
  {}
  {[p\unlhd U/x]A; 	\Sigma; \Gamma_1, [p\unlhd U/x]\Gamma_2 \vdash [p\unlhd U/x]e \ni [p\unlhd U/x]\sigma_i}
\end{mathpar}
\hl{Work needed to show $z$ is not in $[p\unlhd U/x]$}
\end{casethm}

\begin{casethm}[E-Rec]
\begin{mathpar}
\inferrule
  {}
  {A; 	\Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash \{z \Rightarrow \overline{\sigma}\} \prec_z \overline{\sigma}}
\end{mathpar}
Trivial.
\end{casethm}

\begin{casethm}[E-Rec]
\begin{mathpar}
\inferrule
  {A; 	\Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash p \ni \texttt{type} \; L : S..U \\
  	A; 	\Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash U \prec_z \overline{\sigma}}
  {A; 	\Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash p.L \prec_z \overline{\sigma}}
\end{mathpar}
\end{casethm}

\begin{casethm}[E-Rec]
\begin{mathpar}
\inferrule
  {}
  {A; 	\Sigma; \Gamma_1, (x : U), \Gamma_2 \vdash \top \prec_z \varnothing}
\end{mathpar}
Trivial.
\end{casethm}

\end{proof}
\qed

\newpage

\begin{lemma}[Subtype Transitivity] \label{lem:subtype_trans}
If $A; \Sigma; \Gamma_1 \vdash S <: T \dashv \Gamma_2$ and 
   $A; \Sigma; \Gamma_2 \vdash T <: U \dashv \Gamma_3$ then
   $A; \Sigma; \Gamma_1 \vdash S <: U \dashv \Gamma_3$.
\end{lemma}
\begin{proof}
By induction on the derivation of $A; \Sigma; \Gamma_1 \vdash S <: T \dashv \Gamma_2$.
\begin{casethm}[\textsc{S-Assume}]
\begin{mathpar}
\inferrule
  {(S <: T) \in A}
  {A; \Sigma; \Gamma_1 \vdash S\; \texttt{<:}\; T \dashv \Gamma_2}
\end{mathpar}
\end{casethm}

\begin{casethm}[\textsc{S-Rec}]
\begin{mathpar}
\inferrule
  {S = \{z \Rightarrow \overline{\sigma}_1\} \\
  	T = \{z \Rightarrow \overline{\sigma}_2\}}
  {}
  \and
\inferrule
  {A; \Sigma; \Gamma_1, z : \{z \Rightarrow \overline{\sigma}_1\} \vdash \overline{\sigma}_1 <:\; \overline{\sigma}_2  \dashv \Gamma_2, z : \{z \Rightarrow \overline{\sigma}_2\}}
  {A; \Sigma; \Gamma_1 \vdash \{z \Rightarrow \overline{\sigma}_1\}\; <:\; \{z \Rightarrow \overline{\sigma}_2\}\dashv \Gamma_2}
\end{mathpar}
\end{casethm}

\begin{casethm}[\textsc{S-Select-Refl}]
\begin{mathpar}
\inferrule
  {S = p.L \\
  	T = p.L}
  {}
  \and
\inferrule
  {A; \Sigma; \Gamma_1 \vdash p \ni \texttt{type} \; L : S_1 .. U_1\\
  	A; \Sigma; \Gamma_2 \vdash p \ni \texttt{type} \; L : S_2 .. U_2\\
  	A, (p.L <: p.L); \Sigma; \Gamma_2 \vdash S_2 \; \texttt{<:}\; S_1 \dashv \Gamma_1 \\
  	A, (p.L <: p.L); \Sigma; \Gamma_1 \vdash U_1 \; \texttt{<:}\; U_2 \dashv \Gamma_2}
  {A; \Sigma; \Gamma_1 \vdash p.L \; \texttt{<:}\; p.L \dashv \Gamma_2}
\end{mathpar}
\end{casethm}

\begin{casethm}[\textsc{S-Select-Upper}]
\begin{mathpar}
\inferrule
  {S = p.L}
  {}
  \and
\inferrule
  {A; \Sigma; \Gamma_1 \vdash p \ni \texttt{type} \; L : S_1 .. U_1\\
  	A; \Sigma; \Gamma_1 \vdash S_1 <: U_1 \dashv \Gamma_1 \\
  	A; \Sigma; \Gamma_1 \vdash U_1 <: T \dashv \Gamma_2}
  {A; \Sigma; \Gamma_1 \vdash p.L\; <:\; T \dashv \Gamma_2}
\end{mathpar}
Since $A; \Sigma; \Gamma_2 \vdash T <: U \dashv \Gamma_3$, 
by our inductive hypothesis, we assume that 
\begin{mathpar}
\inferrule
  {A; \Sigma; \Gamma_1 \vdash U_1 <: U \dashv \Gamma_2 }
  {}
\end{mathpar}
Thus, by \textsc{S-Select-Upper} it folows that 
$A; \Sigma; \Gamma_2 \vdash p.L <: U \dashv \Gamma_3$.
\end{casethm}

\begin{casethm}[\textsc{S-Select-Lower}]
\begin{mathpar}
\inferrule
  {T = p.L}
  {}
  \and
\inferrule
  {A; \Sigma; \Gamma_2 \vdash p \ni \texttt{type} \; L : S_2 .. U_2 \\
  	A; \Sigma; \Gamma_2 \vdash S_2 <: U_2 \dashv \Gamma_2 \\
  	A; \Sigma; \Gamma_1 \vdash S <: S_2 \dashv \Gamma_2}
  {A; \Sigma; \Gamma_1 \vdash S\; <:\; p.L \dashv \Gamma_2}
\end{mathpar}
By our inductive hypothesis, we assume
\begin{mathpar}
\inferrule
  {A; \Sigma; \Gamma_1 \vdash S_2 <: U \dashv \Gamma_2 }
  {}
\end{mathpar}
By case analysis on the the derivation of 
$A; \Sigma; \Gamma_2 \vdash p.L <: U \dashv \Gamma_3$.
\begin{subcase}[\textsc{S-Select-Refl}]
\begin{mathpar}
\inferrule
  {U = p.L}
  {}
  \and
\inferrule
  {A; \Sigma; \Gamma_2 \vdash p \ni \texttt{type} \; L : S_2 .. U_2\\
  	A; \Sigma; \Gamma_3 \vdash p \ni \texttt{type} \; L : S_3 .. U_3\\
  	A, (p.L <: p.L); \Sigma; \Gamma_3 \vdash S_3 \; \texttt{<:}\; S_2 \dashv \Gamma_2 \\
  	A, (p.L <: p.L); \Sigma; \Gamma_2 \vdash U_2 \; \texttt{<:}\; U_3 \dashv \Gamma_3}
  {A; \Sigma; \Gamma_1 \vdash p.L \; \texttt{<:}\; p.L \dashv \Gamma_3}
\end{mathpar}
\end{subcase}
\begin{subcase}[\textsc{S-Select-Upper}]
\begin{mathpar}
\inferrule
  {A; \Sigma; \Gamma_2 \vdash p \ni \texttt{type} \; L : S_2 .. U_2\\
  	A; \Sigma; \Gamma_2 \vdash S_2 <: U_2 \dashv \Gamma_1 \\
  	A; \Sigma; \Gamma_2 \vdash U_2 <: T \dashv \Gamma_3}
  {A; \Sigma; \Gamma_2 \vdash p.L\; <:\; T \dashv \Gamma_3}
\end{mathpar}
\end{subcase}
\begin{subcase}[\textsc{S-Select-Lower}]
\end{subcase}
\begin{subcase}[\textsc{S-Top}]
Trivial.
\end{subcase}
\end{casethm}

\begin{casethm}[\textsc{S-Top}]
\begin{mathpar}
\inferrule
  {T = \top}
  {}
  \and
\inferrule
  {}
  {A; \Sigma; \Gamma_1 \vdash S\; \texttt{<:}\; \top \dashv \Gamma_2}
\end{mathpar}
Since $T = \top$, by case analysis on the derivation of 
$A; \Sigma; \Gamma_2 \vdash \top <: U \dashv \Gamma_3$,
we can see that $U = \top$. Thus by \textsc{S-Top} it follows that
$A; \Sigma; \Gamma_1 \vdash S <: U \dashv \Gamma_3$.
\end{casethm}

\begin{casethm}[\textsc{S-Bottom}]
\begin{mathpar}
\inferrule
  {S = \bot}
  {}
  \and
\inferrule
  {}
  {A; \Sigma; \Gamma_1 \vdash \bot\; \texttt{<:}\; T \dashv \Gamma_2}
\end{mathpar}
\end{casethm}
Trivial.
\end{proof}
\qed

\newpage

\begin{lemma}[Leadsto type Preservation] \label{lem:path_type_preservation}
If $\varnothing; \Sigma; \Gamma \vdash v : T$, 
$\Sigma \vdash  \mu$ and $\mu \vdash v \leadsto l$ then 
$\varnothing; \Sigma; \Gamma \vdash l : S$ where
$\varnothing; \Sigma; \Gamma \vdash S <: T \dashv \Gamma$.
\end{lemma}
\begin{proof}
By induction on the derivation of $\mu \vdash v \leadsto l$.
\begin{casethm}[\textsc{L-Loc}]
\begin{mathpar}
\inferrule
  {v = l}
  {}
  \and
\inferrule
  {}
  {\mu \vdash l \leadsto l}
\end{mathpar}
Trivial.
\end{casethm}
\begin{casethm}[\textsc{L-Type}]
\begin{mathpar}
  {v = v' \unlhd T}
  {}
  \and
\inferrule
  {\mu \vdash v' \leadsto l}
  {\mu \vdash v' \unlhd T \leadsto l}
\end{mathpar}
Since we know that $\varnothing; \Sigma; \Gamma \vdash v' \unlhd T: T$, 
by \textsc{T-Type} we can infer $\varnothing; \Sigma; \Gamma \vdash v' : S'$ 
and $\varnothing; \Sigma; \Gamma \vdash S' <: T \dashv \Gamma$.
By our induction hypothesis, we assume that if 
$\varnothing; \Sigma; \Gamma \vdash v' : S'$ then 
$\varnothing; \Sigma; \Gamma \vdash l : S$, where 
$\varnothing; \Sigma; \Gamma \vdash S <: S' \dashv \Gamma$.
By \hl{Subtype Transitivity} we have 
$\varnothing; \Sigma; \Gamma \vdash S <: T \dashv \Gamma$.
\end{casethm}
\begin{casethm}[\textsc{L-Path}]
\begin{mathpar}
\inferrule
  {\mu \vdash v' \leadsto l' \\
	\mu(l') = \{z \Rightarrow ..., \texttt{val} f : T' = l, ...\}}
  {\mu \vdash v'.f \leadsto l}
\end{mathpar}
By inversion on the derivation of $\Gamma; \Sigma \vdash v'.f : T$ we 
have 
\begin{mathpar}
\inferrule
  {	\varnothing; \Sigma; \Gamma \vdash v' : S' \\
  	\varnothing; \Sigma; \Gamma \vdash v' \ni \texttt{val} \; f:T}
  {	\varnothing; \Sigma; \Gamma \vdash v'.f : T}
\end{mathpar}
By assumption $\Sigma \vdash \mu$, which implies $\varnothing; \Sigma; \varnothing 
\vdash l : S$, where 
$\varnothing; \Sigma; \varnothing \vdash S <: T \dashv \varnothing$. 
Environment weakening gives us 
$\varnothing; \Sigma; \Gamma \vdash l : T$
and $\varnothing; \Sigma; \Gamma \vdash S <: S' \dashv \Gamma$
\hl{TODO: expansion preservation}
\end{casethm}
\end{proof}
\qed

\newpage

\begin{theorem}[Preservation]
If $\varnothing; \Sigma; \Gamma \vdash e : T$, 
   	$\mu \; | \; e \; \rightarrow \mu' \; | \; e'$ where
	$\Sigma \vdash \mu \; \tt{\bf{wf}}$ then 
 	$\exists \Sigma'$ s.t. 
	$\Sigma'$ extends $\Sigma$, 
	$\Sigma' \vdash \mu' \; \tt{\bf{wf}}$, 
	$\varnothing; \Sigma'; \Gamma \vdash e' : T$.
\end{theorem}
\begin{proof}
By structural induction on 
$\mu \; | \; e \; \rightarrow \mu' \; | \; e'$.
\begin{casethm}[\textsc{R-New}]
\begin{mathpar}
\inferrule
  {\mu \vdash \overline{d_v} \leadsto \overline{d} \\
  	l \notin dom(\mu) \\
  	\mu' = \mu, l \mapsto \{\texttt{z} \Rightarrow \overline{d}\}}
  {\mu \; | \; \texttt{new} \; \{\texttt{z} \Rightarrow \overline{d_v}\} \; \rightarrow \mu' \; | \; l}
\end{mathpar}
Trivial.
\end{casethm}

\begin{casethm}[\textsc{R-Meth}]
\begin{mathpar}
\inferrule
  {\mu \vdash v_1 \leadsto l \\
  	\mu(l) = \{\texttt{z} \Rightarrow ...,m:T(x:S)=e,...\}}
  {\mu \; | \; v_1.m_U(v_2) \;\rightarrow \mu \; | \; [l/\texttt{z},v_2 \unlhd S/x]e \unlhd U}
\end{mathpar}
Trivial.
\end{casethm}

\begin{casethm}[\textsc{R-Context}]
\begin{mathpar}
\inferrule
  {	\mu \; | \; e \; \rightarrow \; \mu' \; | \; e'}
  {\mu \; | \; E[e] \; \rightarrow \mu' \; | \; E[e']}
\end{mathpar}
\end{casethm}

\end{proof}
\qed

\newpage

\section{Abstract}





\bibliographystyle{plain}
\bibliography{bib}

\end{document}